<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAPIDO Handyman Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <!-- jsPDF for Invoice Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* Apply Kanit font globally */
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap');
        
        * {
            font-family: 'Kanit', sans-serif !important;
        }
        
        body {
            font-family: 'Kanit', sans-serif !important;
        }
        
        /* Force Kanit on header specifically */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Kanit', sans-serif !important;
        }
        
        /* Remove number input arrows */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Make calendar popups 2x larger */
        input[type="date"]::-webkit-calendar-picker-indicator {
            font-size: 2em;
            cursor: pointer;
        }
        
        /* Chrome/Edge calendar popup styling */
        input[type="date"]::-webkit-datetime-edit {
            padding: 0.5em;
        }
        
        /* Make the calendar dropdown itself larger in supported browsers */
        @media screen and (-webkit-min-device-pixel-ratio:0) {
            input[type="date"] {
                min-height: 2.5em;
            }
        }
        
        /* Ensure editable text inherits color from row */
        tbody tr td > div {
            color: inherit;
        }
        
        /* Visible styling for editable text fields */
        tbody tr td > div[contenteditable="true"] {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            min-height: 32px;
            cursor: text;
        }
        
        tbody tr td > div[contenteditable="true"]:hover {
            border: 1px solid rgba(59, 130, 246, 0.3);
            background-color: rgba(59, 130, 246, 0.05);
        }
        
        tbody tr td > div[contenteditable="true"]:focus {
            outline: none;
            border: 1px solid rgba(59, 130, 246, 0.6);
            background-color: rgba(59, 130, 246, 0.1);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Dark mode editable fields */
        .dark-mode tbody tr td > div[contenteditable="true"]:hover {
            border: 1px solid rgba(100, 149, 237, 0.4);
            background-color: rgba(100, 149, 237, 0.1);
        }
        
        .dark-mode tbody tr td > div[contenteditable="true"]:focus {
            border: 1px solid rgba(100, 149, 237, 0.7);
            background-color: rgba(100, 149, 237, 0.15);
            box-shadow: 0 0 0 3px rgba(100, 149, 237, 0.15);
        }
        
        /* Fix icon cutoff in Actions column - only add vertical padding */
        tbody tr td {
            vertical-align: middle;
        }
        
        /* Ensure action buttons container has proper spacing */
        tbody tr td > div.flex {
            gap: 8px;
            padding: 4px 0;
        }
        
        /* Ensure icons are properly contained and have space */
        tbody tr td button,
        tbody tr td a {
            padding: 8px;
        }
        
        tbody tr td button svg,
        tbody tr td a svg {
            display: block;
            flex-shrink: 0;
        }
        
        /* Add spacing to checkboxes from left edge */
        tbody tr td input[type="checkbox"],
        thead tr th input[type="checkbox"] {
            margin-left: 12px;
        }
        
        /* Row drag styling */
        tbody tr[draggable="true"] {
            cursor: move;
        }
        
        tbody tr[draggable="true"]:active {
            opacity: 0.5;
            cursor: grabbing;
        }
        
        /* Real-time sync indicator */
        .sync-indicator {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Lucide Icons (inline SVG components)
        const CheckCircle = ({ size = 20, className, style }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}>
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
        );
        
        const Clock = ({ size = 20, className, style }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}>
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
            </svg>
        );
        
        const AlertCircle = ({ size = 20, className, style }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}>
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
        );
        
        const Plus = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
        );
        
        const Trash2 = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
            </svg>
        );
        
        const FileText = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <polyline points="10 9 9 9 8 9"/>
            </svg>
        );
        
        const Moon = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
        );
        
        const Sun = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="5"/>
                <line x1="12" y1="1" x2="12" y2="3"/>
                <line x1="12" y1="21" x2="12" y2="23"/>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                <line x1="1" y1="12" x2="3" y2="12"/>
                <line x1="21" y1="12" x2="23" y2="12"/>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
            </svg>
        );
        
        const Eye = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
            </svg>
        );
        
        const Wifi = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M5 12.55a11 11 0 0 1 14.08 0"/>
                <path d="M1.42 9a16 16 0 0 1 21.16 0"/>
                <path d="M8.53 16.11a6 6 0 0 1 6.95 0"/>
                <line x1="12" y1="20" x2="12.01" y2="20"/>
            </svg>
        );

        // Color themes
        const themes = {
            blue: {
                primary: '#3b82f6',
                secondary: '#60a5fa',
                success: '#10b981',
                warning: '#f59e0b',
                danger: '#ef4444',
                background: '#f8fafc',
                cardBg: '#ffffff',
                textPrimary: '#1e293b',
                textSecondary: '#64748b',
                border: '#e2e8f0',
                headerBg: '#1e40af'
            },
            purple: {
                primary: '#9333ea',
                secondary: '#a855f7',
                success: '#10b981',
                warning: '#f59e0b',
                danger: '#ef4444',
                background: '#faf5ff',
                cardBg: '#ffffff',
                textPrimary: '#4c1d95',
                textSecondary: '#7c3aed',
                border: '#e9d5ff',
                headerBg: '#6b21a8'
            },
            green: {
                primary: '#10b981',
                secondary: '#34d399',
                success: '#059669',
                warning: '#f59e0b',
                danger: '#ef4444',
                background: '#f0fdf4',
                cardBg: '#ffffff',
                textPrimary: '#064e3b',
                textSecondary: '#047857',
                border: '#d1fae5',
                headerBg: '#059669'
            },
            orange: {
                primary: '#f97316',
                secondary: '#fb923c',
                success: '#10b981',
                warning: '#eab308',
                danger: '#ef4444',
                background: '#fff7ed',
                cardBg: '#ffffff',
                textPrimary: '#7c2d12',
                textSecondary: '#c2410c',
                border: '#fed7aa',
                headerBg: '#c2410c'
            },
            dark: {
                primary: '#6366f1',
                secondary: '#818cf8',
                success: '#10b981',
                warning: '#f59e0b',
                danger: '#ef4444',
                background: '#0f172a',
                cardBg: '#1e293b',
                textPrimary: '#f1f5f9',
                textSecondary: '#94a3b8',
                border: '#334155',
                headerBg: '#4338ca'
            }
        };

        function App() {
            const [jobs, setJobs] = useState([]);
            const [selectedJobs, setSelectedJobs] = useState([]);
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [theme, setTheme] = useState('blue');
            const [showMetrics, setShowMetrics] = useState(null);
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [user, setUser] = useState(null);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            
            // Real-time sync status
            const [syncStatus, setSyncStatus] = useState('disconnected'); // 'connected', 'syncing', 'disconnected'
            const dbRef = useRef(null);
            const listenersRef = useRef([]);

            const currentTheme = isDarkMode ? themes.dark : themes[theme];

            // Initialize Firebase
            useEffect(() => {
                const firebaseConfig = {
                    apiKey: "AIzaSyCWA9f7ifPmQtVlVqPo4KL30nXqvfx0L4Y",
                    authDomain: "rapidodata.firebaseapp.com",
                    databaseURL: "https://rapidodata-default-rtdb.firebaseio.com",
                    projectId: "rapidodata",
                    storageBucket: "rapidodata.firebasestorage.app",
                    messagingSenderId: "313516582597",
                    appId: "1:313516582597:web:1bcb8d70fb8ea0a2ea9c37"
                };

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }

                // Check auth state
                firebase.auth().onAuthStateChanged((currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                        setIsLoggedIn(true);
                        setError('');
                    } else {
                        setUser(null);
                        setIsLoggedIn(false);
                    }
                });
            }, []);

            // ====== REAL-TIME LISTENERS ======
            // This section sets up Firebase listeners that automatically update when data changes
            useEffect(() => {
                if (!isLoggedIn || !user) return;

                console.log('🔄 Setting up real-time listeners...');
                setSyncStatus('connected');

                // Get reference to the jobs database
                dbRef.current = firebase.database().ref('jobs');

                // Listen for new jobs being added
                const onChildAdded = dbRef.current.on('child_added', (snapshot) => {
                    const newJob = snapshot.val();
                    newJob.id = snapshot.key;
                    
                    console.log('➕ New job detected:', newJob);
                    setSyncStatus('syncing');
                    
                    setJobs(prevJobs => {
                        // Check if job already exists
                        const exists = prevJobs.some(job => job.id === newJob.id);
                        if (exists) return prevJobs;
                        
                        // Add new job and sort by order
                        const updated = [...prevJobs, newJob].sort((a, b) => (a.order || 0) - (b.order || 0));
                        setTimeout(() => setSyncStatus('connected'), 500);
                        return updated;
                    });
                });

                // Listen for jobs being updated
                const onChildChanged = dbRef.current.on('child_changed', (snapshot) => {
                    const updatedJob = snapshot.val();
                    updatedJob.id = snapshot.key;
                    
                    console.log('✏️ Job updated:', updatedJob);
                    setSyncStatus('syncing');
                    
                    setJobs(prevJobs => {
                        const updated = prevJobs.map(job => 
                            job.id === updatedJob.id ? updatedJob : job
                        ).sort((a, b) => (a.order || 0) - (b.order || 0));
                        
                        setTimeout(() => setSyncStatus('connected'), 500);
                        return updated;
                    });
                });

                // Listen for jobs being deleted
                const onChildRemoved = dbRef.current.on('child_removed', (snapshot) => {
                    const deletedJobId = snapshot.key;
                    
                    console.log('🗑️ Job deleted:', deletedJobId);
                    setSyncStatus('syncing');
                    
                    setJobs(prevJobs => {
                        const updated = prevJobs.filter(job => job.id !== deletedJobId);
                        setTimeout(() => setSyncStatus('connected'), 500);
                        return updated;
                    });
                });

                // Store listeners for cleanup
                listenersRef.current = [
                    { ref: dbRef.current, event: 'child_added', callback: onChildAdded },
                    { ref: dbRef.current, event: 'child_changed', callback: onChildChanged },
                    { ref: dbRef.current, event: 'child_removed', callback: onChildRemoved }
                ];

                // Load initial data
                loadJobs();

                // Cleanup function - removes all listeners when component unmounts
                return () => {
                    console.log('🔌 Disconnecting real-time listeners...');
                    listenersRef.current.forEach(({ ref, event, callback }) => {
                        ref.off(event, callback);
                    });
                    listenersRef.current = [];
                    setSyncStatus('disconnected');
                };
            }, [isLoggedIn, user]);

            // Load all jobs from Firebase
            const loadJobs = async () => {
                try {
                    const snapshot = await firebase.database().ref('jobs').once('value');
                    const data = snapshot.val();
                    
                    if (data) {
                        const jobsArray = Object.keys(data).map(key => ({
                            id: key,
                            ...data[key]
                        })).sort((a, b) => (a.order || 0) - (b.order || 0));
                        
                        setJobs(jobsArray);
                        console.log('✅ Initial jobs loaded:', jobsArray.length);
                    }
                } catch (error) {
                    console.error('❌ Error loading jobs:', error);
                    setError('Failed to load jobs');
                }
            };

            // Login function
            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                
                try {
                    await firebase.auth().signInWithEmailAndPassword(email, password);
                } catch (error) {
                    setError(error.message);
                }
            };

            // Logout function
            const handleLogout = async () => {
                try {
                    await firebase.auth().signOut();
                    setJobs([]);
                    setSelectedJobs([]);
                } catch (error) {
                    setError(error.message);
                }
            };

            // Add new job
            const addJob = async () => {
                const newJob = {
                    customer: 'New Customer',
                    requestDate: new Date().toISOString().split('T')[0],
                    completionDate: '',
                    description: 'Job Description',
                    totalPrice: '0',
                    materialCost: '0',
                    workHours: '0',
                    status: 'Pending',
                    notes: '',
                    order: jobs.length
                };
                
                try {
                    await firebase.database().ref('jobs').push(newJob);
                    // The listener will automatically add it to the state
                } catch (error) {
                    console.error('Error adding job:', error);
                    setError('Failed to add job');
                }
            };

            // Update job field
            const updateJobField = async (jobId, field, value) => {
                try {
                    await firebase.database().ref(`jobs/${jobId}`).update({
                        [field]: value
                    });
                    // The listener will automatically update the state
                } catch (error) {
                    console.error('Error updating job:', error);
                }
            };

            // Delete selected jobs
            const deleteSelectedJobs = async () => {
                if (selectedJobs.length === 0) return;
                
                if (!confirm(`Delete ${selectedJobs.length} selected job(s)?`)) return;
                
                try {
                    const updates = {};
                    selectedJobs.forEach(jobId => {
                        updates[`jobs/${jobId}`] = null;
                    });
                    
                    await firebase.database().ref().update(updates);
                    setSelectedJobs([]);
                    // The listener will automatically update the state
                } catch (error) {
                    console.error('Error deleting jobs:', error);
                    setError('Failed to delete jobs');
                }
            };

            // Toggle job selection
            const toggleJobSelection = (jobId) => {
                setSelectedJobs(prev => 
                    prev.includes(jobId) 
                        ? prev.filter(id => id !== jobId)
                        : [...prev, jobId]
                );
            };

            // Select all jobs
            const toggleSelectAll = () => {
                if (selectedJobs.length === jobs.length) {
                    setSelectedJobs([]);
                } else {
                    setSelectedJobs(jobs.map(job => job.id));
                }
            };

            // Generate Invoice
            const generateInvoice = (job) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Header
                doc.setFontSize(24);
                doc.setTextColor(59, 130, 246);
                doc.text('RAPIDO Handyman', 20, 20);
                
                doc.setFontSize(18);
                doc.setTextColor(0, 0, 0);
                doc.text('INVOICE', 20, 35);
                
                // Customer Info
                doc.setFontSize(12);
                doc.text(`Customer: ${job.customer}`, 20, 50);
                doc.text(`Date: ${job.requestDate || 'N/A'}`, 20, 58);
                
                // Job Details
                doc.setFontSize(14);
                doc.text('Job Details', 20, 75);
                doc.setFontSize(11);
                doc.text(`Description: ${job.description}`, 20, 85);
                doc.text(`Status: ${job.status}`, 20, 93);
                doc.text(`Completion Date: ${job.completionDate || 'Not completed'}`, 20, 101);
                doc.text(`Work Hours: ${job.workHours} hours`, 20, 109);
                
                // Financial Breakdown
                doc.setFontSize(14);
                doc.text('Financial Breakdown', 20, 125);
                
                doc.setFontSize(11);
                const totalPrice = parseFloat(job.totalPrice) || 0;
                const materialCost = parseFloat(job.materialCost) || 0;
                const laborProfit = totalPrice - materialCost;
                
                doc.text(`Total Price: $${totalPrice.toFixed(2)}`, 20, 138);
                doc.text(`Material Cost: $${materialCost.toFixed(2)}`, 20, 146);
                doc.text(`Labor Profit: $${laborProfit.toFixed(2)}`, 20, 154);
                
                // Notes
                if (job.notes) {
                    doc.setFontSize(14);
                    doc.text('Notes', 20, 170);
                    doc.setFontSize(10);
                    const splitNotes = doc.splitTextToSize(job.notes, 170);
                    doc.text(splitNotes, 20, 180);
                }
                
                // Save PDF
                doc.save(`Invoice_${job.customer}_${job.requestDate}.pdf`);
            };

            // Drag and drop handlers
            const [draggedJob, setDraggedJob] = useState(null);

            const handleDragStart = (e, job) => {
                setDraggedJob(job);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleDrop = async (e, targetJob) => {
                e.preventDefault();
                
                if (!draggedJob || draggedJob.id === targetJob.id) {
                    setDraggedJob(null);
                    return;
                }
                
                const draggedIndex = jobs.findIndex(j => j.id === draggedJob.id);
                const targetIndex = jobs.findIndex(j => j.id === targetJob.id);
                
                const newJobs = [...jobs];
                newJobs.splice(draggedIndex, 1);
                newJobs.splice(targetIndex, 0, draggedJob);
                
                // Update order for all jobs
                const updates = {};
                newJobs.forEach((job, index) => {
                    updates[`jobs/${job.id}/order`] = index;
                });
                
                try {
                    await firebase.database().ref().update(updates);
                    setDraggedJob(null);
                    // The listener will automatically update the state
                } catch (error) {
                    console.error('Error reordering jobs:', error);
                }
            };

            // Login Screen
            if (!isLoggedIn) {
                return (
                    <div className="min-h-screen flex items-center justify-center" style={{ background: `linear-gradient(135deg, ${currentTheme.primary} 0%, ${currentTheme.secondary} 100%)` }}>
                        <div className="p-8 rounded-2xl shadow-2xl max-w-md w-full" style={{ backgroundColor: currentTheme.cardBg }}>
                            <div className="text-center mb-8">
                                <h1 className="text-4xl font-bold mb-2" style={{ color: currentTheme.primary }}>
                                    RAPIDO Dashboard
                                </h1>
                                <p style={{ color: currentTheme.textSecondary }}>
                                    Handyman Management System
                                </p>
                            </div>
                            
                            <form onSubmit={handleLogin} className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium mb-2" style={{ color: currentTheme.textPrimary }}>
                                        Email
                                    </label>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        className="w-full px-4 py-3 rounded-lg border-2 focus:outline-none transition-all"
                                        style={{
                                            borderColor: currentTheme.border,
                                            backgroundColor: currentTheme.background
                                        }}
                                        placeholder="your@email.com"
                                        required
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium mb-2" style={{ color: currentTheme.textPrimary }}>
                                        Password
                                    </label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full px-4 py-3 rounded-lg border-2 focus:outline-none transition-all"
                                        style={{
                                            borderColor: currentTheme.border,
                                            backgroundColor: currentTheme.background
                                        }}
                                        placeholder="••••••••"
                                        required
                                    />
                                </div>
                                
                                {error && (
                                    <div className="p-3 rounded-lg text-sm" style={{ backgroundColor: '#fee2e2', color: '#991b1b' }}>
                                        {error}
                                    </div>
                                )}
                                
                                <button
                                    type="submit"
                                    className="w-full py-3 rounded-lg text-white font-semibold transition-all hover:scale-105 shadow-lg"
                                    style={{ background: `linear-gradient(135deg, ${currentTheme.primary} 0%, ${currentTheme.secondary} 100%)` }}
                                >
                                    Login
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            // Get status icon
            const getStatusIcon = (status) => {
                switch(status) {
                    case 'Completed':
                        return <CheckCircle size={20} className="text-green-500" />;
                    case 'In Progress':
                        return <Clock size={20} className="text-blue-500" />;
                    case 'Pending':
                        return <AlertCircle size={20} className="text-yellow-500" />;
                    default:
                        return <AlertCircle size={20} className="text-gray-500" />;
                }
            };

            // Calculate totals
            const totalRevenue = jobs.reduce((sum, job) => sum + (parseFloat(job.totalPrice) || 0), 0);
            const totalMaterialCost = jobs.reduce((sum, job) => sum + (parseFloat(job.materialCost) || 0), 0);
            const totalProfit = totalRevenue - totalMaterialCost;
            const totalWorkHours = jobs.reduce((sum, job) => sum + (parseFloat(job.workHours) || 0), 0);

            return (
                <div className={`min-h-screen ${isDarkMode ? 'dark-mode' : ''}`} style={{ backgroundColor: currentTheme.background }}>
                    {/* Header */}
                    <div className="shadow-lg" style={{ background: `linear-gradient(135deg, ${currentTheme.primary} 0%, ${currentTheme.secondary} 100%)` }}>
                        <div className="max-w-7xl mx-auto px-6 py-6">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h1 className="text-4xl font-bold text-white mb-2">
                                        RAPIDO Dashboard
                                    </h1>
                                    <p className="text-white opacity-90">
                                        Handyman Management System - {user?.email}
                                    </p>
                                </div>
                                
                                <div className="flex items-center gap-4">
                                    {/* Real-time sync indicator */}
                                    <div className="flex items-center gap-2 px-4 py-2 rounded-lg bg-white bg-opacity-20">
                                        <Wifi 
                                            size={18} 
                                            className={syncStatus === 'syncing' ? 'sync-indicator' : ''}
                                            style={{ color: 'white' }}
                                        />
                                        <span className="text-white text-sm font-medium">
                                            {syncStatus === 'connected' ? 'Live' : 
                                             syncStatus === 'syncing' ? 'Syncing...' : 
                                             'Offline'}
                                        </span>
                                    </div>
                                    
                                    {/* Theme selector */}
                                    <select
                                        value={theme}
                                        onChange={(e) => setTheme(e.target.value)}
                                        className="px-4 py-2 rounded-lg font-medium border-2 border-white border-opacity-30 bg-white bg-opacity-20 text-white cursor-pointer"
                                        disabled={isDarkMode}
                                    >
                                        <option value="blue">Blue</option>
                                        <option value="purple">Purple</option>
                                        <option value="green">Green</option>
                                        <option value="orange">Orange</option>
                                    </select>
                                    
                                    {/* Dark mode toggle */}
                                    <button
                                        onClick={() => setIsDarkMode(!isDarkMode)}
                                        className="p-3 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition-all"
                                    >
                                        {isDarkMode ? <Sun size={20} style={{ color: 'white' }} /> : <Moon size={20} style={{ color: 'white' }} />}
                                    </button>
                                    
                                    {/* Logout button */}
                                    <button
                                        onClick={handleLogout}
                                        className="px-6 py-2 rounded-lg font-medium bg-white bg-opacity-20 hover:bg-opacity-30 text-white transition-all"
                                    >
                                        Logout
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Stats Cards */}
                    <div className="max-w-7xl mx-auto px-6 py-8">
                        <div className="grid grid-cols-4 gap-6 mb-8">
                            <div className="p-6 rounded-xl shadow-lg" style={{ backgroundColor: currentTheme.cardBg, borderLeft: `4px solid ${currentTheme.primary}` }}>
                                <div className="text-sm font-medium mb-2" style={{ color: currentTheme.textSecondary }}>Total Jobs</div>
                                <div className="text-3xl font-bold" style={{ color: currentTheme.primary }}>{jobs.length}</div>
                            </div>
                            
                            <div className="p-6 rounded-xl shadow-lg" style={{ backgroundColor: currentTheme.cardBg, borderLeft: `4px solid ${currentTheme.success}` }}>
                                <div className="text-sm font-medium mb-2" style={{ color: currentTheme.textSecondary }}>Total Revenue</div>
                                <div className="text-3xl font-bold" style={{ color: currentTheme.success }}>${totalRevenue.toFixed(2)}</div>
                            </div>
                            
                            <div className="p-6 rounded-xl shadow-lg" style={{ backgroundColor: currentTheme.cardBg, borderLeft: `4px solid ${currentTheme.warning}` }}>
                                <div className="text-sm font-medium mb-2" style={{ color: currentTheme.textSecondary }}>Material Costs</div>
                                <div className="text-3xl font-bold" style={{ color: currentTheme.warning }}>${totalMaterialCost.toFixed(2)}</div>
                            </div>
                            
                            <div className="p-6 rounded-xl shadow-lg" style={{ backgroundColor: currentTheme.cardBg, borderLeft: `4px solid ${currentTheme.secondary}` }}>
                                <div className="text-sm font-medium mb-2" style={{ color: currentTheme.textSecondary }}>Total Profit</div>
                                <div className="text-3xl font-bold" style={{ color: currentTheme.secondary }}>${totalProfit.toFixed(2)}</div>
                            </div>
                        </div>

                        {/* Action Buttons */}
                        <div className="flex gap-4 mb-6">
                            <button
                                onClick={addJob}
                                className="px-6 py-3 text-white rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 hover:scale-105"
                                style={{ background: `linear-gradient(135deg, ${currentTheme.primary} 0%, ${currentTheme.secondary} 100%)` }}
                            >
                                <Plus size={20} />
                                Add Job
                            </button>
                            
                            {selectedJobs.length > 0 && (
                                <button
                                    onClick={deleteSelectedJobs}
                                    className="px-6 py-3 bg-red-500 text-white rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 hover:scale-105"
                                >
                                    <Trash2 size={20} />
                                    Delete Selected ({selectedJobs.length})
                                </button>
                            )}
                        </div>

                        {/* Jobs Table */}
                        <div className="rounded-xl shadow-xl overflow-hidden" style={{ backgroundColor: currentTheme.cardBg }}>
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead>
                                        <tr style={{ backgroundColor: currentTheme.headerBg }}>
                                            <th className="px-6 py-4 text-left">
                                                <input
                                                    type="checkbox"
                                                    checked={selectedJobs.length === jobs.length && jobs.length > 0}
                                                    onChange={toggleSelectAll}
                                                    className="w-5 h-5 cursor-pointer"
                                                />
                                            </th>
                                            <th className="px-6 py-4 text-left text-white font-semibold">Status</th>
                                            <th className="px-6 py-4 text-left text-white font-semibold">Customer</th>
                                            <th className="px-6 py-4 text-left text-white font-semibold">Request Date</th>
                                            <th className="px-6 py-4 text-left text-white font-semibold">Completion Date</th>
                                            <th className="px-6 py-4 text-left text-white font-semibold">Description</th>
                                            <th className="px-6 py-4 text-left text-white font-semibold">Total Price</th>
                                            <th className="px-6 py-4 text-left text-white font-semibold">Material Cost</th>
                                            <th className="px-6 py-4 text-left text-white font-semibold">Work Hours</th>
                                            <th className="px-6 py-4 text-left text-white font-semibold">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {jobs.map((job, index) => (
                                            <tr
                                                key={job.id}
                                                draggable
                                                onDragStart={(e) => handleDragStart(e, job)}
                                                onDragOver={handleDragOver}
                                                onDrop={(e) => handleDrop(e, job)}
                                                className={`border-b transition-colors ${selectedJobs.includes(job.id) ? 'bg-blue-50' : ''}`}
                                                style={{
                                                    borderColor: currentTheme.border,
                                                    backgroundColor: selectedJobs.includes(job.id) ? (isDarkMode ? '#1e3a5f' : '#eff6ff') : 'transparent'
                                                }}
                                            >
                                                <td className="px-6 py-4">
                                                    <input
                                                        type="checkbox"
                                                        checked={selectedJobs.includes(job.id)}
                                                        onChange={() => toggleJobSelection(job.id)}
                                                        className="w-5 h-5 cursor-pointer"
                                                    />
                                                </td>
                                                <td className="px-6 py-4">
                                                    <select
                                                        value={job.status}
                                                        onChange={(e) => updateJobField(job.id, 'status', e.target.value)}
                                                        className="px-3 py-2 rounded-lg border-2 font-medium cursor-pointer"
                                                        style={{
                                                            borderColor: currentTheme.border,
                                                            backgroundColor: currentTheme.background,
                                                            color: currentTheme.textPrimary
                                                        }}
                                                    >
                                                        <option value="Pending">Pending</option>
                                                        <option value="In Progress">In Progress</option>
                                                        <option value="Completed">Completed</option>
                                                    </select>
                                                </td>
                                                <td className="px-6 py-4">
                                                    <div
                                                        contentEditable
                                                        suppressContentEditableWarning
                                                        onBlur={(e) => updateJobField(job.id, 'customer', e.target.textContent)}
                                                        style={{ color: currentTheme.textPrimary }}
                                                    >
                                                        {job.customer}
                                                    </div>
                                                </td>
                                                <td className="px-6 py-4">
                                                    <input
                                                        type="date"
                                                        value={job.requestDate}
                                                        onChange={(e) => updateJobField(job.id, 'requestDate', e.target.value)}
                                                        className="px-3 py-2 rounded-lg border-2 cursor-pointer"
                                                        style={{
                                                            borderColor: currentTheme.border,
                                                            backgroundColor: currentTheme.background,
                                                            color: currentTheme.textPrimary
                                                        }}
                                                    />
                                                </td>
                                                <td className="px-6 py-4">
                                                    <input
                                                        type="date"
                                                        value={job.completionDate}
                                                        onChange={(e) => updateJobField(job.id, 'completionDate', e.target.value)}
                                                        className="px-3 py-2 rounded-lg border-2 cursor-pointer"
                                                        style={{
                                                            borderColor: currentTheme.border,
                                                            backgroundColor: currentTheme.background,
                                                            color: currentTheme.textPrimary
                                                        }}
                                                    />
                                                </td>
                                                <td className="px-6 py-4">
                                                    <div
                                                        contentEditable
                                                        suppressContentEditableWarning
                                                        onBlur={(e) => updateJobField(job.id, 'description', e.target.textContent)}
                                                        style={{ color: currentTheme.textPrimary }}
                                                    >
                                                        {job.description}
                                                    </div>
                                                </td>
                                                <td className="px-6 py-4">
                                                    <div
                                                        contentEditable
                                                        suppressContentEditableWarning
                                                        onBlur={(e) => updateJobField(job.id, 'totalPrice', e.target.textContent)}
                                                        className="font-bold"
                                                        style={{ color: currentTheme.success }}
                                                    >
                                                        ${job.totalPrice}
                                                    </div>
                                                </td>
                                                <td className="px-6 py-4">
                                                    <div
                                                        contentEditable
                                                        suppressContentEditableWarning
                                                        onBlur={(e) => updateJobField(job.id, 'materialCost', e.target.textContent)}
                                                        className="font-bold"
                                                        style={{ color: currentTheme.warning }}
                                                    >
                                                        ${job.materialCost}
                                                    </div>
                                                </td>
                                                <td className="px-6 py-4">
                                                    <div
                                                        contentEditable
                                                        suppressContentEditableWarning
                                                        onBlur={(e) => updateJobField(job.id, 'workHours', e.target.textContent)}
                                                        style={{ color: currentTheme.textPrimary }}
                                                    >
                                                        {job.workHours}h
                                                    </div>
                                                </td>
                                                <td className="px-6 py-4">
                                                    <button
                                                        onClick={() => setShowMetrics(job)}
                                                        className="p-2 rounded-lg hover:scale-110 transition-transform"
                                                        style={{ backgroundColor: currentTheme.primary }}
                                                        title="View Details"
                                                    >
                                                        <Eye size={18} style={{ color: 'white' }} />
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    {/* Metrics Modal */}
                    {showMetrics && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-6">
                            <div className="rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" style={{ backgroundColor: currentTheme.cardBg }}>
                                <div className="p-6 border-b-2" style={{ borderColor: currentTheme.border, background: `linear-gradient(135deg, ${currentTheme.primary} 0%, ${currentTheme.secondary} 100%)` }}>
                                    <h2 className="text-3xl font-bold text-white flex items-center gap-3">
                                        📊 Job Metrics - {showMetrics.customer}
                                    </h2>
                                </div>

                                <div className="p-6 space-y-6">
                                    {/* Financial Breakdown */}
                                    <div className="p-4 rounded-lg border-2" style={{ borderColor: currentTheme.border, backgroundColor: currentTheme.cardBg }}>
                                        <h3 className="text-lg font-bold mb-4 flex items-center gap-2" style={{ color: currentTheme.textPrimary }}>
                                            💰 Financial Breakdown
                                        </h3>
                                        <div className="grid grid-cols-3 gap-4">
                                            <div>
                                                <div className="text-sm font-medium mb-1" style={{ color: currentTheme.textSecondary }}>Total Price</div>
                                                <div className="text-2xl font-bold" style={{ color: currentTheme.success }}>
                                                    ${(parseFloat(showMetrics.totalPrice) || 0).toFixed(2)}
                                                </div>
                                            </div>
                                            <div>
                                                <div className="text-sm font-medium mb-1" style={{ color: currentTheme.textSecondary }}>Material Cost</div>
                                                <div className="text-2xl font-bold" style={{ color: currentTheme.warning }}>
                                                    ${(parseFloat(showMetrics.materialCost) || 0).toFixed(2)}
                                                </div>
                                            </div>
                                            <div>
                                                <div className="text-sm font-medium mb-1" style={{ color: currentTheme.textSecondary }}>Labor Profit</div>
                                                <div className="text-2xl font-bold" style={{ color: currentTheme.primary }}>
                                                    ${((parseFloat(showMetrics.totalPrice) || 0) - (parseFloat(showMetrics.materialCost) || 0)).toFixed(2)}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Profit Margin */}
                                        <div className="mt-4 pt-4" style={{ borderTop: `1px solid ${currentTheme.border}` }}>
                                            <div className="flex justify-between items-center mb-2">
                                                <span className="text-sm font-medium" style={{ color: currentTheme.textSecondary }}>Profit Margin</span>
                                                <span className="text-lg font-bold" style={{ color: currentTheme.primary }}>
                                                    {(() => {
                                                        const total = parseFloat(showMetrics.totalPrice) || 0;
                                                        const material = parseFloat(showMetrics.materialCost) || 0;
                                                        return total > 0 ? (((total - material) / total) * 100).toFixed(1) : '0.0';
                                                    })()}%
                                                </span>
                                            </div>
                                            <div className="w-full bg-gray-200 rounded-full h-3">
                                                <div 
                                                    className="h-3 rounded-full transition-all duration-500"
                                                    style={{ 
                                                        width: `${(() => {
                                                            const total = parseFloat(showMetrics.totalPrice) || 0;
                                                            const material = parseFloat(showMetrics.materialCost) || 0;
                                                            return total > 0 ? ((total - material) / total) * 100 : 0;
                                                        })()}%`,
                                                        background: `linear-gradient(to right, ${currentTheme.primary}, ${currentTheme.secondary})`
                                                    }}
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    {/* Timeline */}
                                    <div className="p-4 rounded-lg border-2" style={{ borderColor: currentTheme.border, backgroundColor: currentTheme.cardBg }}>
                                        <h3 className="text-lg font-bold mb-4 flex items-center gap-2" style={{ color: currentTheme.textPrimary }}>
                                            📅 Timeline
                                        </h3>
                                        <div className="space-y-3">
                                            <div className="flex justify-between items-center">
                                                <span style={{ color: currentTheme.textSecondary }}>Request Date</span>
                                                <span className="font-bold" style={{ color: currentTheme.textPrimary }}>
                                                    {showMetrics.requestDate || 'Not set'}
                                                </span>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <span style={{ color: currentTheme.textSecondary }}>Completion Date</span>
                                                <span className="font-bold" style={{ color: currentTheme.textPrimary }}>
                                                    {showMetrics.completionDate || 'Not set'}
                                                </span>
                                            </div>
                                            {showMetrics.requestDate && showMetrics.completionDate && (
                                                <div className="flex justify-between items-center pt-2" style={{ borderTop: `1px solid ${currentTheme.border}` }}>
                                                    <span style={{ color: currentTheme.textSecondary }}>Duration</span>
                                                    <span className="font-bold" style={{ color: currentTheme.primary }}>
                                                        {Math.ceil((new Date(showMetrics.completionDate) - new Date(showMetrics.requestDate)) / (1000 * 60 * 60 * 24))} days
                                                    </span>
                                                </div>
                                            )}
                                            <div className="flex justify-between items-center pt-2" style={{ borderTop: `1px solid ${currentTheme.border}` }}>
                                                <span style={{ color: currentTheme.textSecondary }}>Work Hours</span>
                                                <span className="font-bold" style={{ color: currentTheme.primary }}>
                                                    {parseFloat(showMetrics.workHours) || 0} hours
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Notes */}
                                    {showMetrics.notes && (
                                        <div className="p-4 rounded-lg border-2" style={{ borderColor: currentTheme.border, backgroundColor: currentTheme.cardBg }}>
                                            <h3 className="text-lg font-bold mb-2 flex items-center gap-2" style={{ color: currentTheme.textPrimary }}>
                                                📝 Notes
                                            </h3>
                                            <p style={{ color: currentTheme.textSecondary }}>{showMetrics.notes}</p>
                                        </div>
                                    )}
                                </div>

                                <div className="flex justify-between items-center p-6 pt-0">
                                    <button
                                        onClick={() => {
                                            generateInvoice(showMetrics);
                                        }}
                                        className="px-8 py-4 text-white rounded-xl font-semibold transition-all duration-300 flex items-center gap-3 shadow-lg hover:shadow-xl hover:scale-105 transform"
                                        style={{
                                            background: `linear-gradient(135deg, ${currentTheme.primary} 0%, ${currentTheme.secondary} 100%)`
                                        }}
                                    >
                                        <FileText size={22} />
                                        Generate Invoice
                                    </button>
                                    <button
                                        onClick={() => setShowMetrics(null)}
                                        className="px-6 py-3 text-white rounded-xl font-medium transition-all duration-200 hover:scale-105 transform"
                                        style={{
                                            backgroundColor: currentTheme.textSecondary
                                        }}
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
