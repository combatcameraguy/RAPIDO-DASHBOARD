<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAPIDO Handyman Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <!-- jsPDF for Invoice Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* Apply Kanit font globally */
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap');
        
        * {
            font-family: 'Kanit', sans-serif !important;
        }
        
        body {
            font-family: 'Kanit', sans-serif !important;
        }
        
        /* Force Kanit on header specifically */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Kanit', sans-serif !important;
        }
        
        /* Remove number input arrows */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Make calendar popups 2x larger */
        input[type="date"]::-webkit-calendar-picker-indicator {
            font-size: 2em;
            cursor: pointer;
        }
        
        /* Chrome/Edge calendar popup styling */
        input[type="date"]::-webkit-datetime-edit {
            padding: 0.5em;
        }
        
        /* Make the calendar dropdown itself larger in supported browsers */
        @media screen and (-webkit-min-device-pixel-ratio:0) {
            input[type="date"] {
                min-height: 2.5em;
            }
        }
        
        /* Ensure editable text inherits color from row */
        tbody tr td > div {
            color: inherit;
        }
        
        /* Visible styling for editable text fields */
        tbody tr td > div[contenteditable="true"] {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            min-height: 32px;
            cursor: text;
        }
        
        tbody tr td > div[contenteditable="true"]:hover {
            border: 1px solid rgba(59, 130, 246, 0.3);
            background-color: rgba(59, 130, 246, 0.05);
        }
        
        tbody tr td > div[contenteditable="true"]:focus {
            outline: none;
            border: 1px solid rgba(59, 130, 246, 0.6);
            background-color: rgba(59, 130, 246, 0.1);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Dark mode editable fields */
        .dark-mode tbody tr td > div[contenteditable="true"]:hover {
            border: 1px solid rgba(100, 149, 237, 0.4);
            background-color: rgba(100, 149, 237, 0.1);
        }
        
        .dark-mode tbody tr td > div[contenteditable="true"]:focus {
            border: 1px solid rgba(100, 149, 237, 0.7);
            background-color: rgba(100, 149, 237, 0.15);
            box-shadow: 0 0 0 3px rgba(100, 149, 237, 0.15);
        }
        
        /* Fix icon cutoff in Actions column - only add vertical padding */
        tbody tr td {
            vertical-align: middle;
        }
        
        /* Ensure action buttons container has proper spacing */
        tbody tr td > div.flex {
            gap: 8px;
            padding: 4px 0;
        }
        
        /* Ensure icons are properly contained and have space */
        tbody tr td button,
        tbody tr td a {
            padding: 8px;
        }
        
        tbody tr td button svg,
        tbody tr td a svg {
            display: block;
            flex-shrink: 0;
        }
        
        /* Add spacing to checkboxes from left edge */
        tbody tr td input[type="checkbox"],
        thead tr th input[type="checkbox"] {
            margin-left: 12px;
        }
        
        /* Row drag styling */
        tbody tr[draggable="true"] {
            cursor: move;
        }
        
        tbody tr[draggable="true"]:active {
            opacity: 0.5;
            cursor: grabbing;
        }
        
        tbody tr.drag-over {
            border-top: 3px solid #3b82f6;
        }
        
        /* Pulse animation for sync indicator */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .syncing {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Loading screen styles */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Lucide React Icons (embedded)
        const CheckCircle = ({ size = 24, color = "currentColor", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
        );

        const Clock = ({ size = 24, color = "currentColor", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        );

        const AlertCircle = ({ size = 24, color = "currentColor", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
        );

        const Trash2 = ({ size = 24, color = "currentColor", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        const FileText = ({ size = 24, color = "currentColor", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
        );

        const Plus = ({ size = 24, color = "currentColor", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const Download = ({ size = 24, color = "currentColor", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );

        const Upload = ({ size = 24, color = "currentColor", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
        );

        const Moon = ({ size = 24, color = "currentColor", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
        );

        const Sun = ({ size = 24, color = "currentColor", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
        );

        const LogOut = ({ size = 24, color = "currentColor", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
        );

        const BarChart2 = ({ size = 24, color = "currentColor", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <line x1="18" y1="20" x2="18" y2="10"></line>
                <line x1="12" y1="20" x2="12" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="14"></line>
            </svg>
        );

        const Eye = ({ size = 24, color = "currentColor", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
            </svg>
        );

        const Cloud = ({ size = 24, color = "currentColor", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
            </svg>
        );

        const CloudOff = ({ size = 24, color = "currentColor", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M22.61 16.95A5 5 0 0 0 18 10h-1.26a8 8 0 0 0-7.05-6M5 5a8 8 0 0 0 4 15h9a5 5 0 0 0 1.7-.3"></path>
                <line x1="1" y1="1" x2="23" y2="23"></line>
            </svg>
        );

        // Firebase configuration - BRAND NEW CREDENTIALS (v2)
        // IMPORTANT: Your Firebase Realtime Database Rules are configured as:
        // {
        //   "rules": {
        //     "users": {
        //       "$uid": {
        //         ".read": "$uid === auth.uid",
        //         ".write": "$uid === auth.uid"
        //       }
        //     }
        //   }
        // }
        // This means each user can only read/write their OWN data under /users/{their-uid}/
        const firebaseConfig = {
            apiKey: "AIzaSyDvYPFm6PtVXKe01Uo1_CMGqrWFp_oXbm0",
            authDomain: "rapido-dashboard.firebaseapp.com",
            databaseURL: "https://rapido-dashboard-default-rtdb.firebaseio.com",
            projectId: "rapido-dashboard",
            storageBucket: "rapido-dashboard.firebasestorage.app",
            messagingSenderId: "917389932203",
            appId: "1:917389932203:web:972f35509e0cb4d9ee69ee"
        };

        // Initialize Firebase
        let database;
        let auth;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            database = firebase.database();
            auth = firebase.auth();
            console.log('✅ Firebase initialized successfully');
        } catch (error) {
            console.error('❌ Firebase initialization error:', error);
        }

        // Theme configurations
        const themes = {
            purple: {
                name: 'Purple',
                primary: '#8b5cf6',
                secondary: '#a78bfa',
                accent: '#c4b5fd',
                background: '#f5f3ff',
                cardBg: '#ffffff',
                textPrimary: '#1f2937',
                textSecondary: '#6b7280',
                border: '#e5e7eb',
                success: '#10b981',
                warning: '#f59e0b',
                danger: '#ef4444'
            },
            blue: {
                name: 'Blue',
                primary: '#3b82f6',
                secondary: '#60a5fa',
                accent: '#93c5fd',
                background: '#eff6ff',
                cardBg: '#ffffff',
                textPrimary: '#1f2937',
                textSecondary: '#6b7280',
                border: '#e5e7eb',
                success: '#10b981',
                warning: '#f59e0b',
                danger: '#ef4444'
            },
            green: {
                name: 'Green',
                primary: '#10b981',
                secondary: '#34d399',
                accent: '#6ee7b7',
                background: '#ecfdf5',
                cardBg: '#ffffff',
                textPrimary: '#1f2937',
                textSecondary: '#6b7280',
                border: '#e5e7eb',
                success: '#10b981',
                warning: '#f59e0b',
                danger: '#ef4444'
            },
            orange: {
                name: 'Orange',
                primary: '#f97316',
                secondary: '#fb923c',
                accent: '#fdba74',
                background: '#fff7ed',
                cardBg: '#ffffff',
                textPrimary: '#1f2937',
                textSecondary: '#6b7280',
                border: '#e5e7eb',
                success: '#10b981',
                warning: '#f59e0b',
                danger: '#ef4444'
            },
            pink: {
                name: 'Pink',
                primary: '#ec4899',
                secondary: '#f472b6',
                accent: '#f9a8d4',
                background: '#fdf2f8',
                cardBg: '#ffffff',
                textPrimary: '#1f2937',
                textSecondary: '#6b7280',
                border: '#e5e7eb',
                success: '#10b981',
                warning: '#f59e0b',
                danger: '#ef4444'
            },
            dark: {
                name: 'Dark',
                primary: '#8b5cf6',
                secondary: '#a78bfa',
                accent: '#c4b5fd',
                background: '#1f2937',
                cardBg: '#374151',
                textPrimary: '#f9fafb',
                textSecondary: '#d1d5db',
                border: '#4b5563',
                success: '#10b981',
                warning: '#f59e0b',
                danger: '#ef4444'
            }
        };

        function App() {
            const [user, setUser] = useState(null);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [jobs, setJobs] = useState([]);
            const [showMetrics, setShowMetrics] = useState(null);
            const [selectedJobs, setSelectedJobs] = useState(new Set());
            const [draggedRow, setDraggedRow] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [currentTheme, setCurrentTheme] = useState(themes.purple);
            const [darkMode, setDarkMode] = useState(false);
            const [syncStatus, setSyncStatus] = useState('idle'); // 'idle', 'syncing', 'synced', 'error'
            const [lastSyncTime, setLastSyncTime] = useState(null);
            const [isLoadingData, setIsLoadingData] = useState(true); // NEW: Track initial data loading
            const syncIntervalRef = useRef(null);

            // NEW: Wait for cloud data on login
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                        setIsLoadingData(true); // Show loading screen
                        
                        try {
                            // Wait for Firebase data to load first
                            const snapshot = await database.ref(`users/${currentUser.uid}/jobs`).once('value');
                            const firebaseJobs = snapshot.val();
                            
                            if (firebaseJobs) {
                                // Cloud data exists - use it
                                const jobsArray = Object.keys(firebaseJobs).map(key => ({
                                    id: key,
                                    ...firebaseJobs[key]
                                }));
                                setJobs(jobsArray);
                                // Also update localStorage with cloud data
                                localStorage.setItem(`jobs_${currentUser.uid}`, JSON.stringify(jobsArray));
                                console.log('✅ Loaded data from Firebase cloud');
                            } else {
                                // No cloud data - check localStorage
                                const savedJobs = localStorage.getItem(`jobs_${currentUser.uid}`);
                                if (savedJobs) {
                                    const parsedJobs = JSON.parse(savedJobs);
                                    setJobs(parsedJobs);
                                    // Upload localStorage data to cloud
                                    await saveToFirebase(parsedJobs, currentUser.uid);
                                    console.log('✅ Uploaded local data to Firebase cloud');
                                }
                            }
                            
                            // Load theme
                            const savedTheme = localStorage.getItem(`theme_${currentUser.uid}`) || 'purple';
                            setCurrentTheme(themes[savedTheme]);
                            
                            const savedDarkMode = localStorage.getItem(`darkMode_${currentUser.uid}`) === 'true';
                            setDarkMode(savedDarkMode);
                            
                            setIsLoadingData(false); // Hide loading screen
                            
                            // Start auto-sync after data is loaded
                            startAutoSync(currentUser.uid);
                            
                        } catch (error) {
                            console.error('Error loading cloud data:', error);
                            setIsLoadingData(false);
                            // Fallback to localStorage if Firebase fails
                            const savedJobs = localStorage.getItem(`jobs_${currentUser.uid}`);
                            if (savedJobs) {
                                setJobs(JSON.parse(savedJobs));
                            }
                        }
                    } else {
                        setUser(null);
                        setJobs([]);
                        setIsLoadingData(false);
                        stopAutoSync();
                    }
                });

                return () => {
                    unsubscribe();
                    stopAutoSync();
                };
            }, []);

            // NEW: Auto-sync every 60 seconds
            const startAutoSync = (userId) => {
                // Clear any existing interval
                if (syncIntervalRef.current) {
                    clearInterval(syncIntervalRef.current);
                }
                
                // Set up new interval for 60-second sync
                syncIntervalRef.current = setInterval(() => {
                    console.log('⏰ Auto-sync triggered (60 seconds)');
                    syncToFirebase(userId);
                }, 60000); // 60 seconds = 60,000 milliseconds
                
                console.log('✅ Auto-sync started: syncing every 60 seconds');
            };

            const stopAutoSync = () => {
                if (syncIntervalRef.current) {
                    clearInterval(syncIntervalRef.current);
                    syncIntervalRef.current = null;
                    console.log('⏹️ Auto-sync stopped');
                }
            };

            const syncToFirebase = async (userId) => {
                if (!userId || jobs.length === 0) return;
                
                setSyncStatus('syncing');
                try {
                    await saveToFirebase(jobs, userId);
                    setSyncStatus('synced');
                    setLastSyncTime(new Date());
                    setTimeout(() => setSyncStatus('idle'), 2000);
                    console.log('✅ Auto-sync completed successfully');
                } catch (error) {
                    console.error('❌ Auto-sync failed:', error);
                    setSyncStatus('error');
                    setTimeout(() => setSyncStatus('idle'), 3000);
                }
            };

            const saveToFirebase = async (jobsData, userId) => {
                if (!userId) return;
                
                try {
                    const jobsObject = {};
                    jobsData.forEach(job => {
                        jobsObject[job.id] = {
                            clientName: job.clientName,
                            address: job.address,
                            requestDate: job.requestDate,
                            completionDate: job.completionDate,
                            status: job.status,
                            totalPrice: job.totalPrice,
                            materialCost: job.materialCost,
                            workHours: job.workHours,
                            notes: job.notes,
                            order: job.order
                        };
                    });
                    
                    await database.ref(`users/${userId}/jobs`).set(jobsObject);
                    localStorage.setItem(`jobs_${userId}`, JSON.stringify(jobsData));
                } catch (error) {
                    console.error('Error saving to Firebase:', error);
                    throw error;
                }
            };

            const handleSignUp = async (e) => {
                e.preventDefault();
                try {
                    await auth.createUserWithEmailAndPassword(email, password);
                } catch (error) {
                    alert(error.message);
                }
            };

            const handleSignIn = async (e) => {
                e.preventDefault();
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    alert(error.message);
                }
            };

            const handleSignOut = async () => {
                try {
                    await auth.signOut();
                    stopAutoSync();
                } catch (error) {
                    alert(error.message);
                }
            };

            const addJob = () => {
                const newJob = {
                    id: Date.now().toString(),
                    clientName: '',
                    address: '',
                    requestDate: '',
                    completionDate: '',
                    status: 'pending',
                    totalPrice: '',
                    materialCost: '',
                    workHours: '',
                    notes: '',
                    order: jobs.length
                };
                
                const updatedJobs = [...jobs, newJob];
                setJobs(updatedJobs);
                if (user) {
                    saveToFirebase(updatedJobs, user.uid);
                }
            };

            const deleteSelectedJobs = () => {
                if (selectedJobs.size === 0) return;
                
                if (window.confirm(`Delete ${selectedJobs.size} selected job(s)?`)) {
                    const updatedJobs = jobs
                        .filter(job => !selectedJobs.has(job.id))
                        .map((job, index) => ({ ...job, order: index }));
                    
                    setJobs(updatedJobs);
                    setSelectedJobs(new Set());
                    
                    if (user) {
                        saveToFirebase(updatedJobs, user.uid);
                    }
                }
            };

            const updateJob = (id, field, value) => {
                const updatedJobs = jobs.map(job =>
                    job.id === id ? { ...job, [field]: value } : job
                );
                setJobs(updatedJobs);
                if (user) {
                    saveToFirebase(updatedJobs, user.uid);
                }
            };

            const deleteJob = (id) => {
                if (window.confirm('Delete this job?')) {
                    const updatedJobs = jobs
                        .filter(job => job.id !== id)
                        .map((job, index) => ({ ...job, order: index }));
                    
                    setJobs(updatedJobs);
                    if (user) {
                        saveToFirebase(updatedJobs, user.uid);
                    }
                }
            };

            const toggleJobSelection = (id) => {
                const newSelected = new Set(selectedJobs);
                if (newSelected.has(id)) {
                    newSelected.delete(id);
                } else {
                    newSelected.add(id);
                }
                setSelectedJobs(newSelected);
            };

            const toggleSelectAll = () => {
                if (selectedJobs.size === filteredJobs.length) {
                    setSelectedJobs(new Set());
                } else {
                    setSelectedJobs(new Set(filteredJobs.map(job => job.id)));
                }
            };

            const handleDragStart = (e, index) => {
                setDraggedRow(index);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDragOver = (e, index) => {
                e.preventDefault();
                if (draggedRow === null || draggedRow === index) return;
                
                const newJobs = [...jobs];
                const draggedJob = newJobs[draggedRow];
                newJobs.splice(draggedRow, 1);
                newJobs.splice(index, 0, draggedJob);
                
                const reorderedJobs = newJobs.map((job, idx) => ({ ...job, order: idx }));
                setJobs(reorderedJobs);
                setDraggedRow(index);
            };

            const handleDragEnd = () => {
                setDraggedRow(null);
                if (user) {
                    saveToFirebase(jobs, user.uid);
                }
            };

            const exportData = () => {
                const dataStr = JSON.stringify(jobs, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `rapido_jobs_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            };

            const importData = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedJobs = JSON.parse(event.target.result);
                        const reorderedJobs = importedJobs.map((job, index) => ({ ...job, order: index }));
                        setJobs(reorderedJobs);
                        if (user) {
                            saveToFirebase(reorderedJobs, user.uid);
                        }
                        alert('Data imported successfully!');
                    } catch (error) {
                        alert('Error importing data. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            };

            const changeTheme = (themeName) => {
                setCurrentTheme(themes[themeName]);
                if (user) {
                    localStorage.setItem(`theme_${user.uid}`, themeName);
                }
            };

            const toggleDarkMode = () => {
                const newDarkMode = !darkMode;
                setDarkMode(newDarkMode);
                if (user) {
                    localStorage.setItem(`darkMode_${user.uid}`, newDarkMode);
                }
            };

            const filteredJobs = jobs
                .filter(job =>
                    job.clientName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    job.address.toLowerCase().includes(searchTerm.toLowerCase())
                )
                .sort((a, b) => (a.order || 0) - (b.order || 0));

            const totalPrice = jobs.reduce((sum, job) => sum + (parseFloat(job.totalPrice) || 0), 0);
            const totalMaterialCost = jobs.reduce((sum, job) => sum + (parseFloat(job.materialCost) || 0), 0);
            const totalLaborProfit = totalPrice - totalMaterialCost;

            const completedJobs = jobs.filter(job => job.status === 'completed').length;
            const pendingJobs = jobs.filter(job => job.status === 'pending').length;
            const inProgressJobs = jobs.filter(job => job.status === 'in-progress').length;

            // Invoice generation function
            const generateInvoice = (job) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Colors
                const primaryColor = [139, 92, 246]; // Purple
                const textColor = [31, 41, 55];
                const lightGray = [243, 244, 246];
                
                // Header
                doc.setFillColor(...primaryColor);
                doc.rect(0, 0, 220, 40, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(28);
                doc.setFont(undefined, 'bold');
                doc.text('INVOICE', 20, 25);
                
                // Company info (right side of header)
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('RAPIDO Handyman Services', 150, 15);
                doc.text('Contact: your@email.com', 150, 21);
                doc.text(`Date: ${new Date().toLocaleDateString()}`, 150, 27);
                
                // Client info section
                doc.setTextColor(...textColor);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('BILL TO:', 20, 55);
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(11);
                doc.text(job.clientName || 'N/A', 20, 62);
                doc.text(job.address || 'N/A', 20, 68);
                
                // Invoice details box
                doc.setFillColor(...lightGray);
                doc.rect(130, 50, 65, 25, 'F');
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('Invoice #:', 135, 57);
                doc.text('Request Date:', 135, 64);
                doc.text('Completion:', 135, 71);
                
                doc.setFont(undefined, 'normal');
                doc.text(job.id.slice(-6), 170, 57);
                doc.text(job.requestDate || 'N/A', 170, 64);
                doc.text(job.completionDate || 'N/A', 170, 71);
                
                // Table header
                doc.setFillColor(...primaryColor);
                doc.rect(20, 90, 170, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('Description', 25, 97);
                doc.text('Hours', 120, 97);
                doc.text('Amount', 160, 97);
                
                // Table content
                doc.setTextColor(...textColor);
                doc.setFont(undefined, 'normal');
                let yPos = 110;
                
                // Labor row
                doc.text('Labor', 25, yPos);
                doc.text((parseFloat(job.workHours) || 0).toFixed(1), 120, yPos);
                const laborCost = (parseFloat(job.totalPrice) || 0) - (parseFloat(job.materialCost) || 0);
                doc.text(`$${laborCost.toFixed(2)}`, 160, yPos);
                
                yPos += 10;
                
                // Materials row
                doc.text('Materials', 25, yPos);
                doc.text('-', 120, yPos);
                doc.text(`$${(parseFloat(job.materialCost) || 0).toFixed(2)}`, 160, yPos);
                
                // Subtotal line
                yPos += 20;
                doc.setDrawColor(...textColor);
                doc.line(130, yPos, 190, yPos);
                
                // Total
                yPos += 10;
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('TOTAL:', 130, yPos);
                doc.text(`$${(parseFloat(job.totalPrice) || 0).toFixed(2)}`, 160, yPos);
                
                // Notes section
                if (job.notes) {
                    yPos += 20;
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.text('Notes:', 20, yPos);
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(10);
                    
                    const splitNotes = doc.splitTextToSize(job.notes, 170);
                    doc.text(splitNotes, 20, yPos + 7);
                }
                
                // Footer
                doc.setFontSize(9);
                doc.setTextColor(128, 128, 128);
                doc.text('Thank you for your business!', 105, 280, { align: 'center' });
                
                // Save
                doc.save(`invoice_${job.clientName.replace(/\s+/g, '_')}_${job.id.slice(-6)}.pdf`);
            };

            // Apply dark mode class to body
            useEffect(() => {
                if (darkMode) {
                    document.body.classList.add('dark-mode');
                    document.body.style.backgroundColor = themes.dark.background;
                } else {
                    document.body.classList.remove('dark-mode');
                    document.body.style.backgroundColor = currentTheme.background;
                }
            }, [darkMode, currentTheme]);

            // Format sync time
            const formatSyncTime = (date) => {
                if (!date) return '';
                const now = new Date();
                const diffMs = now - date;
                const diffSecs = Math.floor(diffMs / 1000);
                const diffMins = Math.floor(diffSecs / 60);
                
                if (diffSecs < 60) return 'Just now';
                if (diffMins === 1) return '1 minute ago';
                if (diffMins < 60) return `${diffMins} minutes ago`;
                
                return date.toLocaleTimeString();
            };

            // Show loading screen while waiting for cloud data
            if (isLoadingData && user) {
                return (
                    <div className="loading-screen">
                        <div className="loading-spinner"></div>
                        <h2 className="text-white text-2xl font-bold mt-6">Loading your data from cloud...</h2>
                        <p className="text-white text-lg mt-2 opacity-80">Please wait</p>
                    </div>
                );
            }

            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center" style={{ 
                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                    }}>
                        <div className="bg-white p-8 rounded-2xl shadow-2xl w-96">
                            <h1 className="text-3xl font-bold text-center mb-6" style={{ color: '#667eea' }}>
                                RAPIDO Dashboard
                            </h1>
                            <form onSubmit={handleSignIn} className="space-y-4">
                                <input
                                    type="email"
                                    placeholder="Email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-colors"
                                    required
                                />
                                <input
                                    type="password"
                                    placeholder="Password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-colors"
                                    required
                                />
                                <button
                                    type="submit"
                                    className="w-full py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg font-semibold hover:from-purple-600 hover:to-purple-700 transition-all transform hover:scale-105 shadow-lg"
                                >
                                    Sign In
                                </button>
                                <button
                                    type="button"
                                    onClick={handleSignUp}
                                    className="w-full py-3 bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-lg font-semibold hover:from-gray-600 hover:to-gray-700 transition-all transform hover:scale-105 shadow-lg"
                                >
                                    Sign Up
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div 
                    className="min-h-screen p-8 transition-colors duration-300" 
                    style={{ 
                        backgroundColor: darkMode ? themes.dark.background : currentTheme.background 
                    }}
                >
                    {/* Header */}
                    <div className="max-w-7xl mx-auto mb-8">
                        <div className="flex justify-between items-center mb-6">
                            <h1 
                                className="text-4xl font-bold"
                                style={{ 
                                    color: darkMode ? themes.dark.textPrimary : currentTheme.textPrimary,
                                    textShadow: '2px 2px 4px rgba(0,0,0,0.1)'
                                }}
                            >
                                RAPIDO Handyman Dashboard
                            </h1>
                            
                            <div className="flex items-center gap-4">
                                {/* Sync Status Indicator */}
                                <div className="flex items-center gap-2 px-4 py-2 rounded-lg" style={{
                                    backgroundColor: darkMode ? themes.dark.cardBg : 'white',
                                    border: `2px solid ${darkMode ? themes.dark.border : currentTheme.border}`
                                }}>
                                    {syncStatus === 'syncing' && (
                                        <>
                                            <Cloud size={20} color={currentTheme.primary} className="syncing" />
                                            <span style={{ color: darkMode ? themes.dark.textSecondary : currentTheme.textSecondary }}>
                                                Syncing...
                                            </span>
                                        </>
                                    )}
                                    {syncStatus === 'synced' && (
                                        <>
                                            <Cloud size={20} color={currentTheme.success} />
                                            <span style={{ color: darkMode ? themes.dark.textSecondary : currentTheme.textSecondary }}>
                                                Synced {formatSyncTime(lastSyncTime)}
                                            </span>
                                        </>
                                    )}
                                    {syncStatus === 'error' && (
                                        <>
                                            <CloudOff size={20} color={currentTheme.danger} />
                                            <span style={{ color: currentTheme.danger }}>
                                                Sync failed
                                            </span>
                                        </>
                                    )}
                                    {syncStatus === 'idle' && lastSyncTime && (
                                        <>
                                            <Cloud size={20} color={currentTheme.textSecondary} />
                                            <span style={{ color: darkMode ? themes.dark.textSecondary : currentTheme.textSecondary }}>
                                                Last sync: {formatSyncTime(lastSyncTime)}
                                            </span>
                                        </>
                                    )}
                                    {syncStatus === 'idle' && !lastSyncTime && (
                                        <>
                                            <Cloud size={20} color={currentTheme.textSecondary} />
                                            <span style={{ color: darkMode ? themes.dark.textSecondary : currentTheme.textSecondary }}>
                                                Auto-sync active
                                            </span>
                                        </>
                                    )}
                                </div>

                                {/* Dark Mode Toggle */}
                                <button
                                    onClick={toggleDarkMode}
                                    className="p-3 rounded-xl transition-all transform hover:scale-110 shadow-lg"
                                    style={{
                                        backgroundColor: darkMode ? themes.dark.cardBg : 'white',
                                        border: `2px solid ${darkMode ? themes.dark.border : currentTheme.border}`
                                    }}
                                >
                                    {darkMode ? (
                                        <Sun size={24} color={themes.dark.primary} />
                                    ) : (
                                        <Moon size={24} color={currentTheme.primary} />
                                    )}
                                </button>
                                
                                {/* Logout Button */}
                                <button
                                    onClick={handleSignOut}
                                    className="flex items-center gap-2 px-6 py-3 text-white rounded-xl font-semibold transition-all transform hover:scale-105 shadow-lg"
                                    style={{
                                        background: `linear-gradient(135deg, ${currentTheme.primary} 0%, ${currentTheme.secondary} 100%)`
                                    }}
                                >
                                    <LogOut size={20} />
                                    Logout
                                </button>
                            </div>
                        </div>

                        {/* Stats Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                            <div 
                                className="p-6 rounded-2xl shadow-xl transition-all hover:scale-105 transform"
                                style={{ 
                                    background: `linear-gradient(135deg, ${currentTheme.primary} 0%, ${currentTheme.secondary} 100%)`,
                                    color: 'white'
                                }}
                            >
                                <div className="flex items-center justify-between mb-2">
                                    <h3 className="text-sm font-medium opacity-90">Total Jobs</h3>
                                    <BarChart2 size={24} className="opacity-80" />
                                </div>
                                <p className="text-3xl font-bold">{jobs.length}</p>
                            </div>

                            <div 
                                className="p-6 rounded-2xl shadow-xl transition-all hover:scale-105 transform"
                                style={{ 
                                    backgroundColor: darkMode ? themes.dark.cardBg : 'white',
                                    border: `2px solid ${darkMode ? themes.dark.border : currentTheme.border}`
                                }}
                            >
                                <div className="flex items-center justify-between mb-2">
                                    <h3 className="text-sm font-medium" style={{ color: darkMode ? themes.dark.textSecondary : currentTheme.textSecondary }}>
                                        Completed
                                    </h3>
                                    <CheckCircle size={24} color={currentTheme.success} />
                                </div>
                                <p className="text-3xl font-bold" style={{ color: darkMode ? themes.dark.textPrimary : currentTheme.textPrimary }}>
                                    {completedJobs}
                                </p>
                            </div>

                            <div 
                                className="p-6 rounded-2xl shadow-xl transition-all hover:scale-105 transform"
                                style={{ 
                                    backgroundColor: darkMode ? themes.dark.cardBg : 'white',
                                    border: `2px solid ${darkMode ? themes.dark.border : currentTheme.border}`
                                }}
                            >
                                <div className="flex items-center justify-between mb-2">
                                    <h3 className="text-sm font-medium" style={{ color: darkMode ? themes.dark.textSecondary : currentTheme.textSecondary }}>
                                        In Progress
                                    </h3>
                                    <Clock size={24} color={currentTheme.warning} />
                                </div>
                                <p className="text-3xl font-bold" style={{ color: darkMode ? themes.dark.textPrimary : currentTheme.textPrimary }}>
                                    {inProgressJobs}
                                </p>
                            </div>

                            <div 
                                className="p-6 rounded-2xl shadow-xl transition-all hover:scale-105 transform"
                                style={{ 
                                    backgroundColor: darkMode ? themes.dark.cardBg : 'white',
                                    border: `2px solid ${darkMode ? themes.dark.border : currentTheme.border}`
                                }}
                            >
                                <div className="flex items-center justify-between mb-2">
                                    <h3 className="text-sm font-medium" style={{ color: darkMode ? themes.dark.textSecondary : currentTheme.textSecondary }}>
                                        Pending
                                    </h3>
                                    <AlertCircle size={24} color={currentTheme.danger} />
                                </div>
                                <p className="text-3xl font-bold" style={{ color: darkMode ? themes.dark.textPrimary : currentTheme.textPrimary }}>
                                    {pendingJobs}
                                </p>
                            </div>

                            <div 
                                className="p-6 rounded-2xl shadow-xl transition-all hover:scale-105 transform"
                                style={{ 
                                    background: `linear-gradient(135deg, ${currentTheme.success} 0%, #34d399 100%)`,
                                    color: 'white'
                                }}
                            >
                                <div className="flex items-center justify-between mb-2">
                                    <h3 className="text-sm font-medium opacity-90">Labor Profit</h3>
                                    <span className="text-2xl">💰</span>
                                </div>
                                <p className="text-3xl font-bold">${totalLaborProfit.toFixed(2)}</p>
                            </div>
                        </div>

                        {/* Controls */}
                        <div className="flex flex-wrap gap-4 mb-6">
                            <button
                                onClick={addJob}
                                className="flex items-center gap-2 px-6 py-3 text-white rounded-xl font-semibold transition-all transform hover:scale-105 shadow-lg"
                                style={{
                                    background: `linear-gradient(135deg, ${currentTheme.primary} 0%, ${currentTheme.secondary} 100%)`
                                }}
                            >
                                <Plus size={20} />
                                Add Job
                            </button>

                            {selectedJobs.size > 0 && (
                                <button
                                    onClick={deleteSelectedJobs}
                                    className="flex items-center gap-2 px-6 py-3 text-white rounded-xl font-semibold transition-all transform hover:scale-105 shadow-lg"
                                    style={{
                                        background: `linear-gradient(135deg, ${currentTheme.danger} 0%, #f87171 100%)`
                                    }}
                                >
                                    <Trash2 size={20} />
                                    Delete Selected ({selectedJobs.size})
                                </button>
                            )}

                            <button
                                onClick={exportData}
                                className="flex items-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all transform hover:scale-105 shadow-lg"
                                style={{
                                    backgroundColor: darkMode ? themes.dark.cardBg : 'white',
                                    color: darkMode ? themes.dark.textPrimary : currentTheme.textPrimary,
                                    border: `2px solid ${darkMode ? themes.dark.border : currentTheme.border}`
                                }}
                            >
                                <Download size={20} />
                                Export
                            </button>

                            <label className="flex items-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all transform hover:scale-105 shadow-lg cursor-pointer"
                                style={{
                                    backgroundColor: darkMode ? themes.dark.cardBg : 'white',
                                    color: darkMode ? themes.dark.textPrimary : currentTheme.textPrimary,
                                    border: `2px solid ${darkMode ? themes.dark.border : currentTheme.border}`
                                }}
                            >
                                <Upload size={20} />
                                Import
                                <input type="file" accept=".json" onChange={importData} className="hidden" />
                            </label>

                            {/* Search Bar */}
                            <input
                                type="text"
                                placeholder="Search by client or address..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="flex-1 px-6 py-3 rounded-xl font-medium transition-all shadow-lg focus:ring-4 focus:outline-none"
                                style={{
                                    backgroundColor: darkMode ? themes.dark.cardBg : 'white',
                                    color: darkMode ? themes.dark.textPrimary : currentTheme.textPrimary,
                                    border: `2px solid ${darkMode ? themes.dark.border : currentTheme.border}`,
                                    focusRing: `${currentTheme.primary}33`
                                }}
                            />

                            {/* Theme Selector */}
                            <select
                                value={Object.keys(themes).find(key => themes[key] === currentTheme)}
                                onChange={(e) => changeTheme(e.target.value)}
                                className="px-6 py-3 rounded-xl font-semibold transition-all shadow-lg focus:ring-4 focus:outline-none"
                                style={{
                                    backgroundColor: darkMode ? themes.dark.cardBg : 'white',
                                    color: darkMode ? themes.dark.textPrimary : currentTheme.textPrimary,
                                    border: `2px solid ${darkMode ? themes.dark.border : currentTheme.border}`
                                }}
                            >
                                {Object.entries(themes).map(([key, theme]) => (
                                    <option key={key} value={key}>{theme.name}</option>
                                ))}
                            </select>
                        </div>

                        {/* Jobs Table */}
                        <div 
                            className="rounded-2xl shadow-2xl overflow-hidden"
                            style={{
                                backgroundColor: darkMode ? themes.dark.cardBg : 'white',
                                border: `2px solid ${darkMode ? themes.dark.border : currentTheme.border}`
                            }}
                        >
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead>
                                        <tr style={{ 
                                            background: `linear-gradient(135deg, ${currentTheme.primary} 0%, ${currentTheme.secondary} 100%)`,
                                            color: 'white'
                                        }}>
                                            <th className="p-4 text-left font-semibold">
                                                <input
                                                    type="checkbox"
                                                    checked={selectedJobs.size === filteredJobs.length && filteredJobs.length > 0}
                                                    onChange={toggleSelectAll}
                                                    className="cursor-pointer w-5 h-5"
                                                />
                                            </th>
                                            <th className="p-4 text-left font-semibold">Client Name</th>
                                            <th className="p-4 text-left font-semibold">Address</th>
                                            <th className="p-4 text-left font-semibold">Request Date</th>
                                            <th className="p-4 text-left font-semibold">Completion Date</th>
                                            <th className="p-4 text-left font-semibold">Status</th>
                                            <th className="p-4 text-left font-semibold">Total Price</th>
                                            <th className="p-4 text-left font-semibold">Material Cost</th>
                                            <th className="p-4 text-left font-semibold">Work Hours</th>
                                            <th className="p-4 text-left font-semibold">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredJobs.map((job, index) => (
                                            <tr
                                                key={job.id}
                                                draggable
                                                onDragStart={(e) => handleDragStart(e, index)}
                                                onDragOver={(e) => handleDragOver(e, index)}
                                                onDragEnd={handleDragEnd}
                                                className={`transition-colors ${
                                                    job.status === 'completed' ? 'bg-green-50' :
                                                    job.status === 'in-progress' ? 'bg-yellow-50' :
                                                    'bg-red-50'
                                                }`}
                                                style={{
                                                    backgroundColor: darkMode ? 
                                                        (job.status === 'completed' ? '#064e3b' :
                                                         job.status === 'in-progress' ? '#78350f' : '#7f1d1d') :
                                                        (job.status === 'completed' ? '#f0fdf4' :
                                                         job.status === 'in-progress' ? '#fefce8' : '#fef2f2'),
                                                    color: darkMode ? themes.dark.textPrimary : currentTheme.textPrimary,
                                                    borderBottom: `1px solid ${darkMode ? themes.dark.border : currentTheme.border}`
                                                }}
                                            >
                                                <td className="p-4">
                                                    <input
                                                        type="checkbox"
                                                        checked={selectedJobs.has(job.id)}
                                                        onChange={() => toggleJobSelection(job.id)}
                                                        className="cursor-pointer w-5 h-5"
                                                    />
                                                </td>
                                                <td className="p-4">
                                                    <div
                                                        contentEditable
                                                        suppressContentEditableWarning
                                                        onBlur={(e) => updateJob(job.id, 'clientName', e.target.textContent)}
                                                        className="min-w-[150px]"
                                                    >
                                                        {job.clientName}
                                                    </div>
                                                </td>
                                                <td className="p-4">
                                                    <div
                                                        contentEditable
                                                        suppressContentEditableWarning
                                                        onBlur={(e) => updateJob(job.id, 'address', e.target.textContent)}
                                                        className="min-w-[200px]"
                                                    >
                                                        {job.address}
                                                    </div>
                                                </td>
                                                <td className="p-4">
                                                    <input
                                                        type="date"
                                                        value={job.requestDate}
                                                        onChange={(e) => updateJob(job.id, 'requestDate', e.target.value)}
                                                        className="p-2 rounded-lg border-2 transition-all focus:ring-2 focus:outline-none bg-transparent"
                                                        style={{
                                                            borderColor: darkMode ? themes.dark.border : currentTheme.border,
                                                            color: darkMode ? themes.dark.textPrimary : currentTheme.textPrimary
                                                        }}
                                                    />
                                                </td>
                                                <td className="p-4">
                                                    <input
                                                        type="date"
                                                        value={job.completionDate}
                                                        onChange={(e) => updateJob(job.id, 'completionDate', e.target.value)}
                                                        className="p-2 rounded-lg border-2 transition-all focus:ring-2 focus:outline-none bg-transparent"
                                                        style={{
                                                            borderColor: darkMode ? themes.dark.border : currentTheme.border,
                                                            color: darkMode ? themes.dark.textPrimary : currentTheme.textPrimary
                                                        }}
                                                    />
                                                </td>
                                                <td className="p-4">
                                                    <select
                                                        value={job.status}
                                                        onChange={(e) => updateJob(job.id, 'status', e.target.value)}
                                                        className="p-2 rounded-lg border-2 font-semibold transition-all focus:ring-2 focus:outline-none bg-transparent"
                                                        style={{
                                                            borderColor: darkMode ? themes.dark.border : currentTheme.border,
                                                            color: darkMode ? themes.dark.textPrimary : currentTheme.textPrimary
                                                        }}
                                                    >
                                                        <option value="pending">Pending</option>
                                                        <option value="in-progress">In Progress</option>
                                                        <option value="completed">Completed</option>
                                                    </select>
                                                </td>
                                                <td className="p-4">
                                                    <input
                                                        type="number"
                                                        value={job.totalPrice}
                                                        onChange={(e) => updateJob(job.id, 'totalPrice', e.target.value)}
                                                        placeholder="0.00"
                                                        className="w-28 p-2 rounded-lg border-2 transition-all focus:ring-2 focus:outline-none bg-transparent"
                                                        style={{
                                                            borderColor: darkMode ? themes.dark.border : currentTheme.border,
                                                            color: darkMode ? themes.dark.textPrimary : currentTheme.textPrimary
                                                        }}
                                                    />
                                                </td>
                                                <td className="p-4">
                                                    <input
                                                        type="number"
                                                        value={job.materialCost}
                                                        onChange={(e) => updateJob(job.id, 'materialCost', e.target.value)}
                                                        placeholder="0.00"
                                                        className="w-28 p-2 rounded-lg border-2 transition-all focus:ring-2 focus:outline-none bg-transparent"
                                                        style={{
                                                            borderColor: darkMode ? themes.dark.border : currentTheme.border,
                                                            color: darkMode ? themes.dark.textPrimary : currentTheme.textPrimary
                                                        }}
                                                    />
                                                </td>
                                                <td className="p-4">
                                                    <input
                                                        type="number"
                                                        value={job.workHours}
                                                        onChange={(e) => updateJob(job.id, 'workHours', e.target.value)}
                                                        placeholder="0"
                                                        className="w-24 p-2 rounded-lg border-2 transition-all focus:ring-2 focus:outline-none bg-transparent"
                                                        style={{
                                                            borderColor: darkMode ? themes.dark.border : currentTheme.border,
                                                            color: darkMode ? themes.dark.textPrimary : currentTheme.textPrimary
                                                        }}
                                                    />
                                                </td>
                                                <td className="p-4">
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={() => setShowMetrics(job)}
                                                            className="p-2 rounded-lg transition-all hover:scale-110 transform"
                                                            style={{ backgroundColor: currentTheme.primary }}
                                                            title="View Details"
                                                        >
                                                            <Eye size={20} color="white" />
                                                        </button>
                                                        <button
                                                            onClick={() => deleteJob(job.id)}
                                                            className="p-2 rounded-lg transition-all hover:scale-110 transform"
                                                            style={{ backgroundColor: currentTheme.danger }}
                                                            title="Delete Job"
                                                        >
                                                            <Trash2 size={20} color="white" />
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    {/* Job Details Modal */}
                    {showMetrics && (
                        <div 
                            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
                            onClick={() => setShowMetrics(null)}
                        >
                            <div 
                                className="rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto"
                                style={{
                                    backgroundColor: darkMode ? themes.dark.background : currentTheme.background
                                }}
                                onClick={(e) => e.stopPropagation()}
                            >
                                <div 
                                    className="p-6 text-white rounded-t-2xl"
                                    style={{
                                        background: `linear-gradient(135deg, ${currentTheme.primary} 0%, ${currentTheme.secondary} 100%)`
                                    }}
                                >
                                    <h2 className="text-3xl font-bold">Job Details</h2>
                                    <p className="opacity-90 mt-1">{showMetrics.clientName}</p>
                                </div>

                                <div className="p-6 space-y-6">
                                    {/* Financial Breakdown */}
                                    <div className="p-4 rounded-lg border-2" style={{ borderColor: darkMode ? themes.dark.border : currentTheme.border, backgroundColor: darkMode ? themes.dark.cardBg : currentTheme.cardBg }}>
                                        <h3 className="text-lg font-bold mb-4 flex items-center gap-2" style={{ color: darkMode ? themes.dark.textPrimary : currentTheme.textPrimary }}>
                                            💰 Financial Breakdown
                                        </h3>
                                        <div className="grid grid-cols-3 gap-4">
                                            <div>
                                                <div className="text-sm font-medium mb-1" style={{ color: darkMode ? themes.dark.textSecondary : currentTheme.textSecondary }}>Total Price</div>
                                                <div className="text-2xl font-bold" style={{ color: currentTheme.success }}>
                                                    ${(parseFloat(showMetrics.totalPrice) || 0).toFixed(2)}
                                                </div>
                                            </div>
                                            <div>
                                                <div className="text-sm font-medium mb-1" style={{ color: darkMode ? themes.dark.textSecondary : currentTheme.textSecondary }}>Material Cost</div>
                                                <div className="text-2xl font-bold" style={{ color: currentTheme.warning }}>
                                                    ${(parseFloat(showMetrics.materialCost) || 0).toFixed(2)}
                                                </div>
                                            </div>
                                            <div>
                                                <div className="text-sm font-medium mb-1" style={{ color: darkMode ? themes.dark.textSecondary : currentTheme.textSecondary }}>Labor Profit</div>
                                                <div className="text-2xl font-bold" style={{ color: currentTheme.primary }}>
                                                    ${((parseFloat(showMetrics.totalPrice) || 0) - (parseFloat(showMetrics.materialCost) || 0)).toFixed(2)}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Profit Margin */}
                                        <div className="mt-4 pt-4" style={{ borderTop: `1px solid ${darkMode ? themes.dark.border : currentTheme.border}` }}>
                                            <div className="flex justify-between items-center mb-2">
                                                <span className="text-sm font-medium" style={{ color: darkMode ? themes.dark.textSecondary : currentTheme.textSecondary }}>Profit Margin</span>
                                                <span className="text-lg font-bold" style={{ color: currentTheme.primary }}>
                                                    {(() => {
                                                        const total = parseFloat(showMetrics.totalPrice) || 0;
                                                        const material = parseFloat(showMetrics.materialCost) || 0;
                                                        return total > 0 ? (((total - material) / total) * 100).toFixed(1) : '0.0';
                                                    })()}%
                                                </span>
                                            </div>
                                            <div className="w-full bg-gray-200 rounded-full h-3">
                                                <div 
                                                    className="h-3 rounded-full transition-all duration-500"
                                                    style={{ 
                                                        width: `${(() => {
                                                            const total = parseFloat(showMetrics.totalPrice) || 0;
                                                            const material = parseFloat(showMetrics.materialCost) || 0;
                                                            return total > 0 ? ((total - material) / total) * 100 : 0;
                                                        })()}%`,
                                                        background: `linear-gradient(to right, ${currentTheme.primary}, ${currentTheme.secondary})`
                                                    }}
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    {/* Timeline */}
                                    <div className="p-4 rounded-lg border-2" style={{ borderColor: darkMode ? themes.dark.border : currentTheme.border, backgroundColor: darkMode ? themes.dark.cardBg : currentTheme.cardBg }}>
                                        <h3 className="text-lg font-bold mb-4 flex items-center gap-2" style={{ color: darkMode ? themes.dark.textPrimary : currentTheme.textPrimary }}>
                                            📅 Timeline
                                        </h3>
                                        <div className="space-y-3">
                                            <div className="flex justify-between items-center">
                                                <span style={{ color: darkMode ? themes.dark.textSecondary : currentTheme.textSecondary }}>Request Date</span>
                                                <span className="font-bold" style={{ color: darkMode ? themes.dark.textPrimary : currentTheme.textPrimary }}>
                                                    {showMetrics.requestDate || 'Not set'}
                                                </span>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <span style={{ color: darkMode ? themes.dark.textSecondary : currentTheme.textSecondary }}>Completion Date</span>
                                                <span className="font-bold" style={{ color: darkMode ? themes.dark.textPrimary : currentTheme.textPrimary }}>
                                                    {showMetrics.completionDate || 'Not set'}
                                                </span>
                                            </div>
                                            {showMetrics.requestDate && showMetrics.completionDate && (
                                                <div className="flex justify-between items-center pt-2" style={{ borderTop: `1px solid ${darkMode ? themes.dark.border : currentTheme.border}` }}>
                                                    <span style={{ color: darkMode ? themes.dark.textSecondary : currentTheme.textSecondary }}>Duration</span>
                                                    <span className="font-bold" style={{ color: currentTheme.primary }}>
                                                        {Math.ceil((new Date(showMetrics.completionDate) - new Date(showMetrics.requestDate)) / (1000 * 60 * 60 * 24))} days
                                                    </span>
                                                </div>
                                            )}
                                            <div className="flex justify-between items-center pt-2" style={{ borderTop: `1px solid ${darkMode ? themes.dark.border : currentTheme.border}` }}>
                                                <span style={{ color: darkMode ? themes.dark.textSecondary : currentTheme.textSecondary }}>Work Hours</span>
                                                <span className="font-bold" style={{ color: currentTheme.primary }}>
                                                    {parseFloat(showMetrics.workHours) || 0} hours
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Notes */}
                                    {showMetrics.notes && (
                                        <div className="p-4 rounded-lg border-2" style={{ borderColor: darkMode ? themes.dark.border : currentTheme.border, backgroundColor: darkMode ? themes.dark.cardBg : currentTheme.cardBg }}>
                                            <h3 className="text-lg font-bold mb-2 flex items-center gap-2" style={{ color: darkMode ? themes.dark.textPrimary : currentTheme.textPrimary }}>
                                                📝 Notes
                                            </h3>
                                            <p style={{ color: darkMode ? themes.dark.textSecondary : currentTheme.textSecondary }}>{showMetrics.notes}</p>
                                        </div>
                                    )}
                                </div>

                                <div className="flex justify-between items-center p-6 pt-0">
                                    <button
                                        onClick={() => {
                                            generateInvoice(showMetrics);
                                        }}
                                        className="px-8 py-4 text-white rounded-xl font-semibold transition-all duration-300 flex items-center gap-3 shadow-lg hover:shadow-xl hover:scale-105 transform"
                                        style={{
                                            background: `linear-gradient(135deg, ${currentTheme.primary} 0%, ${currentTheme.secondary} 100%)`
                                        }}
                                        onMouseEnter={(e) => {
                                            e.currentTarget.style.filter = 'brightness(1.1)';
                                        }}
                                        onMouseLeave={(e) => {
                                            e.currentTarget.style.filter = 'brightness(1)';
                                        }}
                                    >
                                        <FileText size={22} />
                                        Generate Invoice
                                    </button>
                                    <button
                                        onClick={() => setShowMetrics(null)}
                                        className="px-6 py-3 text-white rounded-xl font-medium transition-all duration-200 hover:scale-105 transform"
                                        style={{
                                            backgroundColor: darkMode ? themes.dark.textSecondary : currentTheme.textSecondary
                                        }}
                                        onMouseEnter={(e) => {
                                            e.currentTarget.style.filter = 'brightness(0.9)';
                                        }}
                                        onMouseLeave={(e) => {
                                            e.currentTarget.style.filter = 'brightness(1)';
                                        }}
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
