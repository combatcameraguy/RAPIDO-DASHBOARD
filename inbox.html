<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAPIDO Handyman Dashboard v9.3 - Taller Dual Scrollbars - Top and Bottom</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <!-- jsPDF for Invoice Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* Apply Kanit font globally */
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap');
        
        * {
            font-family: 'Kanit', sans-serif !important;
        }
        
        body {
            font-family: 'Kanit', sans-serif !important;
        }
        
        /* Force Kanit on header specifically */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Kanit', sans-serif !important;
        }
        
        /* Remove number input arrows */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Make calendar popups 2x larger */
        input[type="date"]::-webkit-calendar-picker-indicator {
            font-size: 2em;
            cursor: pointer;
        }
        
        /* Chrome/Edge calendar popup styling */
        input[type="date"]::-webkit-datetime-edit {
            padding: 0.5em;
        }
        
        /* Make the calendar dropdown itself larger in supported browsers */
        @media screen and (-webkit-min-device-pixel-ratio:0) {
            input[type="date"] {
                min-height: 2.5em;
            }
        }
        
        /* Ensure editable text inherits color from row */
        tbody tr td > div {
            color: inherit;
        }
        
        /* Visible styling for editable text fields */
        tbody tr td > div[contenteditable="true"] {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            min-height: 32px;
            cursor: text;
        }
        
        tbody tr td > div[contenteditable="true"]:hover {
            border: 1px solid rgba(59, 130, 246, 0.3);
            background-color: rgba(59, 130, 246, 0.05);
        }
        
        tbody tr td > div[contenteditable="true"]:focus {
            outline: none;
            border: 1px solid rgba(59, 130, 246, 0.6);
            background-color: rgba(59, 130, 246, 0.1);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Dark mode editable fields */
        .dark-mode tbody tr td > div[contenteditable="true"]:hover {
            border: 1px solid rgba(100, 149, 237, 0.4);
            background-color: rgba(100, 149, 237, 0.1);
        }
        
        .dark-mode tbody tr td > div[contenteditable="true"]:focus {
            border: 1px solid rgba(100, 149, 237, 0.7);
            background-color: rgba(100, 149, 237, 0.15);
            box-shadow: 0 0 0 3px rgba(100, 149, 237, 0.15);
        }
        
        /* Fix icon cutoff in Actions column - only add vertical padding */
        tbody tr td {
            vertical-align: middle;
        }
        
        /* Ensure action buttons container has proper spacing */
        tbody tr td > div.flex {
            gap: 8px;
            padding: 4px 0;
        }
        
        /* Ensure icons are properly contained and have space */
        tbody tr td button,
        tbody tr td a {
            padding: 8px;
        }
        
        tbody tr td button svg,
        tbody tr td a svg {
            display: block;
            flex-shrink: 0;
        }
        
        /* Add spacing to checkboxes from left edge */
        tbody tr td input[type="checkbox"],
        thead tr th input[type="checkbox"] {
            margin-left: 12px;
        }
        
        /* Row drag styling */
        tbody tr[draggable="true"] {
            cursor: move;
        }
        
        tbody tr[draggable="true"]:active {
            opacity: 0.5;
            cursor: grabbing;
        }
        
        /* Custom taller scrollbar styling */
        .table-scroll-container::-webkit-scrollbar {
            height: 20px;
        }
        
        .table-scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .table-scroll-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
            border: 3px solid #f1f1f1;
        }
        
        .table-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Dark mode scrollbar */
        .dark-mode .table-scroll-container::-webkit-scrollbar-track {
            background: #2d3748;
        }
        
        .dark-mode .table-scroll-container::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-color: #2d3748;
        }
        
        .dark-mode .table-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        
        /* Top scrollbar container styling */
        .top-scrollbar-container {
            overflow-x: auto;
            overflow-y: hidden;
            height: 20px;
        }
        
        .top-scrollbar-container::-webkit-scrollbar {
            height: 20px;
        }
        
        .top-scrollbar-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .top-scrollbar-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
            border: 3px solid #f1f1f1;
        }
        
        .top-scrollbar-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Dark mode top scrollbar */
        .dark-mode .top-scrollbar-container::-webkit-scrollbar-track {
            background: #2d3748;
        }
        
        .dark-mode .top-scrollbar-container::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-color: #2d3748;
        }
        
        .dark-mode .top-scrollbar-container::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        
        /* Ensure table and row backgrounds extend full width */
        table {
            min-width: 100%;
            width: max-content;
        }
        
        tbody tr,
        thead tr {
            display: table-row;
            width: 100%;
        }
        
        tbody tr[draggable="true"]:hover .grip-handle {
            opacity: 1 !important;
        }
        
        /* Smooth, slow, elegant slide down animation */
        @keyframes slideDown {
            0% {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
                max-height: 0;
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
                max-height: 600px;
            }
        }
        
        /* Fade in animation for individual buttons */
        @keyframes fadeIn {
            0% {
                opacity: 0;
                transform: translateY(-10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
            opacity: 0;
        }
        
        /* Row expansion with ultra-smooth, luxurious 1.5-second transitions */
        tbody tr {
            transition: all 1.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        /* Expanded row styling */
        tbody tr.calendar-expanded {
            background: linear-gradient(to right, rgba(59, 130, 246, 0.08), rgba(59, 130, 246, 0.04)) !important;
            box-shadow: inset 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        
        tbody tr.calendar-expanded td {
            padding-top: 2rem !important;
            padding-bottom: 2rem !important;
            vertical-align: top !important;
            transition: padding 1.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        /* Make cells take full width when expanded */
        tbody tr.calendar-expanded td > div {
            width: 100%;
        }
        
        /* Ultra-smooth 1.5-second chevron rotation with bounce */
        .chevron-rotate {
            transition: transform 1.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        /* Stylish checkbox enhancements */
        input[type="checkbox"] {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        input[type="checkbox"]:hover {
            transform: scale(1.1);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        input[type="checkbox"]:checked:hover {
            transform: scale(1.15);
        }
        
        /* Stylish collapse arrow enhancements */
        .chevron-rotate:hover {
            opacity: 0.7;
            transform: scale(1.1);
        }
        
        /* Style filter dropdown options to match row dropdowns */
        select option {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 4px;
            font-weight: 500;
        }
        
        /* Enhanced sorting arrow buttons - larger and more mobile-friendly */
        thead th button {
            font-size: 20px;
            padding: 8px;
            min-width: 36px;
            min-height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-weight: bold;
            line-height: 1;
        }
        
        thead th button:hover {
            background-color: rgba(59, 130, 246, 0.15);
            transform: scale(1.15);
        }
        
        thead th button:active {
            transform: scale(1.05);
        }
        
        /* Dark mode sorting buttons */
        .dark-mode thead th button:hover {
            background-color: rgba(100, 149, 237, 0.2);
        }
        
        /* Mobile optimization for sorting arrows */
        @media (max-width: 768px) {
            thead th button {
                font-size: 24px;
                min-width: 44px;
                min-height: 44px;
                padding: 10px;
            }
        }
        
        /* Custom taller scrollbar styling */
        .table-scroll-container::-webkit-scrollbar,
        .top-scrollbar::-webkit-scrollbar {
            height: 20px;
        }
        
        .table-scroll-container::-webkit-scrollbar-track,
        .top-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .dark-mode .table-scroll-container::-webkit-scrollbar-track,
        .dark-mode .top-scrollbar::-webkit-scrollbar-track {
            background: #2d3748;
        }
        
        .table-scroll-container::-webkit-scrollbar-thumb,
        .top-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        
        .table-scroll-container::-webkit-scrollbar-thumb:hover,
        .top-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .dark-mode .table-scroll-container::-webkit-scrollbar-thumb,
        .dark-mode .top-scrollbar::-webkit-scrollbar-thumb {
            background: #4a5568;
        }
        
        .dark-mode .table-scroll-container::-webkit-scrollbar-thumb:hover,
        .dark-mode .top-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;

        // Lucide Icons as inline SVG components
        const ChevronDown = () => <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="m6 9 6 6 6-6"/></svg>;
        const ChevronRight = () => <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="m9 18 6-6-6-6"/></svg>;
        const Plus = ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12h14"/><path d="M12 5v14"/></svg>;
        const MoreHorizontal = ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>;
        const GripVertical = ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>;
        const X = ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>;
        const Save = ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
        const Download = ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>;
        const FileText = ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>;
        const Trash2 = ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;
        const Calendar = ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>;
        const Search = ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>;
        const Filter = ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>;
        const Moon = ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>;
        const Sun = ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>;
        const Settings = ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>;
        const Eye = ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>;
        const EyeOff = ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>;
        const Palette = ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></svg>;
        const User = ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const Bell = ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>;
        const Lock = ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>;
        const Database = ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></svg>;
        const Upload = ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 14 12 9 7 14"/><line x1="12" x2="12" y1="9" y2="21"/></svg>;
        const BarChart = ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>;
        const RefreshCw = ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>;
        const Check = ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>;

        // Inline Dropdown Component (like InlineCalendar but for selects)
        const InlineDropdown = ({ value, onChange, options, darkMode, onToggle, isExpanded, columnId, getColorFunc }) => {
            const handleOptionClick = (option) => {
                onChange(option);
                onToggle();
            };

            const getDisplayColor = () => {
                if (columnId === 'status' && getColorFunc) {
                    return getColorFunc(value);
                } else if (columnId === 'priority' && getColorFunc) {
                    return getColorFunc(value);
                }
                return darkMode ? '#334155' : '#dbeafe';
            };

            return (
                <div className="w-full">
                    <button
                        onClick={onToggle}
                        className="w-full px-3 py-2 text-left rounded-lg text-sm font-medium transition-all duration-200 flex items-center justify-between"
                        style={{
                            backgroundColor: getDisplayColor(),
                            color: 'white'
                        }}
                    >
                        <span>{value || 'Select'}</span>
                        <div className={`chevron-rotate ${isExpanded ? 'rotate-180' : ''}`}>
                            <ChevronDown />
                        </div>
                    </button>

                    {isExpanded && (
                        <div 
                            className={`mt-3 p-2 rounded-lg shadow-lg border ${
                                darkMode 
                                    ? 'bg-slate-800 border-slate-600' 
                                    : 'bg-white border-blue-200'
                            }`}
                            style={{
                                animation: 'slideDown 2s cubic-bezier(0.34, 1.56, 0.64, 1)'
                            }}
                        >
                            <div className="space-y-2">
                                {options.map((option, index) => {
                                    const optionColor = columnId === 'status' && getColorFunc 
                                        ? getColorFunc(option)
                                        : columnId === 'priority' && getColorFunc
                                        ? getColorFunc(option)
                                        : (darkMode ? '#475569' : '#e0f2fe');
                                    
                                    return (
                                        <button
                                            key={option}
                                            onClick={() => handleOptionClick(option)}
                                            className="w-full px-4 py-3 rounded-lg text-left text-sm font-medium transition-all duration-200 hover:scale-105 animate-fade-in"
                                            style={{
                                                backgroundColor: optionColor,
                                                color: 'white',
                                                animationDelay: `${index * 0.1}s`
                                            }}
                                        >
                                            {option}
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDvYPFm6PtVXKc01Uo1_CMGqrWFp_oXbm0",
            authDomain: "rapido-dashboard.firebaseapp.com",
            databaseURL: "https://rapido-dashboard-default-rtdb.firebaseio.com",
            projectId: "rapido-dashboard",
            storageBucket: "rapido-dashboard.firebasestorage.app",
            messagingSenderId: "917389932203",
            appId: "1:917389932203:web:972f35509e0cb4d9ee69ee"
        };

        // Initialize Firebase
        let database;
        let auth;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            auth = firebase.auth();
            console.log('✅ Firebase initialized successfully');
        } catch (error) {
            console.error('❌ Firebase initialization error:', error);
        }

        // Theme definitions
        const colorThemes = {
            sunset: {
                name: 'Sunset Orange',
                primary: '#f97316',
                secondary: '#fb923c',
                accent: '#ea580c',
                background: '#fff7ed',
                cardBg: '#ffffff',
                headerBg: 'linear-gradient(135deg, #f97316 0%, #fb923c 100%)',
                textPrimary: '#7c2d12',
                textSecondary: '#c2410c',
                border: '#fed7aa',
                hover: '#ffedd5',
                success: '#10b981',
                warning: '#f59e0b',
                error: '#ef4444'
            },
            bubblegum: {
                name: 'Bubblegum Fantasy',
                primary: '#42BFDD',
                secondary: '#FF66B3',
                accent: '#084B83',
                background: '#F0F6F6',
                cardBg: '#ffffff',
                headerBg: 'linear-gradient(135deg, #42BFDD 0%, #FF66B3 100%)',
                textPrimary: '#084B83',
                textSecondary: '#42BFDD',
                border: '#BBE6E4',
                hover: '#BBE6E4',
                success: '#10b981',
                warning: '#f59e0b',
                error: '#ef4444'
            },
            goldenspice: {
                name: 'Golden Spice',
                primary: '#D5AC4E',
                secondary: '#8B6220',
                accent: '#720E07',
                background: '#FFF8F0',
                cardBg: '#ffffff',
                headerBg: 'linear-gradient(135deg, #EECF6D 0%, #8B6220 100%)',
                textPrimary: '#45050C',
                textSecondary: '#720E07',
                border: '#EECF6D',
                hover: '#FFF3E0',
                success: '#10b981',
                warning: '#f59e0b',
                error: '#ef4444'
            },
            deepsea: {
                name: 'Deep Sea Adventure',
                primary: '#2892D7',
                secondary: '#6DAEDB',
                accent: '#173753',
                background: '#F0F8FF',
                cardBg: '#ffffff',
                headerBg: 'linear-gradient(135deg, #173753 0%, #2892D7 100%)',
                textPrimary: '#173753',
                textSecondary: '#1B4353',
                border: '#6DAEDB',
                hover: '#E8F4F8',
                success: '#10b981',
                warning: '#f59e0b',
                error: '#ef4444'
            },
            freshforest: {
                name: 'Fresh Forest Foliage',
                primary: '#659B5E',
                secondary: '#95BF74',
                accent: '#556F44',
                background: '#F5FBF5',
                cardBg: '#ffffff',
                headerBg: 'linear-gradient(135deg, #99DDC8 0%, #659B5E 100%)',
                textPrimary: '#283F3B',
                textSecondary: '#556F44',
                border: '#99DDC8',
                hover: '#E8F5E9',
                success: '#10b981',
                warning: '#f59e0b',
                error: '#ef4444'
            },
            oceanbliss: {
                name: 'Ocean Bliss',
                primary: '#2CA58D',
                secondary: '#84BC9C',
                accent: '#0A2342',
                background: '#F0FFFD',
                cardBg: '#ffffff',
                headerBg: 'linear-gradient(135deg, #0A2342 0%, #2CA58D 100%)',
                textPrimary: '#0A2342',
                textSecondary: '#1B4353',
                border: '#84BC9C',
                hover: '#E0F7F4',
                success: '#10b981',
                warning: '#f59e0b',
                error: '#F46197'
            },
            tropicalfusion: {
                name: 'Tropical Fusion',
                primary: '#FF8811',
                secondary: '#F4D06F',
                accent: '#9DD9D2',
                background: '#FFFBF5',
                cardBg: '#ffffff',
                headerBg: 'linear-gradient(135deg, #FF8811 0%, #F4D06F 100%)',
                textPrimary: '#392F5A',
                textSecondary: '#9DD9D2',
                border: '#F4D06F',
                hover: '#FFF8F0',
                success: '#10b981',
                warning: '#f59e0b',
                error: '#ef4444'
            },
            osu: {
                name: 'OSU',
                primary: '#B84C00',
                secondary: '#ECECEC',
                accent: '#3B7B13',
                background: '#FFF9EE',
                cardBg: '#ffffff',
                headerBg: 'linear-gradient(135deg, #B84C00 0%, #313131 100%)',
                textPrimary: '#313131',
                textSecondary: '#B84C00',
                border: '#ECECEC',
                hover: '#FFF9EE',
                success: '#3B7B13',
                warning: '#f59e0b',
                error: '#ef4444'
            },
            ou: {
                name: 'OU',
                primary: '#841617',
                secondary: '#ECECEC',
                accent: '#3B7B13',
                background: '#FFF9EE',
                cardBg: '#ffffff',
                headerBg: 'linear-gradient(135deg, #841617 0%, #313131 100%)',
                textPrimary: '#313131',
                textSecondary: '#841617',
                border: '#ECECEC',
                hover: '#FFF9EE',
                success: '#3B7B13',
                warning: '#f59e0b',
                error: '#ef4444'
            },
            dallascowboys: {
                name: 'Dallas',
                primary: '#00426E',
                secondary: '#C0DCF0',
                accent: '#3B7B13',
                background: '#FFFFFF',
                cardBg: '#ffffff',
                headerBg: 'linear-gradient(135deg, #00426E 0%, #9F9F9F 100%)',
                textPrimary: '#2F2F2F',
                textSecondary: '#9F9F9F',
                border: '#C0DCF0',
                hover: '#C0DCF0',
                success: '#3B7B13',
                warning: '#f59e0b',
                error: '#ef4444'
            }
        };

        // Track default theme keys for sync logic
        const defaultThemeKeys = Object.keys(colorThemes);

        // Dark mode theme overrides
        const darkThemeOverrides = {
            background: '#0f172a',
            cardBg: '#1e293b',
            textPrimary: '#f1f5f9',
            textSecondary: '#cbd5e1',
            border: '#334155',
            hover: '#334155'
        };

        // Inline Calendar Component
        const InlineCalendar = ({ value, onChange, darkMode, onToggle, isExpanded }) => {
            const formatDate = (dateStr) => {
                if (!dateStr) return '';
                const date = new Date(dateStr + 'T00:00:00');
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            };

            const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
            const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();

            const currentDate = value ? new Date(value + 'T00:00:00') : new Date();
            const [viewYear, setViewYear] = useState(currentDate.getFullYear());
            const [viewMonth, setViewMonth] = useState(currentDate.getMonth());

            const daysInMonth = getDaysInMonth(viewYear, viewMonth);
            const firstDay = getFirstDayOfMonth(viewYear, viewMonth);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const handleDateClick = (day) => {
                const selectedDate = new Date(viewYear, viewMonth, day);
                const dateStr = selectedDate.toISOString().split('T')[0];
                onChange(dateStr);
                onToggle();
            };

            const handlePrevMonth = () => {
                if (viewMonth === 0) {
                    setViewMonth(11);
                    setViewYear(viewYear - 1);
                } else {
                    setViewMonth(viewMonth - 1);
                }
            };

            const handleNextMonth = () => {
                if (viewMonth === 11) {
                    setViewMonth(0);
                    setViewYear(viewYear + 1);
                } else {
                    setViewMonth(viewMonth + 1);
                }
            };

            return (
                <div className="w-full">
                    <button
                        onClick={onToggle}
                        className={`w-full px-3 py-2 text-left rounded-lg text-sm font-medium transition-all duration-200 flex items-center justify-between ${
                            darkMode 
                                ? 'bg-slate-700 hover:bg-slate-600 text-slate-100' 
                                : 'bg-blue-50 hover:bg-blue-100 text-blue-900'
                        }`}
                    >
                        <span className="flex items-center gap-2">
                            <Calendar size={14} />
                            {value ? formatDate(value) : 'Select date'}
                        </span>
                        <div className={`chevron-rotate ${isExpanded ? 'rotate-180' : ''}`}>
                            <ChevronDown />
                        </div>
                    </button>

                    {isExpanded && (
                        <div 
                            className={`mt-3 p-4 rounded-lg shadow-lg border ${
                                darkMode 
                                    ? 'bg-slate-800 border-slate-600' 
                                    : 'bg-white border-blue-200'
                            }`}
                            style={{
                                animation: 'slideDown 2s cubic-bezier(0.34, 1.56, 0.64, 1)',
                                width: '350px',
                                minWidth: '350px'
                            }}
                        >
                            <div className="flex items-center justify-between mb-4">
                                <button
                                    onClick={handlePrevMonth}
                                    className={`p-2 rounded-lg ${
                                        darkMode 
                                            ? 'hover:bg-slate-700 text-slate-300' 
                                            : 'hover:bg-blue-50 text-blue-600'
                                    }`}
                                >
                                    <ChevronRight style={{ transform: 'rotate(180deg)' }} />
                                </button>
                                <div className={`font-semibold ${darkMode ? 'text-slate-100' : 'text-blue-900'}`}>
                                    {new Date(viewYear, viewMonth).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                                </div>
                                <button
                                    onClick={handleNextMonth}
                                    className={`p-2 rounded-lg ${
                                        darkMode 
                                            ? 'hover:bg-slate-700 text-slate-300' 
                                            : 'hover:bg-blue-50 text-blue-600'
                                    }`}
                                >
                                    <ChevronRight />
                                </button>
                            </div>

                            <div className="grid grid-cols-7 gap-1 mb-2">
                                {['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'].map(day => (
                                    <div 
                                        key={day} 
                                        className={`text-center text-xs font-semibold py-2 ${
                                            darkMode ? 'text-slate-400' : 'text-blue-600'
                                        }`}
                                    >
                                        {day}
                                    </div>
                                ))}
                            </div>

                            <div className="grid grid-cols-7 gap-1">
                                {Array.from({ length: firstDay }).map((_, i) => (
                                    <div key={`empty-${i}`} className="aspect-square" />
                                ))}
                                {Array.from({ length: daysInMonth }).map((_, i) => {
                                    const day = i + 1;
                                    const dateObj = new Date(viewYear, viewMonth, day);
                                    dateObj.setHours(0, 0, 0, 0);
                                    const isToday = dateObj.getTime() === today.getTime();
                                    const isSelected = value && dateObj.toISOString().split('T')[0] === value;

                                    return (
                                        <button
                                            key={day}
                                            onClick={() => handleDateClick(day)}
                                            className={`aspect-square flex items-center justify-center rounded-lg text-sm font-medium transition-all duration-200 ${
                                                isSelected
                                                    ? darkMode
                                                        ? 'bg-blue-600 text-white'
                                                        : 'bg-blue-600 text-white'
                                                    : isToday
                                                    ? darkMode
                                                        ? 'bg-slate-700 text-blue-400 ring-2 ring-blue-500'
                                                        : 'bg-blue-50 text-blue-600 ring-2 ring-blue-500'
                                                    : darkMode
                                                    ? 'hover:bg-slate-700 text-slate-300'
                                                    : 'hover:bg-blue-50 text-blue-900'
                                            }`}
                                        >
                                            {day}
                                        </button>
                                    );
                                })}
                            </div>

                            {value && (
                                <button
                                    onClick={() => {
                                        onChange('');
                                        onToggle();
                                    }}
                                    className={`w-full mt-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 ${
                                        darkMode
                                            ? 'bg-slate-700 hover:bg-slate-600 text-slate-300'
                                            : 'bg-red-50 hover:bg-red-100 text-red-600'
                                    }`}
                                >
                                    Clear Date
                                </button>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        function App() {
            // State management
            const [tasks, setTasks] = useState([]);
            const [initialLoadComplete, setInitialLoadComplete] = useState(false);
            const [firebaseSynced, setFirebaseSynced] = useState(false);
            const [isLoadingFromFirebase, setIsLoadingFromFirebase] = useState(true);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [authError, setAuthError] = useState('');
            const [collapsedGroups, setCollapsedGroups] = useState({});
            const [searchTerm, setSearchTerm] = useState('');
            const [filterStatus, setFilterStatus] = useState('all');
            const [sortConfig, setSortConfig] = useState({ key: null, direction: 'asc' });
            const [deleteConfirm, setDeleteConfirm] = useState(null);
            const [settings, setSettings] = useState({
                darkMode: false,
                currentTheme: 'sunset',
                showSettings: false,
                columnOrder: ['task', 'invoiceNumber', 'client', 'phone', 'email', 'address', 'requestDate', 'completionDate', 'status', 'priority', 'totalPrice', 'materialCost', 'workHours', 'notes', 'actions'],
                columnWidths: {
                    task: 200,
                    invoiceNumber: 120,
                    client: 150,
                    phone: 140,
                    email: 200,
                    address: 200,
                    requestDate: 150,
                    completionDate: 150,
                    status: 120,
                    priority: 120,
                    totalPrice: 120,
                    materialCost: 120,
                    workHours: 110,
                    notes: 200,
                    actions: 250
                },
                hiddenColumns: []
            });
            const [expandedDropdown, setExpandedDropdown] = useState(null);
            const [showFilterDropdown, setShowFilterDropdown] = useState(false);
            const [selectedTasks, setSelectedTasks] = useState(new Set());
            const [draggedColumn, setDraggedColumn] = useState(null);
            const [draggedRow, setDraggedRow] = useState(null);
            const [resizingColumn, setResizingColumn] = useState(null);
            const [resizeStartX, setResizeStartX] = useState(0);
            const [resizeStartWidth, setResizeStartWidth] = useState(0);
            const [apiConnected, setApiConnected] = useState(false);
            const [newRequests, setNewRequests] = useState([]);
            const [showNewRequests, setShowNewRequests] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [showMetrics, setShowMetrics] = useState(null);
            const [showCustomThemeCreator, setShowCustomThemeCreator] = useState(false);
            const [customThemeNames, setCustomThemeNames] = useState([]);
            const [exportFormat, setExportFormat] = useState('csv'); // 'csv' or 'quickbooks'
            const [customTheme, setCustomTheme] = useState({
                name: '',
                primary: '#3b82f6',
                secondary: '#8b5cf6',
                accent: '#10b981',
                background: '#ffffff',
                cardBg: '#ffffff',
                headerBg: 'linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%)',
                textPrimary: '#1f2937',
                textSecondary: '#6b7280',
                border: '#e5e7eb',
                hover: '#f3f4f6',
                success: '#10b981',
                warning: '#f59e0b',
                error: '#ef4444'
            });

            // Refs for scroll synchronization
            const topScrollRef = React.useRef(null);
            const bottomScrollRef = React.useRef(null);

            // Column definitions
            const columns = {
                task: { label: 'Task', type: 'text', editable: true, sortable: false },
                invoiceNumber: { label: 'Invoice #', type: 'text', editable: true, sortable: true },
                client: { label: 'Client', type: 'text', editable: true, sortable: false },
                phone: { label: 'Phone', type: 'text', editable: true, sortable: false },
                email: { label: 'Email', type: 'text', editable: true, sortable: false },
                address: { label: 'Address', type: 'text', editable: true, sortable: false },
                requestDate: { label: 'Request Date', type: 'date', editable: false, sortable: true },
                completionDate: { label: 'Completion Date', type: 'date', editable: false, sortable: true },
                status: { 
                    label: 'Status', 
                    type: 'select', 
                    options: ['Pending', 'In Progress', 'Completed', 'On Hold'],
                    editable: true,
                    sortable: false
                },
                priority: { 
                    label: 'Priority', 
                    type: 'select', 
                    options: ['Low', 'Medium', 'High', 'Urgent'],
                    editable: true,
                    sortable: false
                },
                totalPrice: { label: 'Total Price', type: 'number', editable: true, sortable: false },
                materialCost: { label: 'Material Cost', type: 'number', editable: true, sortable: true },
                workHours: { label: 'Work Hours', type: 'number', editable: true, sortable: false },
                notes: { label: 'Notes', type: 'text', editable: true, sortable: false },
                actions: { label: 'Actions', type: 'actions', editable: false, sortable: false }
            };

            // Get current theme
            const currentTheme = settings.darkMode 
                ? { ...colorThemes[settings.currentTheme], ...darkThemeOverrides }
                : colorThemes[settings.currentTheme];

            // Color functions
            const getStatusColor = (status) => {
                switch(status) {
                    case 'Completed': return currentTheme.success;
                    case 'In Progress': return currentTheme.primary;
                    case 'On Hold': return currentTheme.warning;
                    case 'Pending': return currentTheme.secondary;
                    default: return currentTheme.border;
                }
            };

            const getPriorityColor = (priority) => {
                switch(priority) {
                    case 'Urgent': return currentTheme.error;
                    case 'High': return currentTheme.warning;
                    case 'Medium': return currentTheme.primary;
                    case 'Low': return currentTheme.success;
                    default: return currentTheme.border;
                }
            };

            // Authentication listener
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                    if (currentUser) {
                        console.log('✅ User authenticated:', currentUser.email);
                    }
                });
                return () => unsubscribe();
            }, []);

            // Scroll synchronization between top and bottom scrollbars
            useEffect(() => {
                const topScroll = topScrollRef.current;
                const bottomScroll = bottomScrollRef.current;
                
                if (!topScroll || !bottomScroll) return;
                
                // Sync the width of top scrollbar's inner content to match table width
                const syncWidth = () => {
                    const innerDiv = topScroll.querySelector('div');
                    if (innerDiv && bottomScroll.scrollWidth) {
                        innerDiv.style.width = `${bottomScroll.scrollWidth}px`;
                    }
                };
                
                // Initial sync
                syncWidth();
                
                // Sync on window resize
                window.addEventListener('resize', syncWidth);
                
                // Sync scroll positions
                const handleTopScroll = () => {
                    bottomScroll.scrollLeft = topScroll.scrollLeft;
                };
                
                const handleBottomScroll = () => {
                    topScroll.scrollLeft = bottomScroll.scrollLeft;
                };
                
                topScroll.addEventListener('scroll', handleTopScroll);
                bottomScroll.addEventListener('scroll', handleBottomScroll);
                
                // Observe changes to the table that might affect width
                const observer = new MutationObserver(syncWidth);
                observer.observe(bottomScroll, { childList: true, subtree: true, attributes: true });
                
                return () => {
                    window.removeEventListener('resize', syncWidth);
                    topScroll.removeEventListener('scroll', handleTopScroll);
                    bottomScroll.removeEventListener('scroll', handleBottomScroll);
                    observer.disconnect();
                };
            }, []);

            // Load data with Firebase-FIRST priority (Cloud is source of truth)
            useEffect(() => {
                // Helper function to migrate settings structure
                const migrateSettings = (parsedSettings) => {
                    // Migrate settings to include address column if missing
                    if (!parsedSettings.columnOrder.includes('address')) {
                        const clientIndex = parsedSettings.columnOrder.indexOf('client');
                        parsedSettings.columnOrder.splice(clientIndex + 1, 0, 'address');
                    }
                    
                    if (!parsedSettings.columnWidths.address) {
                        parsedSettings.columnWidths.address = 200;
                    }
                    
                    // Migrate settings to include workHours column if missing
                    if (!parsedSettings.columnOrder.includes('workHours')) {
                        const materialCostIndex = parsedSettings.columnOrder.indexOf('materialCost');
                        if (materialCostIndex !== -1) {
                            parsedSettings.columnOrder.splice(materialCostIndex + 1, 0, 'workHours');
                        }
                    }
                    
                    if (!parsedSettings.columnWidths.workHours) {
                        parsedSettings.columnWidths.workHours = 110;
                    }
                    
                    // Migrate settings to include invoiceNumber column if missing
                    if (!parsedSettings.columnOrder.includes('invoiceNumber')) {
                        const taskIndex = parsedSettings.columnOrder.indexOf('task');
                        if (taskIndex !== -1) {
                            parsedSettings.columnOrder.splice(taskIndex + 1, 0, 'invoiceNumber');
                        }
                    }
                    
                    if (!parsedSettings.columnWidths.invoiceNumber) {
                        parsedSettings.columnWidths.invoiceNumber = 120;
                    }
                    
                    // Migrate settings to include phone column if missing
                    if (!parsedSettings.columnOrder.includes('phone')) {
                        const clientIndex = parsedSettings.columnOrder.indexOf('client');
                        if (clientIndex !== -1) {
                            parsedSettings.columnOrder.splice(clientIndex + 1, 0, 'phone');
                        }
                    }
                    
                    if (!parsedSettings.columnWidths.phone) {
                        parsedSettings.columnWidths.phone = 140;
                    }
                    
                    // Migrate settings to include email column if missing
                    if (!parsedSettings.columnOrder.includes('email')) {
                        const phoneIndex = parsedSettings.columnOrder.indexOf('phone');
                        if (phoneIndex !== -1) {
                            parsedSettings.columnOrder.splice(phoneIndex + 1, 0, 'email');
                        }
                    }
                    
                    if (!parsedSettings.columnWidths.email) {
                        parsedSettings.columnWidths.email = 180;
                    }
                    
                    // Migrate settings to include notes column if missing
                    if (!parsedSettings.columnOrder.includes('notes')) {
                        const workHoursIndex = parsedSettings.columnOrder.indexOf('workHours');
                        const actionsIndex = parsedSettings.columnOrder.indexOf('actions');
                        // Insert notes after workHours, or before actions if workHours not found
                        if (workHoursIndex !== -1) {
                            parsedSettings.columnOrder.splice(workHoursIndex + 1, 0, 'notes');
                        } else if (actionsIndex !== -1) {
                            parsedSettings.columnOrder.splice(actionsIndex, 0, 'notes');
                        } else {
                            parsedSettings.columnOrder.push('notes');
                        }
                    }
                    
                    if (!parsedSettings.columnWidths.notes) {
                        parsedSettings.columnWidths.notes = 200;
                    }
                    
                    // Ensure email and phone are never hidden
                    if (parsedSettings.hiddenColumns) {
                        parsedSettings.hiddenColumns = parsedSettings.hiddenColumns.filter(
                            col => col !== 'email' && col !== 'phone'
                        );
                    }
                    
                    return parsedSettings;
                };

                // Fallback: Load from localStorage ONLY if Firebase doesn't have data
                const loadLocalAsBackup = () => {
                    console.log('📦 Loading from localStorage as backup...');
                    const savedSettings = localStorage.getItem('rapidoSettings');
                    if (savedSettings) {
                        const parsedSettings = migrateSettings(JSON.parse(savedSettings));
                        setSettings(prev => ({ ...prev, ...parsedSettings }));
                    }

                    const localTasks = localStorage.getItem('rapidoTasks');
                    if (localTasks) {
                        const parsed = JSON.parse(localTasks);
                        setTasks(parsed);
                        console.log('💾 Loaded from localStorage:', parsed.length, 'tasks');
                    }
                    
                    setIsLoadingFromFirebase(false);
                };

                // PRIORITY 1: Set up Firebase listeners if user is logged in
                if (database && user) {
                    console.log('☁️ Firebase-First: Waiting for cloud data...');
                    let firebaseDataReceived = false;
                    
                    // Tasks listener - Firebase data is PRIMARY source
                    const tasksRef = database.ref(`users/${user.uid}/tasks`);
                    const tasksListener = tasksRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        firebaseDataReceived = true;
                        
                        if (data && Array.isArray(data)) {
                            // Migrate tasks to include all required fields
                            const migratedTasks = data.map((task, index) => {
                                let invoiceNum = task.invoiceNumber;
                                if (!invoiceNum) {
                                    const date = task.requestDate ? new Date(task.requestDate) : new Date();
                                    invoiceNum = date.toLocaleDateString('en-US', { 
                                        year: '2-digit', 
                                        month: '2-digit', 
                                        day: '2-digit' 
                                    }).replace(/\//g, '') + '-' + String(index + 1).padStart(4, '0');
                                }
                                return {
                                    ...task,
                                    address: task.address || '',
                                    workHours: task.workHours !== undefined ? task.workHours : 0,
                                    invoiceNumber: invoiceNum
                                };
                            });
                            setTasks(migratedTasks);
                            localStorage.setItem('rapidoTasks', JSON.stringify(migratedTasks));
                            console.log('✅ Firebase data loaded:', migratedTasks.length, 'tasks');
                            setFirebaseSynced(true);
                            setIsLoadingFromFirebase(false);
                            if (!initialLoadComplete) {
                                setInitialLoadComplete(true);
                            }
                        } else {
                            // No Firebase data - use localStorage as backup
                            console.log('⚠️ No Firebase data found, checking localStorage...');
                            loadLocalAsBackup();
                            if (!initialLoadComplete) {
                                setInitialLoadComplete(true);
                                setFirebaseSynced(true);
                            }
                        }
                    });

                    // Settings listener - Firebase data is PRIMARY source
                    const settingsRef = database.ref(`users/${user.uid}/settings`);
                    const settingsListener = settingsRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            const migratedData = migrateSettings(data);
                            setSettings(prev => ({ ...prev, ...migratedData }));
                            localStorage.setItem('rapidoSettings', JSON.stringify(migratedData));
                            console.log('✅ Firebase settings loaded');
                        }
                    });

                    // Custom themes listener
                    const customThemesRef = database.ref(`users/${user.uid}/customThemes`);
                    const customThemesListener = customThemesRef.on('value', (snapshot) => {
                        const themesData = snapshot.val();
                        
                        // First, remove all custom themes (non-default themes) from colorThemes
                        // This ensures deleted themes are removed across all browsers
                        Object.keys(colorThemes).forEach(themeName => {
                            if (!defaultThemeKeys.includes(themeName)) {
                                delete colorThemes[themeName];
                            }
                        });
                        
                        // Then add current custom themes from Firebase
                        if (themesData) {
                            Object.keys(themesData).forEach(themeName => {
                                colorThemes[themeName] = themesData[themeName];
                            });
                            console.log('🎨 Custom themes synced from Firebase');
                        } else {
                            console.log('🎨 No custom themes in Firebase');
                        }
                    });

                    // Custom theme names listener
                    const customThemeNamesRef = database.ref(`users/${user.uid}/customThemeNames`);
                    const customThemeNamesListener = customThemeNamesRef.on('value', (snapshot) => {
                        const names = snapshot.val();
                        if (names && Array.isArray(names)) {
                            setCustomThemeNames(names);
                            console.log('🎨 Custom theme names loaded from Firebase:', names.length);
                        }
                    });

                    // Cleanup listener on unmount
                    return () => {
                        console.log('🔌 Disconnecting Firebase listeners');
                        tasksRef.off('value', tasksListener);
                        settingsRef.off('value', settingsListener);
                        customThemesRef.off('value', customThemesListener);
                        customThemeNamesRef.off('value', customThemeNamesListener);
                    };
                } else {
                    // PRIORITY 2: Not logged in - use localStorage
                    console.log('👤 Not logged in, using localStorage');
                    loadLocalAsBackup();
                }
            }, [user]);

            // Save data to Firebase and localStorage (COMCAM pattern)
            useEffect(() => {
                try {
                    localStorage.setItem('rapidoTasks', JSON.stringify(tasks));
                    // Only save to Firebase if initial load is complete and user is authenticated
                    if (database && user && initialLoadComplete && tasks.length >= 0) {
                        database.ref(`users/${user.uid}/tasks`).set(tasks);
                        console.log('💾 Tasks saved to Firebase');
                    }
                } catch (error) {
                    console.error('Error saving tasks:', error);
                }
            }, [tasks, initialLoadComplete, user]);

            useEffect(() => {
                localStorage.setItem('rapidoSettings', JSON.stringify(settings));
                // Also save to Firebase if initial load is complete and user is authenticated
                if (database && user && initialLoadComplete) {
                    database.ref(`users/${user.uid}/settings`).set(settings);
                    console.log('💾 Settings saved to Firebase');
                }
            }, [settings, initialLoadComplete, user]);

            // Sync custom themes to Firebase
            useEffect(() => {
                if (database && user && initialLoadComplete && customThemeNames.length >= 0) {
                    // Save custom theme names
                    database.ref(`users/${user.uid}/customThemeNames`).set(customThemeNames);
                    
                    // Save custom theme data
                    const customThemesData = {};
                    customThemeNames.forEach(themeName => {
                        if (colorThemes[themeName]) {
                            customThemesData[themeName] = colorThemes[themeName];
                        }
                    });
                    database.ref(`users/${user.uid}/customThemes`).set(customThemesData);
                    console.log('🎨 Custom themes saved to Firebase');
                }
            }, [customThemeNames, initialLoadComplete, user]);

            // Login function
            const handleLogin = async (e) => {
                e.preventDefault();
                setAuthError('');
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    console.error('Login error:', error);
                    setAuthError(error.message);
                }
            };

            // Logout function
            const handleLogout = async () => {
                try {
                    await auth.signOut();
                    setTasks([]);
                    setInitialLoadComplete(false);
                    setFirebaseSynced(false);
                } catch (error) {
                    console.error('Logout error:', error);
                }
            };

            // Firebase connection check
            const checkApiConnection = useCallback(async () => {
                try {
                    const testRef = database.ref('.info/connected');
                    testRef.on('value', (snapshot) => {
                        setApiConnected(snapshot.val() === true);
                    });
                } catch (error) {
                    console.error('Firebase connection error:', error);
                    setApiConnected(false);
                }
            }, []);

            useEffect(() => {
                checkApiConnection();
            }, [checkApiConnection]);

            // Listen for new requests from Firebase
            useEffect(() => {
                if (!apiConnected) return;

                const requestsRef = database.ref('requests');
                requestsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const requests = Object.entries(data).map(([id, request]) => ({
                            id,
                            ...request
                        }));
                        setNewRequests(requests);
                    } else {
                        setNewRequests([]);
                    }
                });

                return () => requestsRef.off();
            }, [apiConnected]);

            // Manually fetch new requests from Firebase
            const fetchNewRequests = async () => {
                try {
                    if (!database) {
                        console.error('Firebase not initialized');
                        return;
                    }
                    
                    const snapshot = await database.ref('requests').once('value');
                    const data = snapshot.val();
                    
                    if (data) {
                        const requests = Object.entries(data).map(([id, request]) => ({
                            id,
                            ...request
                        }));
                        
                        // Auto-import all new requests to Pending section
                        const newTasks = [];
                        for (const request of requests) {
                            const now = new Date();
                            const invoiceNum = now.toLocaleDateString('en-US', { 
                                year: '2-digit', 
                                month: '2-digit', 
                                day: '2-digit' 
                            }).replace(/\//g, '') + '-' + now.getHours().toString().padStart(2, '0') + now.getMinutes().toString().padStart(2, '0');
                            
                            // Extract phone and email from notes/description
                            let notesText = request.notes || request.projectDescription || '';
                            let phone = '';
                            let email = '';
                            
                            // Extract phone number
                            const phoneMatch = notesText.match(/(?:Client Phone:|Phone:)\s*([0-9-]+)/i);
                            if (phoneMatch) {
                                phone = phoneMatch[1].trim();
                                notesText = notesText.replace(/(?:Client Phone:|Phone:)\s*[0-9-]+/gi, '').trim();
                            }
                            
                            // Extract email
                            const emailMatch = notesText.match(/(?:Client Email:|Email:)\s*([^\s\n]+@[^\s\n]+)/i);
                            if (emailMatch) {
                                email = emailMatch[1].trim();
                                notesText = notesText.replace(/(?:Client Email:|Email:)\s*[^\s\n]+@[^\s\n]+/gi, '').trim();
                            }
                            
                            // Extract address if in notes
                            let address = request.address || '';
                            const addressMatch = notesText.match(/(?:Service Address:|Address:)\s*([^\n]+?)(?=\n|$)/i);
                            if (addressMatch && !address) {
                                address = addressMatch[1].trim();
                                notesText = notesText.replace(/(?:Service Address:|Address:)\s*[^\n]+/gi, '').trim();
                            }
                            
                            // Clean up multiple spaces and line breaks
                            notesText = notesText.replace(/\n\s*\n/g, '\n').replace(/\s+/g, ' ').trim();
                            
                            const newTask = {
                                id: Date.now() + Math.random(),
                                task: request.task || request.projectName || 'New Request',
                                invoiceNumber: request.invoiceNumber || invoiceNum,
                                client: request.clientName || '',
                                phone: phone,
                                email: email,
                                address: address,
                                requestDate: request.requestDate || (request.submittedAt ? new Date(request.submittedAt).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]),
                                completionDate: request.completionDate || '',
                                status: 'Pending',
                                priority: request.priority || 'High',
                                totalPrice: request.totalPrice || 0,
                                materialCost: request.materialCost || 0,
                                workHours: request.workHours || 0,
                                notes: notesText,
                                isNew: true
                            };
                            
                            newTasks.push(newTask);
                            
                            // Remove from Firebase
                            try {
                                await database.ref(`requests/${request.id}`).remove();
                            } catch (err) {
                                console.error('Error removing request:', err);
                            }
                        }
                        
                        // Add all new tasks at once
                        if (newTasks.length > 0) {
                            setTasks(prev => [...prev, ...newTasks]);
                        }
                        
                        // Show count in notification
                        setNewRequests(requests);
                        
                        // Clear after short delay
                        setTimeout(() => {
                            setNewRequests([]);
                        }, 500);
                    } else {
                        setNewRequests([]);
                    }
                } catch (error) {
                    console.error('Error fetching requests from Firebase:', error);
                    setNewRequests([]);
                }
            };

            // Import request from Firebase
            const importRequest = async (request) => {
                const now = new Date();
                const invoiceNum = now.toLocaleDateString('en-US', { 
                    year: '2-digit', 
                    month: '2-digit', 
                    day: '2-digit' 
                }).replace(/\//g, '') + '-' + now.getHours().toString().padStart(2, '0') + now.getMinutes().toString().padStart(2, '0');
                
                // Extract phone and email from notes if not provided as separate fields
                let notesText = request.notes || request.projectDescription || '';
                let phone = request.phone || '';
                let email = request.email || '';
                
                if (!phone) {
                    const phoneMatch = notesText.match(/(?:Client Phone:|Phone:)\s*([0-9-]+)/i);
                    if (phoneMatch) {
                        phone = phoneMatch[1].trim();
                        notesText = notesText.replace(/(?:Client Phone:|Phone:)\s*[0-9-]+/gi, '').trim();
                    }
                }
                
                if (!email) {
                    const emailMatch = notesText.match(/(?:Client Email:|Email:)\s*([^\s\n]+@[^\s\n]+)/i);
                    if (emailMatch) {
                        email = emailMatch[1].trim();
                        notesText = notesText.replace(/(?:Client Email:|Email:)\s*[^\s\n]+@[^\s\n]+/gi, '').trim();
                    }
                }
                
                // Extract address if in notes
                let address = request.address || '';
                if (!address) {
                    const addressMatch = notesText.match(/(?:Service Address:|Address:)\s*([^\n]+?)(?=\n|$)/i);
                    if (addressMatch) {
                        address = addressMatch[1].trim();
                        notesText = notesText.replace(/(?:Service Address:|Address:)\s*[^\n]+/gi, '').trim();
                    }
                }
                
                // Clean up notes
                notesText = notesText.replace(/\n\s*\n/g, '\n').trim();
                
                const newTask = {
                    id: Date.now(),
                    task: request.task || request.projectName || '',
                    invoiceNumber: request.invoiceNumber || invoiceNum,
                    client: request.clientName || '',
                    phone: phone,
                    email: email,
                    address: address,
                    requestDate: request.requestDate || new Date(request.submittedAt).toISOString().split('T')[0],
                    completionDate: request.completionDate || '',
                    status: request.status || 'Pending',
                    priority: request.priority || 'Medium',
                    totalPrice: request.totalPrice || 0,
                    materialCost: request.materialCost || 0,
                    workHours: request.workHours || 0,
                    notes: notesText
                };

                setTasks(prev => [...prev, newTask]);

                // Remove from Firebase
                await database.ref(`requests/${request.id}`).remove();
            };

            // Dismiss request from Firebase
            const dismissRequest = async (requestId) => {
                await database.ref(`requests/${requestId}`).remove();
            };

            // Mark item as acknowledged (remove highlight)
            const acknowledgeNewItem = (id) => {
                setTasks(tasks.map(task => 
                    task.id === id ? { ...task, isNew: false } : task
                ));
            };

            // Task operations
            const addTask = () => {
                const now = new Date();
                const invoiceNum = now.toLocaleDateString('en-US', { 
                    year: '2-digit', 
                    month: '2-digit', 
                    day: '2-digit' 
                }).replace(/\//g, '') + '-' + now.getHours().toString().padStart(2, '0') + now.getMinutes().toString().padStart(2, '0');
                
                const newTask = {
                    id: Date.now(),
                    task: 'New Task',
                    invoiceNumber: invoiceNum,
                    client: '',
                    phone: '',
                    email: '',
                    address: '',
                    requestDate: new Date().toISOString().split('T')[0],
                    completionDate: '',
                    status: 'Pending',
                    priority: 'Medium',
                    totalPrice: 0,
                    materialCost: 0,
                    workHours: 0,
                    notes: ''
                };
                setTasks([...tasks, newTask]);
            };

            const updateTask = (id, field, value) => {
                setTasks(tasks.map(task => 
                    task.id === id ? { ...task, [field]: value } : task
                ));
            };

            const deleteTask = (id) => {
                setTasks(tasks.filter(task => task.id !== id));
                setDeleteConfirm(null);
            };

            const duplicateTask = (task) => {
                const newTask = { ...task, id: Date.now(), task: `${task.task} (Copy)` };
                setTasks([...tasks, newTask]);
            };

            // Save/Load Functions
            const saveBackupForDrive = () => {
                const backup = {
                    tasks: tasks,
                    settings: settings,
                    exportDate: new Date().toISOString(),
                    version: '2.9'
                };
                
                const dataStr = JSON.stringify(backup, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `rapido_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            const handleFileLoad = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const loadedData = JSON.parse(e.target.result);
                        
                        if (loadedData.tasks && Array.isArray(loadedData.tasks)) {
                            setTasks(loadedData.tasks);
                        }
                        
                        if (loadedData.settings && typeof loadedData.settings === 'object') {
                            setSettings(loadedData.settings);
                        }
                        
                        alert('✅ Data loaded successfully!');
                    } catch (error) {
                        console.error('Error loading file:', error);
                        alert('❌ Error loading file. Please make sure it\'s a valid backup file.');
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            // CSV Export Function
            const generateCSVReport = (period) => {
                const now = new Date();
                let filteredTasks = [];
                let filename = '';
                
                switch(period) {
                    case 'thisMonth':
                        const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                        filteredTasks = tasks.filter(t => t.completionDate && new Date(t.completionDate) >= thisMonthStart);
                        filename = `rapido_report_this_month_${now.toISOString().split('T')[0]}.csv`;
                        break;
                    case 'lastMonth':
                        const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
                        filteredTasks = tasks.filter(t => t.completionDate && new Date(t.completionDate) >= lastMonthStart && new Date(t.completionDate) <= lastMonthEnd);
                        filename = `rapido_report_last_month_${now.toISOString().split('T')[0]}.csv`;
                        break;
                    case 'thisQuarter':
                        const quarterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                        filteredTasks = tasks.filter(t => t.completionDate && new Date(t.completionDate) >= quarterStart);
                        filename = `rapido_report_this_quarter_${now.toISOString().split('T')[0]}.csv`;
                        break;
                    case 'lastQuarter':
                        const lastQuarterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3 - 3, 1);
                        const lastQuarterEnd = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 0);
                        filteredTasks = tasks.filter(t => t.completionDate && new Date(t.completionDate) >= lastQuarterStart && new Date(t.completionDate) <= lastQuarterEnd);
                        filename = `rapido_report_last_quarter_${now.toISOString().split('T')[0]}.csv`;
                        break;
                    case 'thisYear':
                        const yearStart = new Date(now.getFullYear(), 0, 1);
                        filteredTasks = tasks.filter(t => t.completionDate && new Date(t.completionDate) >= yearStart);
                        filename = `rapido_report_this_year_${now.toISOString().split('T')[0]}.csv`;
                        break;
                    case 'lastYear':
                        const lastYearStart = new Date(now.getFullYear() - 1, 0, 1);
                        const lastYearEnd = new Date(now.getFullYear() - 1, 11, 31);
                        filteredTasks = tasks.filter(t => t.completionDate && new Date(t.completionDate) >= lastYearStart && new Date(t.completionDate) <= lastYearEnd);
                        filename = `rapido_report_last_year_${now.toISOString().split('T')[0]}.csv`;
                        break;
                    case 'allTime':
                    default:
                        filteredTasks = tasks;
                        filename = `rapido_report_all_time_${now.toISOString().split('T')[0]}.csv`;
                }
                
                let csvContent = '';
                
                if (exportFormat === 'quickbooks') {
                    // QuickBooks format - optimized for invoice import
                    const headers = ['*Invoice #', '*Customer', '*Invoice Date', 'Due Date', '*Item(Product/Service)', 'Item Description', 'Item Quantity', 'Item Rate', 'Item Amount', 'Service Date', 'Memo'];
                    
                    const rows = filteredTasks.map(task => [
                        task.invoiceNumber || '',
                        `"${(task.client || 'Customer').replace(/"/g, '""')}"`,
                        task.completionDate || task.requestDate || '',
                        task.completionDate || '',
                        `"${(task.task || 'Service').replace(/"/g, '""')}"`,
                        `"${(task.notes || '').replace(/"/g, '""')}"`,
                        '1',
                        task.totalPrice || '0',
                        task.totalPrice || '0',
                        task.completionDate || task.requestDate || '',
                        `"${(task.address || '').replace(/"/g, '""')}"`
                    ].join(','));
                    
                    csvContent = [headers.join(','), ...rows].join('\n');
                    filename = filename.replace('.csv', '_quickbooks.csv');
                } else {
                    // Standard CSV format
                    const headers = ['Task', 'Invoice #', 'Client', 'Address', 'Request Date', 'Completion Date', 'Status', 'Priority', 'Total Price', 'Material Cost', 'Work Hours', 'Notes'];
                    
                    const rows = filteredTasks.map(task => [
                        `"${(task.task || '').replace(/"/g, '""')}"`,
                        task.invoiceNumber || '',
                        `"${(task.client || '').replace(/"/g, '""')}"`,
                        `"${(task.address || '').replace(/"/g, '""')}"`,
                        task.requestDate || '',
                        task.completionDate || '',
                        task.status || '',
                        task.priority || '',
                        task.totalPrice || '',
                        task.materialCost || '',
                        task.workHours || '',
                        `"${(task.notes || '').replace(/"/g, '""')}"`
                    ].join(','));
                    
                    csvContent = [headers.join(','), ...rows].join('\n');
                }
                
                // Download CSV
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // Toggle group collapse
            const toggleGroup = (groupKey) => {
                setCollapsedGroups(prev => ({
                    ...prev,
                    [groupKey]: !prev[groupKey]
                }));
            };

            // Sorting
            const handleSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') {
                    direction = 'desc';
                }
                setSortConfig({ key, direction });
            };

            // Filtering and sorting
            const getFilteredAndSortedTasks = () => {
                let filtered = tasks.filter(task => {
                    const matchesSearch = task.task.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                        task.client.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                        (task.address && task.address.toLowerCase().includes(searchTerm.toLowerCase()));
                    const matchesStatus = filterStatus === 'all' || task.status === filterStatus;
                    return matchesSearch && matchesStatus;
                });

                if (sortConfig.key) {
                    filtered.sort((a, b) => {
                        let aVal = a[sortConfig.key];
                        let bVal = b[sortConfig.key];

                        if (sortConfig.key === 'totalPrice' || sortConfig.key === 'materialCost') {
                            aVal = parseFloat(aVal) || 0;
                            bVal = parseFloat(bVal) || 0;
                        }

                        if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
                        if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }

                return filtered;
            };

            // Group tasks by status
            const groupedTasks = getFilteredAndSortedTasks().reduce((acc, task) => {
                const status = task.status || 'Pending';
                if (!acc[status]) acc[status] = [];
                acc[status].push(task);
                return acc;
            }, {});

            // Define status order for display
            const statusOrder = ['Pending', 'In Progress', 'On Hold', 'Completed'];
            const orderedGroupedTasks = statusOrder
                .filter(status => groupedTasks[status] && groupedTasks[status].length > 0)
                .map(status => [status, groupedTasks[status]]);

            // Checkbox operations
            const toggleTaskSelection = (taskId) => {
                setSelectedTasks(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(taskId)) {
                        newSet.delete(taskId);
                    } else {
                        newSet.add(taskId);
                    }
                    return newSet;
                });
            };

            const toggleAllTasks = () => {
                const allTaskIds = getFilteredAndSortedTasks().map(t => t.id);
                if (selectedTasks.size === allTaskIds.length) {
                    setSelectedTasks(new Set());
                } else {
                    setSelectedTasks(new Set(allTaskIds));
                }
            };

            // Bulk operations
            const bulkDelete = () => {
                if (selectedTasks.size === 0) return;
                if (confirm(`Delete ${selectedTasks.size} selected tasks?`)) {
                    setTasks(tasks.filter(task => !selectedTasks.has(task.id)));
                    setSelectedTasks(new Set());
                }
            };

            const bulkUpdateStatus = (newStatus) => {
                if (selectedTasks.size === 0) return;
                setTasks(tasks.map(task => 
                    selectedTasks.has(task.id) ? { ...task, status: newStatus } : task
                ));
            };

            // Column drag and drop
            const handleColumnDragStart = (e, columnId) => {
                setDraggedColumn(columnId);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleColumnDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleColumnDrop = (e, targetColumnId) => {
                e.preventDefault();
                
                if (draggedColumn === targetColumnId) return;

                const newOrder = [...settings.columnOrder];
                const draggedIndex = newOrder.indexOf(draggedColumn);
                const targetIndex = newOrder.indexOf(targetColumnId);

                newOrder.splice(draggedIndex, 1);
                newOrder.splice(targetIndex, 0, draggedColumn);

                setSettings(prev => ({ ...prev, columnOrder: newOrder }));
                setDraggedColumn(null);
            };

            // Row drag and drop
            const handleRowDragStart = (e, taskId) => {
                setDraggedRow(taskId);
                e.dataTransfer.effectAllowed = 'move';
                e.currentTarget.style.opacity = '0.5';
            };

            const handleRowDragEnd = (e) => {
                e.currentTarget.style.opacity = '1';
                setDraggedRow(null);
            };

            const handleRowDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleRowDrop = (e, targetTaskId, targetStatus) => {
                e.preventDefault();
                
                if (!draggedRow || draggedRow === targetTaskId) return;

                const newTasks = [...tasks];
                const draggedIndex = newTasks.findIndex(t => t.id === draggedRow);
                const targetIndex = newTasks.findIndex(t => t.id === targetTaskId);
                
                if (draggedIndex === -1 || targetIndex === -1) return;

                // Remove dragged task and insert at target position
                const [draggedTask] = newTasks.splice(draggedIndex, 1);
                newTasks.splice(targetIndex, 0, draggedTask);

                setTasks(newTasks);
                setDraggedRow(null);
            };

            // Column resize
            const handleResizeStart = (e, columnId) => {
                e.preventDefault();
                setResizingColumn(columnId);
                setResizeStartX(e.clientX);
                setResizeStartWidth(settings.columnWidths[columnId]);
            };

            useEffect(() => {
                const handleMouseMove = (e) => {
                    if (!resizingColumn) return;
                    
                    const diff = e.clientX - resizeStartX;
                    const newWidth = Math.max(80, resizeStartWidth + diff);
                    
                    setSettings(prev => ({
                        ...prev,
                        columnWidths: {
                            ...prev.columnWidths,
                            [resizingColumn]: newWidth
                        }
                    }));
                };

                const handleMouseUp = () => {
                    setResizingColumn(null);
                };

                if (resizingColumn) {
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                }

                return () => {
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                };
            }, [resizingColumn, resizeStartX, resizeStartWidth]);

            // Export data
            const exportToJSON = () => {
                const dataStr = JSON.stringify(tasks, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `rapido-tasks-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            };

            // Generate invoice
            const generateInvoice = (task) => {
                try {
                    console.log('Generating invoice for:', task);
                    
                    if (!task || !task.id) {
                        alert('Cannot generate invoice: Invalid task data');
                        return;
                    }
                    
                    const { jsPDF } = window.jspdf;
                    if (!jsPDF) {
                        alert('PDF library not loaded. Please refresh the page and try again.');
                        return;
                    }
                    
                    const doc = new jsPDF();
                    
                    // Clean, professional color palette
                    const black = [0, 0, 0];
                    const darkGray = [60, 60, 60];
                    const mediumGray = [120, 120, 120];
                    const lightGray = [200, 200, 200];
                    const white = [255, 255, 255];
                    
                    // Calculate costs
                    const materialCost = parseFloat(task.materialCost) || 0;
                    const totalPrice = parseFloat(task.totalPrice) || 0;
                    const laborCost = totalPrice - materialCost;
                    
                    // White background
                    doc.setFillColor(white[0], white[1], white[2]);
                    doc.rect(0, 0, 210, 297, 'F');
                    
                    let yPos = 20;
                    
                    // Company Header - Simple and Clean
                    doc.setFontSize(24);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(black[0], black[1], black[2]);
                    doc.text('RAPIDO', 20, yPos);
                    
                    yPos += 6;
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
                    doc.text('Professional Handyman Services', 20, yPos);
                    
                    // Contact info (right side)
                    yPos = 20;
                    doc.setFontSize(9);
                    doc.setTextColor(mediumGray[0], mediumGray[1], mediumGray[2]);
                    doc.text('Email: info@rapido.com', 190, yPos, { align: 'right' });
                    yPos += 5;
                    doc.text('Phone: (555) 123-4567', 190, yPos, { align: 'right' });
                    
                    // Horizontal line under header
                    yPos = 35;
                    doc.setDrawColor(lightGray[0], lightGray[1], lightGray[2]);
                    doc.setLineWidth(0.5);
                    doc.line(20, yPos, 190, yPos);
                    
                    // INVOICE title and details
                    yPos += 10;
                    doc.setFontSize(18);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(black[0], black[1], black[2]);
                    doc.text('INVOICE', 20, yPos);
                    
                    // Invoice number and date (right side)
                    const invoiceDate = new Date();
                    const invoiceNum = task.invoiceNumber || (invoiceDate.toLocaleDateString('en-US', { 
                        year: '2-digit', 
                        month: '2-digit', 
                        day: '2-digit' 
                    }).replace(/\//g, '') + '-' + invoiceDate.getHours().toString().padStart(2, '0') + invoiceDate.getMinutes().toString().padStart(2, '0'));
                    
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(mediumGray[0], mediumGray[1], mediumGray[2]);
                    doc.text(`Invoice #: ${invoiceNum}`, 190, yPos - 7, { align: 'right' });
                    doc.text(`Date: ${invoiceDate.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' })}`, 190, yPos - 2, { align: 'right' });
                    doc.text(`Due Date: ${invoiceDate.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' })}`, 190, yPos + 3, { align: 'right' });
                    
                    // Bill To section
                    yPos += 15;
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(black[0], black[1], black[2]);
                    doc.text('BILL TO:', 20, yPos);
                    
                    yPos += 6;
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    doc.text(task.client || 'Valued Customer', 20, yPos);
                    
                    if (task.address) {
                        yPos += 5;
                        doc.setFontSize(9);
                        doc.setTextColor(mediumGray[0], mediumGray[1], mediumGray[2]);
                        const addressLines = doc.splitTextToSize(task.address, 80);
                        doc.text(addressLines, 20, yPos);
                        yPos += (addressLines.length * 5);
                    }
                    
                    // Service description section
                    yPos += 15;
                    
                    // Table header
                    doc.setFillColor(240, 240, 240);
                    doc.rect(20, yPos - 5, 170, 8, 'F');
                    
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(black[0], black[1], black[2]);
                    doc.text('PROJECT DESCRIPTION', 22, yPos);
                    doc.text('AMOUNT', 185, yPos, { align: 'right' });
                    
                    yPos += 8;
                    
                    // Service details
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
                    const taskLines = doc.splitTextToSize(task.task || 'Handyman Service', 120);
                    doc.text(taskLines, 22, yPos);
                    
                    doc.setFont(undefined, 'bold');
                    doc.text(`$${totalPrice.toFixed(2)}`, 185, yPos, { align: 'right' });
                    
                    yPos += (taskLines.length * 5) + 3;
                    
                    // Additional details if notes exist
                    if (task.notes) {
                        yPos += 3;
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(black[0], black[1], black[2]);
                        doc.text('Services Requested:', 22, yPos);
                        
                        yPos += 5;
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
                        const noteLines = task.notes.split('\n');
                        noteLines.forEach(line => {
                            if (line.trim()) {
                                doc.text(`• ${line.trim()}`, 22, yPos);
                                yPos += 5;
                            }
                        });
                    }
                    
                    // Status and dates
                    yPos += 5;
                    if (task.requestDate) {
                        doc.setFontSize(9);
                        doc.setTextColor(mediumGray[0], mediumGray[1], mediumGray[2]);
                        doc.text(`Request Date: ${task.requestDate}`, 22, yPos);
                        yPos += 5;
                    }
                    if (task.completionDate) {
                        doc.setFontSize(9);
                        doc.setTextColor(mediumGray[0], mediumGray[1], mediumGray[2]);
                        doc.text(`Completion Date: ${task.completionDate}`, 22, yPos);
                        yPos += 5;
                    }
                    if (task.workHours && parseFloat(task.workHours) > 0) {
                        doc.setFontSize(9);
                        doc.setTextColor(mediumGray[0], mediumGray[1], mediumGray[2]);
                        doc.text(`Work Hours: ${parseFloat(task.workHours)} hours`, 22, yPos);
                        yPos += 5;
                    }
                    
                    // Cost breakdown if materials exist
                    if (materialCost > 0) {
                        yPos += 8;
                        doc.setFontSize(9);
                        doc.setTextColor(mediumGray[0], mediumGray[1], mediumGray[2]);
                        doc.text(`Materials: $${materialCost.toFixed(2)}`, 22, yPos);
                        yPos += 5;
                        doc.text(`Labor: $${laborCost.toFixed(2)}`, 22, yPos);
                    }
                    
                    // Total line
                    yPos += 10;
                    doc.setDrawColor(black[0], black[1], black[2]);
                    doc.setLineWidth(1);
                    doc.line(20, yPos, 190, yPos);
                    
                    yPos += 8;
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(black[0], black[1], black[2]);
                    doc.text('TOTAL:', 22, yPos);
                    doc.text(`$${totalPrice.toFixed(2)}`, 185, yPos, { align: 'right' });
                    
                    // Footer
                    const pageHeight = doc.internal.pageSize.height;
                    yPos = pageHeight - 30;
                    
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'italic');
                    doc.setTextColor(mediumGray[0], mediumGray[1], mediumGray[2]);
                    doc.text('Payment Terms: Net 30 days. Please make checks payable to RAPIDO.', 105, yPos, { align: 'center' });
                    
                    yPos += 8;
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(black[0], black[1], black[2]);
                    doc.text('Thank you for your business!', 105, yPos, { align: 'center' });
                    
                    yPos += 6;
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(mediumGray[0], mediumGray[1], mediumGray[2]);
                    doc.text('RAPIDO LLC | Licensed & Insured', 105, yPos, { align: 'center' });
                    
                    // Save with professional filename
                    const clientName = (task.client || 'Client').replace(/\s+/g, '_');
                    const now = new Date();
                    const dateStr = now.toLocaleDateString('en-US', { year: '2-digit', month: '2-digit', day: '2-digit' }).replace(/\//g, '');
                    const timeStr = now.getHours().toString().padStart(2, '0') + now.getMinutes().toString().padStart(2, '0');
                    doc.save(`Invoice_${dateStr}-${timeStr}_${clientName}.pdf`);
                    
                    console.log('Invoice generated successfully');
                } catch (error) {
                    console.error('Error generating invoice:', error);
                    alert(`Error generating invoice: ${error.message || 'Unknown error'}. Please check the console for details.`);
                }
            };

            // Get visible columns - all columns are now always visible
            let visibleColumns = [...settings.columnOrder];
            
            // Force phone and email to always be visible - add them if missing (in correct order after client)
            const clientIndex = visibleColumns.indexOf('client');
            
            if (!visibleColumns.includes('phone')) {
                if (clientIndex !== -1) {
                    visibleColumns.splice(clientIndex + 1, 0, 'phone');
                } else {
                    visibleColumns.push('phone');
                }
            }
            
            // Re-find client index after potentially inserting phone
            const newClientIndex = visibleColumns.indexOf('client');
            const phoneIndex = visibleColumns.indexOf('phone');
            
            if (!visibleColumns.includes('email')) {
                if (phoneIndex !== -1) {
                    visibleColumns.splice(phoneIndex + 1, 0, 'email');
                } else if (newClientIndex !== -1) {
                    visibleColumns.splice(newClientIndex + 1, 0, 'email');
                } else {
                    visibleColumns.push('email');
                }
            }

            // Loading state
            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center" style={{ background: currentTheme.background }}>
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-16 w-16 border-b-2 mx-auto mb-4" style={{ borderColor: currentTheme.primary }}></div>
                            <p style={{ color: currentTheme.textSecondary }}>Loading...</p>
                        </div>
                    </div>
                );
            }

            // Login screen
            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4" style={{ background: 'linear-gradient(135deg, #FF6B35 0%, #F7931E 100%)' }}>
                        <div className="w-full max-w-md">
                            <div className="bg-white rounded-2xl shadow-2xl p-8">
                                <div className="text-center mb-8">
                                    <div className="inline-flex items-center justify-center w-20 h-20 bg-orange-100 rounded-full mb-4">
                                        <Lock size={40} style={{ color: '#FF6B35' }} />
                                    </div>
                                    <h1 className="text-3xl font-bold text-gray-900 mb-2" style={{ fontFamily: 'Kanit, sans-serif' }}>
                                        RAPIDO Dashboard
                                    </h1>
                                    <p className="text-gray-600">Sign in to access your dashboard</p>
                                </div>

                                <form onSubmit={handleLogin} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Email
                                        </label>
                                        <input
                                            type="email"
                                            value={email}
                                            onChange={(e) => setEmail(e.target.value)}
                                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                            placeholder="your@email.com"
                                            required
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Password
                                        </label>
                                        <input
                                            type="password"
                                            value={password}
                                            onChange={(e) => setPassword(e.target.value)}
                                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                            placeholder="••••••••"
                                            required
                                        />
                                    </div>

                                    {authError && (
                                        <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                                            {authError}
                                        </div>
                                    )}

                                    <button
                                        type="submit"
                                        className="w-full py-3 px-4 bg-gradient-to-r from-orange-600 to-orange-500 hover:from-orange-700 hover:to-orange-600 text-white font-semibold rounded-lg transition-all duration-200 shadow-lg hover:shadow-xl"
                                    >
                                        Sign In
                                    </button>
                                </form>

                                <div className="mt-6 text-center">
                                    <p className="text-sm text-gray-600">
                                        Secure access powered by Firebase
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Show loading screen while loading from Firebase
            if (isLoadingFromFirebase && user) {
                return (
                    <div 
                        className="min-h-screen flex items-center justify-center transition-colors duration-300"
                        style={{ 
                            background: currentTheme.background,
                            color: currentTheme.textPrimary,
                            fontFamily: 'Kanit, sans-serif'
                        }}
                    >
                        <div className="text-center">
                            <div className="mb-6">
                                <div 
                                    className="w-20 h-20 border-4 rounded-full animate-spin mx-auto"
                                    style={{
                                        borderColor: currentTheme.border,
                                        borderTopColor: currentTheme.primary
                                    }}
                                ></div>
                            </div>
                            <h2 className="text-2xl font-bold mb-2" style={{ color: currentTheme.textPrimary }}>
                                Loading from Firebase...
                            </h2>
                            <p className="text-sm" style={{ color: currentTheme.textSecondary }}>
                                Syncing your data from the cloud
                            </p>
                        </div>
                    </div>
                );
            }

            // Main dashboard (only shown when logged in)
            return (
                <div 
                    className="min-h-screen transition-colors duration-300"
                    style={{ 
                        background: currentTheme.background,
                        color: currentTheme.textPrimary,
                        fontFamily: 'Kanit, sans-serif'
                    }}
                >
                    {/* Header */}
                    <div 
                        className="shadow-lg"
                        style={{ background: currentTheme.headerBg }}
                    >
                        <div className="max-w-[95%] mx-auto px-6 py-6">
                            <div className="flex items-center justify-between">
                                <h1 className="text-3xl font-bold text-white flex items-center gap-3" style={{ fontFamily: 'Kanit, sans-serif' }}>
                                    ⚡ <span style={{ fontFamily: 'Kanit, sans-serif', fontWeight: '700' }}>RAPIDO</span> Handyman Dashboard
                                    <span className="text-xs px-2 py-1 bg-green-500 text-white rounded-full font-semibold">v9.3</span>
                                </h1>
                                
                                <div className="flex items-center gap-3">
                                    {/* Firebase Sync Status Indicator */}
                                    <div className={`px-3 py-1.5 rounded-lg font-medium text-sm flex items-center gap-2 ${
                                        firebaseSynced 
                                            ? 'bg-green-100 text-green-800' 
                                            : 'bg-yellow-100 text-yellow-800'
                                    }`}>
                                        <div className={`w-2 h-2 rounded-full ${
                                            firebaseSynced ? 'bg-green-600' : 'bg-yellow-600 animate-pulse'
                                        }`}></div>
                                        {firebaseSynced ? 'Cloud Synced' : 'Syncing...'}
                                    </div>
                                    
                                    {/* New Requests Button - Always visible */}
                                    <button
                                        onClick={() => {
                                            setShowNewRequests(true);
                                            fetchNewRequests();
                                        }}
                                        className={`relative px-4 py-2 rounded-lg font-semibold transition-all duration-200 flex items-center gap-2 ${
                                            apiConnected 
                                                ? 'bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white' 
                                                : 'bg-white/10 text-white/50 cursor-not-allowed'
                                        }`}
                                        disabled={!apiConnected}
                                        title={apiConnected ? 'Check new requests' : 'Firebase not connected'}
                                    >
                                        <Bell size={20} />
                                        New Requests
                                        {newRequests.length > 0 && (
                                            <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center animate-pulse">
                                                {newRequests.length}
                                            </span>
                                        )}
                                    </button>

                                    {/* Dark Mode Toggle */}
                                    <button
                                        onClick={() => setSettings(prev => ({ ...prev, darkMode: !prev.darkMode }))}
                                        className="p-2 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-lg text-white transition-all duration-200"
                                    >
                                        {settings.darkMode ? <Sun size={20} /> : <Moon size={20} />}
                                    </button>

                                    {/* Logout */}
                                    <button
                                        onClick={handleLogout}
                                        className="px-4 py-2 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-lg text-white transition-all duration-200 flex items-center gap-2 font-semibold"
                                        title="Logout"
                                    >
                                        <User size={18} />
                                        {user?.email?.split('@')[0]}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="max-w-[95%] mx-auto px-6 py-8">
                        {/* Controls Bar */}
                        <div 
                            className="rounded-lg shadow-lg p-6 mb-6"
                            style={{ 
                                backgroundColor: currentTheme.cardBg,
                                border: `1px solid ${currentTheme.border}`
                            }}
                        >
                            <div className="flex flex-wrap items-center gap-4">
                                {/* Add Task Button */}
                                <button
                                    onClick={addTask}
                                    className="px-4 py-2 rounded-lg font-semibold text-white transition-all duration-200 flex items-center gap-2"
                                    style={{ backgroundColor: currentTheme.primary, height: '42px' }}
                                >
                                    <Plus size={16} />
                                    Add Task
                                </button>

                                {/* Search */}
                                <div className="flex-1 min-w-[200px] relative">
                                    <Search 
                                        className="absolute left-3 top-1/2 transform -translate-y-1/2" 
                                        size={20}
                                        style={{ color: currentTheme.textSecondary }}
                                    />
                                    <input
                                        type="text"
                                        placeholder="Search tasks..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        className="w-full pl-10 pr-4 py-2 rounded-lg outline-none transition-all duration-200"
                                        style={{
                                            backgroundColor: currentTheme.hover,
                                            border: `2px solid ${currentTheme.border}`,
                                            color: currentTheme.textPrimary,
                                            height: '42px'
                                        }}
                                    />
                                </div>

                                {/* Filter */}
                                <div className="flex items-center gap-2 relative">
                                    <Filter size={20} style={{ color: currentTheme.textSecondary }} />
                                    <div className="relative">
                                        <button
                                            onClick={() => setShowFilterDropdown(!showFilterDropdown)}
                                            className="px-4 py-2 rounded-lg font-semibold transition-all duration-200 flex items-center gap-2 min-w-[140px]"
                                            style={{
                                                backgroundColor: getStatusColor(filterStatus === 'all' ? 'All Status' : filterStatus),
                                                color: 'white',
                                                height: '42px'
                                            }}
                                        >
                                            <span>{filterStatus === 'all' ? 'All Status' : filterStatus}</span>
                                            <ChevronDown />
                                        </button>
                                        
                                        {showFilterDropdown && (
                                            <div 
                                                className="absolute top-full mt-2 w-48 rounded-lg shadow-lg border p-2 z-50"
                                                style={{
                                                    backgroundColor: settings.darkMode ? '#1e293b' : '#ffffff',
                                                    borderColor: settings.darkMode ? '#475569' : '#e0f2fe',
                                                    animation: 'slideDown 1.5s cubic-bezier(0.34, 1.56, 0.64, 1)'
                                                }}
                                            >
                                                <div className="space-y-2">
                                                    {['all', 'Pending', 'In Progress', 'Completed', 'On Hold'].map((status, index) => (
                                                        <button
                                                            key={status}
                                                            onClick={() => {
                                                                setFilterStatus(status);
                                                                setShowFilterDropdown(false);
                                                            }}
                                                            className="w-full px-4 py-3 rounded-lg text-left text-sm font-medium transition-all duration-200 hover:scale-105 animate-fade-in"
                                                            style={{
                                                                backgroundColor: getStatusColor(status === 'all' ? 'All Status' : status),
                                                                color: 'white',
                                                                animationDelay: `${index * 0.1}s`
                                                            }}
                                                        >
                                                            {status === 'all' ? '✓ All Status' : status}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* Settings Button */}
                                <button
                                    onClick={() => setShowSettings(true)}
                                    className="px-4 py-2 rounded-lg font-semibold transition-all duration-200 flex items-center gap-2"
                                    style={{
                                        backgroundColor: currentTheme.accent,
                                        color: 'white',
                                        height: '42px'
                                    }}
                                >
                                    <Settings size={16} />
                                    Settings
                                </button>
                            </div>
                        </div>

                        {/* Tasks Table */}
                        <div 
                            className="rounded-lg shadow-2xl overflow-hidden"
                            style={{ 
                                backgroundColor: currentTheme.cardBg,
                                border: `1px solid ${currentTheme.border}`
                            }}
                        >
                            {/* Top Scrollbar */}
                            <div 
                                ref={topScrollRef}
                                className="top-scrollbar overflow-x-auto"
                                style={{ 
                                    height: '20px',
                                    overflowY: 'hidden',
                                    borderBottom: `1px solid ${currentTheme.border}`
                                }}
                            >
                                <div style={{ 
                                    width: visibleColumns.reduce((acc, col) => acc + (settings.columnWidths[col] || 150), 0) + 'px',
                                    height: '1px'
                                }} />
                            </div>

                            <div ref={bottomScrollRef} className="overflow-x-auto relative table-scroll-container">
                                <table className="w-full min-w-full"  style={{ minWidth: '100%' }}>
                                    <thead>
                                        <tr 
                                            className="border-b-2"
                                            style={{ 
                                                backgroundColor: currentTheme.hover,
                                                borderColor: currentTheme.border
                                            }}
                                        >
                                            {visibleColumns.map((columnId) => {
                                                const column = columns[columnId];
                                                return (
                                                    <th
                                                        key={columnId}
                                                        draggable={columnId !== 'actions'}
                                                        onDragStart={(e) => handleColumnDragStart(e, columnId)}
                                                        onDragOver={handleColumnDragOver}
                                                        onDrop={(e) => handleColumnDrop(e, columnId)}
                                                        className="px-4 py-4 text-left font-bold relative group"
                                                        style={{
                                                            color: currentTheme.textPrimary,
                                                            minWidth: `${settings.columnWidths[columnId]}px`,
                                                            maxWidth: `${settings.columnWidths[columnId]}px`,
                                                            cursor: columnId !== 'actions' ? 'move' : 'default'
                                                        }}
                                                    >
                                                        <div className="flex items-center justify-between">
                                                            <span className="flex items-center gap-2">
                                                                {columnId !== 'actions' && (
                                                                    <GripVertical size={14} style={{ color: currentTheme.textSecondary }} />
                                                                )}
                                                                {column.label}
                                                            </span>
                                                            
                                                            {column.sortable && (
                                                                <button
                                                                    onClick={() => handleSort(columnId)}
                                                                    className="ml-2"
                                                                    style={{ color: currentTheme.textSecondary }}
                                                                >
                                                                    {sortConfig.key === columnId ? (
                                                                        sortConfig.direction === 'asc' ? '↑' : '↓'
                                                                    ) : '↕'}
                                                                </button>
                                                            )}
                                                        </div>

                                                        {/* Resize Handle */}
                                                        {columnId !== 'actions' && (
                                                            <div
                                                                className="absolute right-0 top-0 bottom-0 w-1 cursor-col-resize opacity-0 group-hover:opacity-100 transition-opacity"
                                                                style={{ backgroundColor: currentTheme.primary }}
                                                                onMouseDown={(e) => handleResizeStart(e, columnId)}
                                                            />
                                                        )}
                                                    </th>
                                                );
                                            })}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {orderedGroupedTasks.map(([status, statusTasks]) => (
                                            <React.Fragment key={status}>
                                                {/* Group Header */}
                                                <tr 
                                                    className="cursor-pointer transition-colors duration-200"
                                                    style={{ backgroundColor: currentTheme.hover }}
                                                    onClick={() => toggleGroup(status)}
                                                >
                                                    <td 
                                                        colSpan={visibleColumns.length}
                                                        className="px-4 py-3 font-bold"
                                                    >
                                                        <div className="flex items-center gap-2">
                                                            <div 
                                                                className="chevron-rotate"
                                                                style={{ 
                                                                    transform: collapsedGroups[status] ? 'rotate(0deg)' : 'rotate(90deg)',
                                                                    color: currentTheme.textPrimary
                                                                }}
                                                            >
                                                                <ChevronRight />
                                                            </div>
                                                            <span style={{ color: getStatusColor(status) }}>
                                                                {status}
                                                            </span>
                                                            <span 
                                                                className="text-lg font-bold ml-2"
                                                                style={{ color: currentTheme.textSecondary }}
                                                            >
                                                                ({statusTasks.length})
                                                            </span>
                                                        </div>
                                                    </td>
                                                </tr>

                                                {/* Task Rows */}
                                                {!collapsedGroups[status] && statusTasks.map((task) => (
                                                    <tr 
                                                        key={task.id}
                                                        draggable="true"
                                                        onDragStart={(e) => handleRowDragStart(e, task.id)}
                                                        onDragEnd={handleRowDragEnd}
                                                        onDragOver={handleRowDragOver}
                                                        onDrop={(e) => handleRowDrop(e, task.id, status)}
                                                        className={`border-b transition-all duration-200 cursor-move ${
                                                            expandedDropdown?.taskId === task.id ? 'calendar-expanded' : ''
                                                        }`}
                                                        style={{ 
                                                            borderColor: currentTheme.border,
                                                            background: task.isNew 
                                                                ? 'linear-gradient(135deg, #ebff0e 0%, #ffa31f 100%)'
                                                                : selectedTasks.has(task.id) 
                                                                    ? currentTheme.hover 
                                                                    : (showMetrics && showMetrics.id === task.id)
                                                                        ? `${currentTheme.primary}20`
                                                                        : 'transparent',
                                                            boxShadow: task.isNew
                                                                ? '0 4px 15px rgba(255, 163, 31, 0.4)'
                                                                : showMetrics && showMetrics.id === task.id 
                                                                    ? `inset 0 0 0 3px ${currentTheme.primary}, 0 0 20px ${currentTheme.primary}40` 
                                                                    : 'none',
                                                            transform: showMetrics && showMetrics.id === task.id 
                                                                ? 'scale(1.01)' 
                                                                : 'scale(1)',
                                                            fontWeight: task.isNew ? '400' : 'normal',
                                                            color: task.isNew ? '#1a1a1a' : 'inherit',
                                                            textShadow: task.isNew ? '0 1px 2px rgba(255, 255, 255, 0.8)' : 'none'
                                                        }}
                                                        onMouseEnter={(e) => {
                                                            if (!task.isNew && !selectedTasks.has(task.id) && expandedDropdown?.taskId !== task.id && !(showMetrics && showMetrics.id === task.id)) {
                                                                e.currentTarget.style.background = currentTheme.hover;
                                                            }
                                                        }}
                                                        onMouseLeave={(e) => {
                                                            if (!task.isNew && !selectedTasks.has(task.id) && expandedDropdown?.taskId !== task.id && !(showMetrics && showMetrics.id === task.id)) {
                                                                e.currentTarget.style.background = 'transparent';
                                                            }
                                                        }}
                                                    >
                                                        {visibleColumns.map((columnId) => {
                                                            const column = columns[columnId];
                                                            
                                                            if (columnId === 'actions') {
                                                                return (
                                                                    <td 
                                                                        key={columnId} 
                                                                        className="pl-4 pr-8 py-3"
                                                                        style={{
                                                                            minWidth: `${settings.columnWidths[columnId]}px`,
                                                                            maxWidth: `${settings.columnWidths[columnId]}px`
                                                                        }}
                                                                    >
                                                                        <div className="flex items-center gap-3 justify-start">
                                                                            {task.isNew && (
                                                                                <button
                                                                                    onClick={() => acknowledgeNewItem(task.id)}
                                                                                    className="p-3 rounded-lg transition-all duration-200 hover:scale-110 animate-pulse"
                                                                                    style={{
                                                                                        backgroundColor: '#00cc44',
                                                                                        color: 'white'
                                                                                    }}
                                                                                    title="Acknowledge New Request"
                                                                                >
                                                                                    <Check size={20} />
                                                                                </button>
                                                                            )}
                                                                            <button
                                                                                onClick={() => setShowMetrics(task)}
                                                                                className="p-3 rounded-lg transition-all duration-200 hover:scale-110"
                                                                                style={{
                                                                                    backgroundColor: currentTheme.hover,
                                                                                    color: currentTheme.primary
                                                                                }}
                                                                                title="View Metrics"
                                                                            >
                                                                                <BarChart size={20} />
                                                                            </button>
                                                                            <button
                                                                                onClick={(e) => {
                                                                                    e.stopPropagation();
                                                                                    generateInvoice(task);
                                                                                }}
                                                                                className="p-3 rounded-lg transition-all duration-200 hover:scale-110"
                                                                                style={{
                                                                                    backgroundColor: currentTheme.hover,
                                                                                    color: currentTheme.success
                                                                                }}
                                                                                title="Generate Invoice"
                                                                            >
                                                                                <FileText size={20} />
                                                                            </button>
                                                                            <button
                                                                                onClick={() => duplicateTask(task)}
                                                                                className="p-3 rounded-lg transition-all duration-200 hover:scale-110"
                                                                                style={{
                                                                                    backgroundColor: currentTheme.hover,
                                                                                    color: currentTheme.primary
                                                                                }}
                                                                                title="Duplicate"
                                                                            >
                                                                                <Plus size={20} />
                                                                            </button>
                                                                            <button
                                                                                onClick={() => setDeleteConfirm({ id: task.id, task: task.task })}
                                                                                className="p-3 rounded-lg transition-all duration-200 hover:scale-110"
                                                                                style={{
                                                                                    backgroundColor: currentTheme.hover,
                                                                                    color: currentTheme.error
                                                                                }}
                                                                                title="Delete"
                                                                            >
                                                                                <Trash2 size={20} />
                                                                            </button>
                                                                            <div 
                                                                                className="p-3 rounded-lg cursor-move grip-handle"
                                                                                style={{
                                                                                    backgroundColor: currentTheme.hover,
                                                                                    color: currentTheme.textSecondary,
                                                                                    opacity: 0.5
                                                                                }}
                                                                                title="Drag to reorder"
                                                                            >
                                                                                <GripVertical size={20} />
                                                                            </div>
                                                                        </div>
                                                                    </td>
                                                                );
                                                            }
                                                            
                                                            if (column.type === 'date') {
                                                                const isExpanded = expandedDropdown?.taskId === task.id && expandedDropdown?.columnId === columnId;
                                                                return (
                                                                    <td 
                                                                        key={columnId} 
                                                                        className="px-4 py-3"
                                                                        style={{
                                                                            minWidth: `${settings.columnWidths[columnId]}px`,
                                                                            maxWidth: `${settings.columnWidths[columnId]}px`
                                                                        }}
                                                                    >
                                                                        <InlineCalendar
                                                                            value={task[columnId]}
                                                                            onChange={(value) => updateTask(task.id, columnId, value)}
                                                                            darkMode={settings.darkMode}
                                                                            onToggle={() => {
                                                                                setExpandedDropdown(isExpanded ? null : { taskId: task.id, columnId });
                                                                            }}
                                                                            isExpanded={isExpanded}
                                                                        />
                                                                    </td>
                                                                );
                                                            }
                                                            
                                                            if (column.type === 'select') {
                                                                const isExpanded = expandedDropdown?.taskId === task.id && expandedDropdown?.columnId === columnId;
                                                                const getColorFunc = columnId === 'status' ? getStatusColor : columnId === 'priority' ? getPriorityColor : null;
                                                                
                                                                return (
                                                                    <td 
                                                                        key={columnId} 
                                                                        className="px-4 py-3"
                                                                        style={{
                                                                            minWidth: `${settings.columnWidths[columnId]}px`,
                                                                            maxWidth: `${settings.columnWidths[columnId]}px`
                                                                        }}
                                                                    >
                                                                        <InlineDropdown
                                                                            value={task[columnId]}
                                                                            onChange={(value) => updateTask(task.id, columnId, value)}
                                                                            options={column.options}
                                                                            darkMode={settings.darkMode}
                                                                            onToggle={() => {
                                                                                setExpandedDropdown(isExpanded ? null : { taskId: task.id, columnId });
                                                                            }}
                                                                            isExpanded={isExpanded}
                                                                            columnId={columnId}
                                                                            getColorFunc={getColorFunc}
                                                                        />
                                                                    </td>
                                                                );
                                                            }
                                                            
                                                            return (
                                                                <td 
                                                                    key={columnId} 
                                                                    className="px-4 py-3"
                                                                    style={{
                                                                        minWidth: `${settings.columnWidths[columnId]}px`,
                                                                        maxWidth: `${settings.columnWidths[columnId]}px`
                                                                    }}
                                                                >
                                                                    <div
                                                                        contentEditable={column.editable}
                                                                        suppressContentEditableWarning
                                                                        onBlur={(e) => {
                                                                            let value = e.currentTarget.textContent || '';
                                                                            // Strip $ symbol from price fields
                                                                            if (columnId === 'totalPrice' || columnId === 'materialCost') {
                                                                                value = value.replace(/[$,]/g, '');
                                                                            }
                                                                            updateTask(task.id, columnId, value);
                                                                        }}
                                                                    >
                                                                        {columnId === 'totalPrice' || columnId === 'materialCost' 
                                                                            ? (String(task[columnId] || '').startsWith('$') ? task[columnId] : `$${task[columnId]}`)
                                                                            : task[columnId]}
                                                                    </div>
                                                                </td>
                                                            );
                                                        })}
                                                    </tr>
                                                ))}
                                            </React.Fragment>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    {/* Delete Confirmation Modal */}
                    {deleteConfirm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" onClick={() => setDeleteConfirm(null)}>
                            <div 
                                className="rounded-lg shadow-2xl p-6 max-w-md w-full m-4"
                                style={{ backgroundColor: currentTheme.cardBg }}
                                onClick={(e) => e.stopPropagation()}
                            >
                                <h3 className="text-xl font-bold mb-4" style={{ color: currentTheme.primary }}>
                                    Confirm Delete
                                </h3>
                                <p className="mb-6" style={{ color: currentTheme.textPrimary }}>
                                    Are you sure you want to delete "{deleteConfirm.task}"?
                                </p>
                                <div className="flex space-x-3">
                                    <button
                                        onClick={() => deleteTask(deleteConfirm.id)}
                                        className="flex-1 py-2 rounded-lg font-semibold text-white"
                                        style={{ backgroundColor: '#ef4444' }}
                                    >
                                        Delete
                                    </button>
                                    <button
                                        onClick={() => setDeleteConfirm(null)}
                                        className="flex-1 py-2 rounded-lg font-semibold"
                                        style={{
                                            backgroundColor: currentTheme.background,
                                            border: `2px solid ${currentTheme.secondary}`,
                                            color: currentTheme.textPrimary
                                        }}
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* New Requests Modal */}
                    {showNewRequests && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                            <div 
                                className="w-full max-w-4xl max-h-[90vh] rounded-lg shadow-2xl flex flex-col"
                                style={{ backgroundColor: currentTheme.cardBg }}
                            >
                                <div className="p-6 border-b flex items-center justify-between" style={{ borderColor: currentTheme.border }}>
                                    <div>
                                        <h2 className="text-2xl font-bold" style={{ color: currentTheme.primary }}>
                                            New Requests
                                        </h2>
                                        <p className="text-sm mt-1" style={{ color: currentTheme.textSecondary }}>
                                            {newRequests.length} pending request{newRequests.length !== 1 ? 's' : ''}
                                        </p>
                                    </div>
                                    <button
                                        onClick={() => setShowNewRequests(false)}
                                        className="p-2 rounded-lg transition-colors"
                                        style={{
                                            backgroundColor: currentTheme.hover,
                                            color: currentTheme.textPrimary
                                        }}
                                    >
                                        <X size={24} />
                                    </button>
                                </div>
                                
                                <div className="flex-1 overflow-y-auto p-6">
                                    {!apiConnected ? (
                                        <div className="text-center py-12">
                                            <div className="text-6xl mb-4">⚠️</div>
                                            <h4 className="text-lg font-semibold mb-2" style={{ color: currentTheme.textPrimary }}>
                                                Firebase Not Connected
                                            </h4>
                                            <p className="mb-4" style={{ color: currentTheme.textSecondary }}>
                                                Check your internet connection and Firebase configuration
                                            </p>
                                            <code 
                                                className="px-3 py-1 rounded text-sm block mb-2"
                                                style={{ backgroundColor: currentTheme.hover }}
                                            >
                                                {firebaseConfig.databaseURL}
                                            </code>
                                            <p className="text-sm mb-4" style={{ color: currentTheme.textSecondary }}>
                                                Make sure your Firebase Realtime Database rules allow read access
                                            </p>
                                            <div className="mt-6">
                                                <button
                                                    onClick={checkApiConnection}
                                                    className="px-4 py-2 rounded-lg font-medium text-white transition-colors"
                                                    style={{ backgroundColor: currentTheme.primary }}
                                                >
                                                    Retry Connection
                                                </button>
                                            </div>
                                        </div>
                                    ) : newRequests.length === 0 ? (
                                        <div className="text-center py-12">
                                            <div className="text-6xl mb-4">✅</div>
                                            <h4 className="text-lg font-semibold mb-2" style={{ color: currentTheme.textPrimary }}>
                                                All Requests Imported
                                            </h4>
                                            <p style={{ color: currentTheme.textSecondary }}>
                                                New requests have been automatically added to your Pending section with a highlighted gradient. Look for the bright yellow-orange items!
                                            </p>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            {newRequests.map(request => (
                                                <div 
                                                    key={request.id} 
                                                    className="border rounded-lg p-4 transition-colors"
                                                    style={{ 
                                                        borderColor: currentTheme.border,
                                                        backgroundColor: currentTheme.hover
                                                    }}
                                                >
                                                    <div className="flex items-start justify-between mb-3">
                                                        <div className="flex-1">
                                                            <h4 className="font-semibold mb-1" style={{ color: currentTheme.textPrimary }}>
                                                                {request.task || request.projectName || 'Untitled Project'}
                                                            </h4>
                                                            <div className="flex items-center gap-4 text-sm" style={{ color: currentTheme.textSecondary }}>
                                                                <span className="flex items-center gap-1">
                                                                    <User size={14} />
                                                                    {request.clientName || 'Unknown Client'}
                                                                </span>
                                                                <span className="flex items-center gap-1">
                                                                    <Calendar size={14} />
                                                                    {request.requestDate || new Date(request.submittedAt).toISOString().split('T')[0]}
                                                                </span>
                                                                {request.totalPrice && (
                                                                    <span className="font-semibold" style={{ color: currentTheme.success }}>
                                                                        ${parseFloat(request.totalPrice).toLocaleString()}
                                                                    </span>
                                                                )}
                                                            </div>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button
                                                                onClick={async () => {
                                                                    await importRequest(request);
                                                                    if (newRequests.length === 1) {
                                                                        setShowNewRequests(false);
                                                                    }
                                                                }}
                                                                className="px-3 py-1 rounded-lg text-sm font-medium text-white transition-colors flex items-center gap-1"
                                                                style={{ backgroundColor: currentTheme.success }}
                                                            >
                                                                <Download size={14} />
                                                                Import
                                                            </button>
                                                            <button
                                                                onClick={() => dismissRequest(request.id)}
                                                                className="px-3 py-1 rounded text-sm font-medium transition-colors"
                                                                style={{
                                                                    backgroundColor: currentTheme.background,
                                                                    color: currentTheme.textPrimary
                                                                }}
                                                            >
                                                                Dismiss
                                                            </button>
                                                        </div>
                                                    </div>
                                                    {(request.notes || request.projectDescription) && (
                                                        <div 
                                                            className="text-sm p-2 rounded mt-2"
                                                            style={{
                                                                backgroundColor: currentTheme.background,
                                                                color: currentTheme.textSecondary
                                                            }}
                                                        >
                                                            {request.notes || request.projectDescription}
                                                        </div>
                                                    )}
                                                    <div className="mt-2 flex gap-2 flex-wrap text-xs">
                                                        {request.priority && (
                                                            <span 
                                                                className="px-2 py-1 rounded"
                                                                style={{
                                                                    backgroundColor: request.priority === 'High' 
                                                                        ? currentTheme.warning 
                                                                        : currentTheme.primary,
                                                                    color: 'white'
                                                                }}
                                                            >
                                                                {request.priority} Priority
                                                            </span>
                                                        )}
                                                        {request.timeline && (
                                                            <span 
                                                                className="px-2 py-1 rounded"
                                                                style={{
                                                                    backgroundColor: currentTheme.accent,
                                                                    color: 'white'
                                                                }}
                                                            >
                                                                {request.timeline} timeline
                                                            </span>
                                                        )}
                                                        {request.invoiceNumber && (
                                                            <span 
                                                                className="px-2 py-1 rounded"
                                                                style={{
                                                                    backgroundColor: currentTheme.success,
                                                                    color: 'white'
                                                                }}
                                                            >
                                                                {request.invoiceNumber}
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                
                                <div className="flex justify-end mt-6 p-6 pt-4 border-t" style={{ borderColor: currentTheme.border }}>
                                    <button
                                        onClick={() => setShowNewRequests(false)}
                                        className="px-6 py-2 rounded-lg font-medium text-white transition-colors"
                                        style={{ backgroundColor: currentTheme.secondary }}
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-lg shadow-xl p-6 max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                                <div className="flex items-center justify-between mb-6">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                                            <Settings size={20} />
                                        </div>
                                        <h3 className="text-xl font-semibold text-gray-900">Settings</h3>
                                    </div>
                                    <button
                                        onClick={() => setShowSettings(false)}
                                        className="text-gray-400 hover:text-gray-600 transition-colors"
                                    >
                                        <X size={24} />
                                    </button>
                                </div>
                                
                                {/* Two Column Layout */}
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    {/* Left Column - Theme Settings */}
                                    <div className="space-y-4">
                                        <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                            <div>
                                                <h4 className="font-semibold text-gray-900 mb-1">🌙 Dark Mode</h4>
                                                <p className="text-sm text-gray-600">Enable dark mode</p>
                                            </div>
                                            <label className="relative inline-flex items-center cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    checked={settings.darkMode}
                                                    onChange={(e) => setSettings(prev => ({ ...prev, darkMode: e.target.checked }))}
                                                    className="sr-only peer"
                                                />
                                                <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                            </label>
                                        </div>
                                        
                                        {/* Theme Selection */}
                                        <div className="p-4 bg-gradient-to-br from-blue-50 to-purple-50 rounded-lg border-2 border-blue-200">
                                            <h4 className="font-bold text-gray-900 mb-3 flex items-center gap-2">
                                                <span className="text-xl">🎨</span>
                                                Color Themes
                                            </h4>
                                            <div className="grid grid-cols-2 gap-2 mb-4">
                                                {Object.entries(colorThemes)
                                                    .filter(([themeName]) => !customThemeNames.includes(themeName))
                                                    .map(([themeName, themeColors]) => (
                                                    <button
                                                        key={themeName}
                                                        onClick={() => setSettings(prev => ({ ...prev, currentTheme: themeName }))}
                                                        className={`px-4 py-3 rounded-lg text-sm font-medium transition-all ${
                                                            settings.currentTheme === themeName
                                                                ? 'ring-2 ring-blue-500 ring-offset-2'
                                                                : 'hover:shadow-md'
                                                        }`}
                                                        style={{
                                                            background: themeColors.headerBg,
                                                            color: 'white'
                                                        }}
                                                    >
                                                        {themeColors.name}
                                                    </button>
                                                ))}
                                                {customThemeNames.map(themeName => (
                                                    <div key={themeName} className="flex items-center gap-2">
                                                        <button
                                                            onClick={() => setSettings(prev => ({ ...prev, currentTheme: themeName }))}
                                                            className={`flex-1 px-4 py-3 rounded-lg text-sm font-medium transition-all ${
                                                                settings.currentTheme === themeName
                                                                    ? 'ring-2 ring-blue-500 ring-offset-2'
                                                                    : 'hover:shadow-md'
                                                            }`}
                                                            style={{
                                                                background: colorThemes[themeName]?.headerBg || colorThemes.ocean.headerBg,
                                                                color: 'white'
                                                            }}
                                                        >
                                                            {themeName} ✨
                                                        </button>
                                                        <button
                                                            onClick={async () => {
                                                                if (window.confirm(`Delete "${themeName}" theme?`)) {
                                                                    // Save to Firebase FIRST before updating local state
                                                                    if (database && user) {
                                                                        try {
                                                                            // Remove from colorThemes object
                                                                            delete colorThemes[themeName];
                                                                            
                                                                            // Update custom theme names
                                                                            const updatedNames = customThemeNames.filter(name => name !== themeName);
                                                                            await database.ref(`users/${user.uid}/customThemeNames`).set(updatedNames);
                                                                            
                                                                            // Update custom themes data
                                                                            const updatedThemes = updatedNames.reduce((acc, name) => {
                                                                                if (colorThemes[name]) acc[name] = colorThemes[name];
                                                                                return acc;
                                                                            }, {});
                                                                            await database.ref(`users/${user.uid}/customThemes`).set(updatedThemes);
                                                                            
                                                                            console.log('🗑️ Theme deleted from Firebase successfully');
                                                                            
                                                                            // NOW update local state
                                                                            setCustomThemeNames(updatedNames);
                                                                            
                                                                            // If this was the active theme, switch to default
                                                                            if (settings.currentTheme === themeName) {
                                                                                setSettings(prev => ({ ...prev, currentTheme: 'sunset' }));
                                                                            }
                                                                            
                                                                            alert(`🗑️ Theme "${themeName}" deleted and synced!`);
                                                                        } catch (error) {
                                                                            console.error('❌ Error deleting theme:', error);
                                                                            alert('Failed to delete theme. Please try again.');
                                                                        }
                                                                    } else {
                                                                        alert('Not connected to Firebase. Please check your connection.');
                                                                    }
                                                                }
                                                            }}
                                                            className="p-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all flex items-center justify-center"
                                                            title="Delete this custom theme"
                                                        >
                                                            <Trash2 size={16} />
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                            
                                            {/* Custom Theme Creator Button */}
                                            <button
                                                onClick={() => setShowCustomThemeCreator(!showCustomThemeCreator)}
                                                className="w-full py-2 px-4 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white rounded-lg font-bold transition-all flex items-center justify-center gap-2"
                                            >
                                                <Palette size={16} />
                                                {showCustomThemeCreator ? 'Hide' : 'Create'} Custom Theme
                                            </button>
                                            
                                            {/* Custom Theme Creator Form */}
                                            {showCustomThemeCreator && (
                                                <div className="mt-4 p-4 bg-white rounded-lg border border-purple-300">
                                                    <h5 className="font-bold text-gray-900 mb-3 flex items-center gap-2">
                                                        <span className="text-xl">✨</span>
                                                        Custom Theme Creator
                                                    </h5>
                                                    <div className="space-y-3">
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-700 mb-1">Theme Name</label>
                                                            <input
                                                                type="text"
                                                                value={customTheme.name}
                                                                onChange={(e) => setCustomTheme({ ...customTheme, name: e.target.value })}
                                                                placeholder="My Custom Theme"
                                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900 bg-white placeholder-gray-400"
                                                                style={{ color: '#111827', fontWeight: '500' }}
                                                            />
                                                        </div>
                                                        <div className="grid grid-cols-2 gap-3">
                                                            <div>
                                                                <label className="block text-sm font-medium text-gray-700 mb-1">Primary Color</label>
                                                                <input
                                                                    type="color"
                                                                    value={customTheme.primary}
                                                                    onChange={(e) => setCustomTheme({ ...customTheme, primary: e.target.value })}
                                                                    className="w-full h-10 rounded border border-gray-300 cursor-pointer"
                                                                />
                                                            </div>
                                                            <div>
                                                                <label className="block text-sm font-medium text-gray-700 mb-1">Secondary Color</label>
                                                                <input
                                                                    type="color"
                                                                    value={customTheme.secondary}
                                                                    onChange={(e) => setCustomTheme({ ...customTheme, secondary: e.target.value })}
                                                                    className="w-full h-10 rounded border border-gray-300 cursor-pointer"
                                                                />
                                                            </div>
                                                            <div>
                                                                <label className="block text-sm font-medium text-gray-700 mb-1">Accent Color</label>
                                                                <input
                                                                    type="color"
                                                                    value={customTheme.accent}
                                                                    onChange={(e) => setCustomTheme({ ...customTheme, accent: e.target.value })}
                                                                    className="w-full h-10 rounded border border-gray-300 cursor-pointer"
                                                                />
                                                            </div>
                                                            <div>
                                                                <label className="block text-sm font-medium text-gray-700 mb-1">Success Color</label>
                                                                <input
                                                                    type="color"
                                                                    value={customTheme.success}
                                                                    onChange={(e) => setCustomTheme({ ...customTheme, success: e.target.value })}
                                                                    className="w-full h-10 rounded border border-gray-300 cursor-pointer"
                                                                />
                                                            </div>
                                                        </div>
                                                        <button
                                                            onClick={async () => {
                                                                if (!customTheme.name.trim()) {
                                                                    alert('Please enter a theme name!');
                                                                    return;
                                                                }
                                                                // Check if theme already exists in built-in themes OR custom themes
                                                                if (colorThemes[customTheme.name] || customThemeNames.includes(customTheme.name)) {
                                                                    alert('⚠️ A theme with this name already exists! Please choose a different name.');
                                                                    return;
                                                                }
                                                                
                                                                const themeName = customTheme.name;
                                                                const headerBg = `linear-gradient(135deg, ${customTheme.primary} 0%, ${customTheme.secondary} 100%)`;
                                                                const newThemeData = { 
                                                                    ...customTheme,
                                                                    headerBg: headerBg,
                                                                    name: themeName
                                                                };
                                                                
                                                                // Add to colorThemes object
                                                                colorThemes[themeName] = newThemeData;
                                                                
                                                                // Save to Firebase FIRST (before updating settings)
                                                                if (database && user) {
                                                                    try {
                                                                        // Save theme data
                                                                        const updatedCustomThemes = {
                                                                            ...customThemeNames.reduce((acc, name) => {
                                                                                if (colorThemes[name]) acc[name] = colorThemes[name];
                                                                                return acc;
                                                                            }, {}),
                                                                            [themeName]: newThemeData
                                                                        };
                                                                        await database.ref(`users/${user.uid}/customThemes`).set(updatedCustomThemes);
                                                                        
                                                                        // Save theme names
                                                                        const updatedNames = [...customThemeNames, themeName];
                                                                        await database.ref(`users/${user.uid}/customThemeNames`).set(updatedNames);
                                                                        
                                                                        console.log('🎨 Theme saved to Firebase successfully');
                                                                        
                                                                        // NOW update local state - this will sync to other devices
                                                                        setCustomThemeNames(updatedNames);
                                                                        setSettings(prev => ({ ...prev, currentTheme: themeName }));
                                                                        
                                                                        // Reset form
                                                                        setCustomTheme({
                                                                            name: '',
                                                                            primary: '#3b82f6',
                                                                            secondary: '#8b5cf6',
                                                                            accent: '#10b981',
                                                                            background: '#ffffff',
                                                                            cardBg: '#ffffff',
                                                                            headerBg: 'linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%)',
                                                                            textPrimary: '#1f2937',
                                                                            textSecondary: '#6b7280',
                                                                            border: '#e5e7eb',
                                                                            hover: '#f3f4f6',
                                                                            success: '#10b981',
                                                                            warning: '#f59e0b',
                                                                            error: '#ef4444'
                                                                        });
                                                                        setShowCustomThemeCreator(false);
                                                                        alert(`🎨 Theme "${themeName}" created and synced!`);
                                                                    } catch (error) {
                                                                        console.error('❌ Error saving theme:', error);
                                                                        alert('Failed to save theme. Please try again.');
                                                                        // Clean up on error
                                                                        delete colorThemes[themeName];
                                                                    }
                                                                } else {
                                                                    alert('Not connected to Firebase. Please check your connection.');
                                                                }
                                                            }}
                                                            className="w-full py-2 px-4 bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white rounded-lg font-bold transition-all"
                                                        >
                                                            ✨ Create & Apply Theme
                                                        </button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    
                                    {/* Right Column - Reports & Data Management */}
                                    <div className="space-y-6">
                                        {/* Reports Generator Section */}
                                        <div className="p-4 bg-gradient-to-br from-purple-50 to-blue-50 rounded-lg border-2 border-purple-200">
                                            <div className="mb-4">
                                                <h4 className="font-bold text-gray-900 mb-1 flex items-center gap-2">
                                                    <span className="text-xl">📊</span>
                                                    Reports Generator
                                                </h4>
                                                <p className="text-sm text-gray-600">Export data as CSV files for Excel, Google Sheets, QuickBooks, or data analysis</p>
                                            </div>
                                            
                                            {/* Export Format Toggle */}
                                            <div className="mb-4">
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Export Format</label>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <button
                                                        onClick={() => setExportFormat('csv')}
                                                        className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                                                            exportFormat === 'csv'
                                                                ? 'bg-gray-600 text-white'
                                                                : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'
                                                        }`}
                                                    >
                                                        📄 Standard CSV
                                                    </button>
                                                    <button
                                                        onClick={() => setExportFormat('quickbooks')}
                                                        className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                                                            exportFormat === 'quickbooks'
                                                                ? 'bg-green-600 text-white'
                                                                : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'
                                                        }`}
                                                    >
                                                        💚 QuickBooks
                                                    </button>
                                                </div>
                                                {exportFormat === 'quickbooks' && (
                                                    <div className="mt-2 p-2 bg-green-50 border border-green-200 rounded text-xs text-green-800">
                                                        ℹ️ QuickBooks format ready for direct import into QuickBooks Online or Desktop
                                                    </div>
                                                )}
                                            </div>
                                            
                                            <div className="grid grid-cols-2 gap-2">
                                                <button
                                                    onClick={() => generateCSVReport('thisMonth')}
                                                    className="px-3 py-2 bg-white hover:bg-purple-50 text-gray-700 border border-purple-300 rounded-lg text-sm font-medium transition-colors"
                                                >
                                                    This Month
                                                </button>
                                                <button
                                                    onClick={() => generateCSVReport('lastMonth')}
                                                    className="px-3 py-2 bg-white hover:bg-purple-50 text-gray-700 border border-purple-300 rounded-lg text-sm font-medium transition-colors"
                                                >
                                                    Last Month
                                                </button>
                                                <button
                                                    onClick={() => generateCSVReport('thisQuarter')}
                                                    className="px-3 py-2 bg-white hover:bg-purple-50 text-gray-700 border border-purple-300 rounded-lg text-sm font-medium transition-colors"
                                                >
                                                    This Quarter
                                                </button>
                                                <button
                                                    onClick={() => generateCSVReport('lastQuarter')}
                                                    className="px-3 py-2 bg-white hover:bg-purple-50 text-gray-700 border border-purple-300 rounded-lg text-sm font-medium transition-colors"
                                                >
                                                    Last Quarter
                                                </button>
                                                <button
                                                    onClick={() => generateCSVReport('thisYear')}
                                                    className="px-3 py-2 bg-white hover:bg-purple-50 text-gray-700 border border-purple-300 rounded-lg text-sm font-medium transition-colors"
                                                >
                                                    This Year
                                                </button>
                                                <button
                                                    onClick={() => generateCSVReport('lastYear')}
                                                    className="px-3 py-2 bg-white hover:bg-purple-50 text-gray-700 border border-purple-300 rounded-lg text-sm font-medium transition-colors"
                                                >
                                                    Last Year
                                                </button>
                                                <button
                                                    onClick={() => generateCSVReport('allTime')}
                                                    className="col-span-2 px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-bold transition-colors"
                                                >
                                                    📈 All Time Report
                                                </button>
                                            </div>
                                        </div>
                                        
                                        {/* Data Management Section */}
                                        <div className="p-4 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg border-2 border-blue-200">
                                            <div className="mb-4">
                                                <h4 className="font-bold text-gray-900 mb-1 flex items-center gap-2">
                                                    <span className="text-xl">💾</span>
                                                    Data Management
                                                </h4>
                                                <p className="text-sm text-gray-600">Backup and restore your dashboard data</p>
                                            </div>
                                            <div className="space-y-2">
                                                <button
                                                    onClick={saveBackupForDrive}
                                                    className="w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2"
                                                >
                                                    <Save size={16} />
                                                    Download Backup File
                                                </button>
                                                <label htmlFor="fileInputSettings" className="cursor-pointer w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                                                    <Upload size={16} />
                                                    Load Data from File
                                                </label>
                                                <input
                                                    id="fileInputSettings"
                                                    type="file"
                                                    accept=".json"
                                                    onChange={handleFileLoad}
                                                    className="hidden"
                                                />
                                            </div>
                                            <div className="mt-3 p-2 bg-blue-100 rounded text-xs text-blue-800">
                                                ℹ️ Your data syncs automatically to Firebase. Backups are for archiving or migration.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="flex justify-between items-center mt-6 pt-4 border-t">
                                    <div className="text-xs text-gray-500">
                                        ☁️ All changes sync automatically to Firebase
                                    </div>
                                    <button
                                        onClick={() => setShowSettings(false)}
                                        className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors"
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Metrics Modal */}
                    {showMetrics && (
                        <div 
                            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                            onClick={() => setShowMetrics(null)}
                        >
                            <div 
                                className="rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto"
                                style={{ backgroundColor: currentTheme.cardBg }}
                                onClick={(e) => e.stopPropagation()}
                            >
                                <div 
                                    className="p-6 rounded-t-2xl"
                                    style={{ 
                                        background: currentTheme.headerBg,
                                        color: '#ffffff'
                                    }}
                                >
                                    <div className="flex justify-between items-center">
                                        <h2 className="text-2xl font-bold flex items-center gap-2">
                                            <BarChart size={28} />
                                            Task Metrics
                                        </h2>
                                        <button
                                            onClick={() => setShowMetrics(null)}
                                            className="p-2 hover:bg-white/20 rounded-lg transition-colors"
                                        >
                                            <X size={24} />
                                        </button>
                                    </div>
                                    <p className="mt-2 opacity-90">Detailed metrics and analytics for: <strong>{showMetrics.task}</strong></p>
                                </div>

                                <div className="p-6 space-y-6">
                                    {/* Task Overview */}
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="p-4 rounded-lg" style={{ backgroundColor: currentTheme.hover }}>
                                            <div className="text-sm font-medium mb-1" style={{ color: currentTheme.textSecondary }}>Invoice #</div>
                                            <div className="text-xl font-bold" style={{ color: currentTheme.textPrimary }}>{showMetrics.invoiceNumber || 'N/A'}</div>
                                        </div>
                                        <div className="p-4 rounded-lg" style={{ backgroundColor: currentTheme.hover }}>
                                            <div className="text-sm font-medium mb-1" style={{ color: currentTheme.textSecondary }}>Client</div>
                                            <div className="text-xl font-bold" style={{ color: currentTheme.textPrimary }}>{showMetrics.client || 'N/A'}</div>
                                        </div>
                                        <div className="p-4 rounded-lg" style={{ backgroundColor: currentTheme.hover }}>
                                            <div className="text-sm font-medium mb-1" style={{ color: currentTheme.textSecondary }}>Address</div>
                                            <div className="text-xl font-bold" style={{ color: currentTheme.textPrimary }}>{showMetrics.address || 'N/A'}</div>
                                        </div>
                                        <div className="p-4 rounded-lg" style={{ backgroundColor: currentTheme.hover }}>
                                            <div className="text-sm font-medium mb-1" style={{ color: currentTheme.textSecondary }}>Status</div>
                                            <div className="text-xl font-bold" style={{ color: getStatusColor(showMetrics.status) }}>{showMetrics.status}</div>
                                        </div>
                                        <div className="p-4 rounded-lg" style={{ backgroundColor: currentTheme.hover }}>
                                            <div className="text-sm font-medium mb-1" style={{ color: currentTheme.textSecondary }}>Priority</div>
                                            <div className="text-xl font-bold" style={{ color: getPriorityColor(showMetrics.priority) }}>{showMetrics.priority}</div>
                                        </div>
                                    </div>

                                    {/* Financial Metrics */}
                                    <div className="p-4 rounded-lg border-2" style={{ borderColor: currentTheme.border, backgroundColor: currentTheme.cardBg }}>
                                        <h3 className="text-lg font-bold mb-4 flex items-center gap-2" style={{ color: currentTheme.textPrimary }}>
                                            💰 Financial Breakdown
                                        </h3>
                                        
                                        <div className="grid grid-cols-3 gap-4">
                                            <div>
                                                <div className="text-sm font-medium mb-1" style={{ color: currentTheme.textSecondary }}>Total Price</div>
                                                <div className="text-2xl font-bold" style={{ color: currentTheme.success }}>
                                                    ${(() => {
                                                        const val = showMetrics.totalPrice;
                                                        if (!val && val !== 0) return '0.00';
                                                        const cleaned = String(val).replace(/[$,]/g, '');
                                                        const num = parseFloat(cleaned);
                                                        return isNaN(num) ? '0.00' : num.toFixed(2);
                                                    })()}
                                                </div>
                                            </div>
                                            <div>
                                                <div className="text-sm font-medium mb-1" style={{ color: currentTheme.textSecondary }}>Material Cost</div>
                                                <div className="text-2xl font-bold" style={{ color: currentTheme.warning }}>
                                                    ${(() => {
                                                        const val = showMetrics.materialCost;
                                                        if (!val && val !== 0) return '0.00';
                                                        const cleaned = String(val).replace(/[$,]/g, '');
                                                        const num = parseFloat(cleaned);
                                                        return isNaN(num) ? '0.00' : num.toFixed(2);
                                                    })()}
                                                </div>
                                            </div>
                                            <div>
                                                <div className="text-sm font-medium mb-1" style={{ color: currentTheme.textSecondary }}>Labor Profit</div>
                                                <div className="text-2xl font-bold" style={{ color: currentTheme.primary }}>
                                                    ${(() => {
                                                        const totalVal = showMetrics.totalPrice;
                                                        const materialVal = showMetrics.materialCost;
                                                        
                                                        const totalCleaned = String(totalVal || 0).replace(/[$,]/g, '');
                                                        const materialCleaned = String(materialVal || 0).replace(/[$,]/g, '');
                                                        
                                                        const total = parseFloat(totalCleaned) || 0;
                                                        const material = parseFloat(materialCleaned) || 0;
                                                        
                                                        return (total - material).toFixed(2);
                                                    })()}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Profit Margin */}
                                        <div className="mt-4 pt-4" style={{ borderTop: `1px solid ${currentTheme.border}` }}>
                                            <div className="flex justify-between items-center mb-2">
                                                <span className="text-sm font-medium" style={{ color: currentTheme.textSecondary }}>Profit Margin</span>
                                                <span className="text-lg font-bold" style={{ color: currentTheme.primary }}>
                                                    {(() => {
                                                        const totalCleaned = String(showMetrics.totalPrice || 0).replace(/[$,]/g, '');
                                                        const materialCleaned = String(showMetrics.materialCost || 0).replace(/[$,]/g, '');
                                                        const total = parseFloat(totalCleaned) || 0;
                                                        const material = parseFloat(materialCleaned) || 0;
                                                        return total > 0 ? (((total - material) / total) * 100).toFixed(1) : '0.0';
                                                    })()}%
                                                </span>
                                            </div>
                                            <div className="w-full bg-gray-200 rounded-full h-3">
                                                <div 
                                                    className="h-3 rounded-full transition-all duration-500"
                                                    style={{ 
                                                        width: `${(() => {
                                                            const totalCleaned = String(showMetrics.totalPrice || 0).replace(/[$,]/g, '');
                                                            const materialCleaned = String(showMetrics.materialCost || 0).replace(/[$,]/g, '');
                                                            const total = parseFloat(totalCleaned) || 0;
                                                            const material = parseFloat(materialCleaned) || 0;
                                                            return total > 0 ? ((total - material) / total) * 100 : 0;
                                                        })()}%`,
                                                        background: `linear-gradient(to right, ${currentTheme.primary}, ${currentTheme.secondary})`
                                                    }}
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    {/* Timeline */}
                                    <div className="p-4 rounded-lg border-2" style={{ borderColor: currentTheme.border, backgroundColor: currentTheme.cardBg }}>
                                        <h3 className="text-lg font-bold mb-4 flex items-center gap-2" style={{ color: currentTheme.textPrimary }}>
                                            📅 Timeline
                                        </h3>
                                        <div className="space-y-3">
                                            <div className="flex justify-between items-center">
                                                <span style={{ color: currentTheme.textSecondary }}>Request Date</span>
                                                <span className="font-bold" style={{ color: currentTheme.textPrimary }}>
                                                    {showMetrics.requestDate || 'Not set'}
                                                </span>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <span style={{ color: currentTheme.textSecondary }}>Completion Date</span>
                                                <span className="font-bold" style={{ color: currentTheme.textPrimary }}>
                                                    {showMetrics.completionDate || 'Not set'}
                                                </span>
                                            </div>
                                            {showMetrics.requestDate && showMetrics.completionDate && (
                                                <div className="flex justify-between items-center pt-2" style={{ borderTop: `1px solid ${currentTheme.border}` }}>
                                                    <span style={{ color: currentTheme.textSecondary }}>Duration</span>
                                                    <span className="font-bold" style={{ color: currentTheme.primary }}>
                                                        {Math.ceil((new Date(showMetrics.completionDate) - new Date(showMetrics.requestDate)) / (1000 * 60 * 60 * 24))} days
                                                    </span>
                                                </div>
                                            )}
                                            <div className="flex justify-between items-center pt-2" style={{ borderTop: `1px solid ${currentTheme.border}` }}>
                                                <span style={{ color: currentTheme.textSecondary }}>Work Hours</span>
                                                <span className="font-bold" style={{ color: currentTheme.primary }}>
                                                    {parseFloat(showMetrics.workHours) || 0} hours
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Notes */}
                                    {showMetrics.notes && (
                                        <div className="p-4 rounded-lg border-2" style={{ borderColor: currentTheme.border, backgroundColor: currentTheme.cardBg }}>
                                            <h3 className="text-lg font-bold mb-2 flex items-center gap-2" style={{ color: currentTheme.textPrimary }}>
                                                📝 Notes
                                            </h3>
                                            <p style={{ color: currentTheme.textSecondary }}>{showMetrics.notes}</p>
                                        </div>
                                    )}
                                </div>

                                <div className="flex justify-between items-center p-6 pt-0">
                                    <button
                                        onClick={() => {
                                            generateInvoice(showMetrics);
                                        }}
                                        className="px-8 py-4 text-white rounded-xl font-semibold transition-all duration-300 flex items-center gap-3 shadow-lg hover:shadow-xl hover:scale-105 transform"
                                        style={{
                                            background: `linear-gradient(135deg, ${currentTheme.primary} 0%, ${currentTheme.secondary} 100%)`
                                        }}
                                        onMouseEnter={(e) => {
                                            e.currentTarget.style.filter = 'brightness(1.1)';
                                        }}
                                        onMouseLeave={(e) => {
                                            e.currentTarget.style.filter = 'brightness(1)';
                                        }}
                                    >
                                        <FileText size={22} />
                                        Generate Invoice
                                    </button>
                                    <button
                                        onClick={() => setShowMetrics(null)}
                                        className="px-6 py-3 text-white rounded-xl font-medium transition-all duration-200 hover:scale-105 transform"
                                        style={{
                                            backgroundColor: currentTheme.textSecondary
                                        }}
                                        onMouseEnter={(e) => {
                                            e.currentTarget.style.filter = 'brightness(0.9)';
                                        }}
                                        onMouseLeave={(e) => {
                                            e.currentTarget.style.filter = 'brightness(1)';
                                        }}
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>